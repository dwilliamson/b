<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<meta name="fragment" content="!">
<title>Gazoo.cpp</title>
<link rel="stylesheet" href="Snapshot/Gazoo.cpp_files/Blog.css">
<link rel="stylesheet" href="Snapshot/Gazoo.cpp_files/Main.css">
</head>
	
<body id="background">
	
<div id="menu"><div><div style="opacity: 1;" class="post" id="PostMenu"><a href="javascript:blog_goto('')">Home</a> | <a href="javascript:blog_goto('About')">About</a> | <a href="javascript:blog_goto('PiB')">PiB</a> | <a href="javascript:blog_goto('TinyBlog')">Tiny Blog</a> | <a href="javascript:blog_goto('clReflect')">clReflect</a> <i> <a href="javascript:blog_goto('')"><span style="position:absolute;right:40px;color:#AA2222;font-weight:bold;">Gazoo.cpp - Don Williamson</span></a> </i></div></div></div>
<div id="content"><div><div style="opacity: 1;" class="post" id="Post20121217113822"><a href="javascript:blog_goto('2012-12-17-11-38-22')" class="title">Very Fast, High-Precision SIMD/GPU Gradient Noise</a><br><span class="date">Posted 17 December 2012 11:38:22</span><br><br>A recently published article by Inigo Quilez on <a href="http://www.iquilezles.org/www/articles/voronoilines/voronoilines.htm" target="new">Voronoi Edges</a>
 highlights the technique of shifting the co-ordinate frame of 
procedural algorithms to improve precision. This is a really important 
little trick that I felt was worth reviewing, as it provides huge 
benefits to world generation at a planetary scale. The GPGPU crowd have 
used similar techniques for a while, dubbed <a href="http://www.mpi-inf.mpg.de/%7Estrzodka/projects/double/" target="new">Mixed Precision Methods</a> and the first reference I can find to using relative values for "Infinite noise" is in Pixar's paper on <a href="http://graphics.pixar.com/library/WaveletNoise/paper.pdf" target="new">Wavelet Noise</a>.<br><br><h3> Perlin's Gradient Noise </h3><br>One
 of the simplest noise implementations involves taking "random" gradient
 vectors from points on a lattice nearest your sampling point and 
interpolating them. I say "random" because while the result effectively 
looks random, it's more a hashing process with no state:<br><br><div class="code"><br><span class="comment">// A series of primes for the hash function</span><br>const <span class="keyword">int</span> NOISE_HASH_X = 1213;<br><span class="keyword">const</span> <span class="keyword">int</span> NOISE_HASH_Y = 6203;<br><span class="keyword">const</span> <span class="keyword">int</span> NOISE_HASH_Z = 5237;<br><span class="keyword">const</span> <span class="keyword">int</span> NOISE_HASH_SEED = 1039;<br><span class="keyword">const</span> <span class="keyword">int</span> NOISE_HASH_SHIFT = 13;<br><br><span class="keyword">float</span> lerp(<span class="keyword">float</span> t, <span class="keyword">float</span> a, <span class="keyword">float</span> b)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> a + t * (b - a);<br>}<br><br><span class="keyword">float</span> quintic(<span class="keyword">float</span> t)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> t * t * t * (t * (t * 6.0f - 15.0f) + 10.0f);<br>}<br><br><span class="keyword">float</span> grad_project(<span class="keyword">float</span> dx, <span class="keyword">float</span> dy, <span class="keyword">float</span> dz, <span class="keyword">int</span> ix, <span class="keyword">int</span> iy, <span class="keyword">int</span> iz)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Hash the lattice indices to get a gradient vector index</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index = NOISE_HASH_X * ix + NOISE_HASH_Y * iy + NOISE_HASH_Z * iz + NOISE_HASH_SEED;<br>&nbsp;&nbsp;&nbsp;&nbsp;index ^= (index &gt;&gt; NOISE_HASH_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index &amp;= 0xFF;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Lookup the gradient vector</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> grad_x = g_RandomGradients[(index &lt;&lt; 2) + 0];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> grad_y = g_RandomGradients[(index &lt;&lt; 2) + 1];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> grad_z = g_RandomGradients[(index &lt;&lt; 2) + 2];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Project the local point onto the gradient vector</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> (grad_x * dx + grad_y * dy + grad_z * dz);<br>}<br><br><span class="keyword">float</span> grad_noise(<span class="keyword">float</span> x, <span class="keyword">float</span> y, <span class="keyword">float</span> z)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get the nearest lattice indices</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> x0 = (<span class="keyword">int</span>)floor(x);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> y0 = (<span class="keyword">int</span>)floor(y);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> z0 = (<span class="keyword">int</span>)floor(z);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> x1 = x0 + 1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> y1 = y0 + 1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> z1 = z0 + 1;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get local deltas to lattice positions</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> dx0 = x - x0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> dy0 = y - y0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> dz0 = z - z0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> dx1 = dx0 - 1.0f;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> dy1 = dy0 - 1.0f;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> dz1 = dz0 - 1.0f;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get gradient projection for each local lattice point</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> g0 = grad_project(dx0, dy0, dz0, x0, y0, z0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> g1 = grad_project(dx1, dy0, dz0, x1, y0, z0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> g2 = grad_project(dx0, dy1, dz0, x0, y1, z0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> g3 = grad_project(dx1, dy1, dz0, x1, y1, z0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> g4 = grad_project(dx0, dy0, dz1, x0, y0, z1);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> g5 = grad_project(dx1, dy0, dz1, x1, y0, z1);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> g6 = grad_project(dx0, dy1, dz1, x0, y1, z1);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> g7 = grad_project(dx1, dy1, dz1, x1, y1, z1);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Remap linear interpolation to a quintic (see Perlin's Improved Noise paper)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> rx = quintic(dx0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> ry = quintic(dy0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> rz = quintic(dz0);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Trilinear interpolation</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> gx0 = lerp(rx, g0, g1);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> gx1 = lerp(rx, g2, g3);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> gx2 = lerp(rx, g4, g5);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> gx3 = lerp(rx, g6, g7);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> gy0 = lerp(ry, gx0, gx1);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> gy1 = lerp(ry, gx2, gx3);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> lerp(rz, gy0, gy1);<br>}<br></div><br><i>g_Gradients</i>
 is a table of randomly generated unit vectors. While my table size is 
256, Perlin notes that the number of gradient vectors isn't really that 
important - just that they're <a href="http://http.developer.nvidia.com/GPUGems/gpugems_ch05.html" target="new">evenly distributed</a>. He suggests a relaxation step to achieve Poisson distribution, which I might try, but for now I'm just using a <a href="https://bitbucket.org/dwilliamson/shrotation/src/tip/Source/NRook.cpp" target="new">stratified sampling of the sphere</a>.<br><br>In the majority of cases this all works well. There are many variants, each tailored to different use-cases, for example:<ul><li>
 If you are doing very small-scale noisy details you might be able to 
get away with one gradient vector look-up, using the GPU's volume 
texture sampling to do the <a href="http://prettyprocs.wordpress.com/2012/10/20/fast-perlin-noise/" target="new">interpolation and index wrapping for you</a>.
 This isn't a great technique for variance, however it's useful for the 
small details when you have lower frequencies available to hide the 
repetition.</li><li> When table/texture lookups are not possible or too slow and when branching is expensive, you can switch to Ashima Arts' <a href="https://github.com/ashima/webgl-noise" target="new">Simplex Noise</a> variant. Or you can use Simplex Noise as popularised by Perlin and brilliantly documented by <a href="http://staffwww.itn.liu.se/%7Estegu/simplexnoise/" target="new">Stefan Gustavson</a>.</li></ul>I've
 not found Simplex noise to give any real gains in terms of visuals and 
performance. Either the branches become a problem or the increased ALU 
to avoid branches steps in. As I want 100x gains here, not minor 
"potential" gains, it's not been worth the complexity increase for me.<br><br><h3> Single Precision Motivation </h3><br>When
 you start applying the noise functions on a large scale, 
single-precision noise breaks down entirely. The easiest way to fix this
 is by changing all float values in the above source to double. 
Depending on your use case, this can be a quite sensible solution and 
it's very easy to find noise examples out there where people brush over 
the problem entirely and switch to doubles.<br><br>On modern PCs (last 5
 years or so), the equivalent of the x87 co-processor has been doing 
floating point arithmetic at 64-bit precision. When you write floating 
point code on PC, you should be using doubles, as the overhead of 
marshalling back and forth between float/double precision can make your 
code slower.<br><br>It's what I did, but eventually I wanted bigger and 
faster. Not just three or four times faster: one hundred times faster! 
For that you need to start exploiting AVX/SSE or your GPU, but double 
life in these lands is not as rosy. I have a few numbers that can 
demonstrate this:<ul><li> <b>25,596,000</b> : C Gradient Noise double</li><li> <b>29,987,000</b> : C Gradient Noise float</li><li> <b>13,709,000</b> : SSE Gradient Noise double</li><li> <b>11,613,000</b> : SSE Gradient Noise float</li></ul>Timings
 are in nano-seconds. The first two results quite evidently demonstrate 
the benefit of working in double space to begin with. The last two 
results show how useful switching to SSE techniques can be but also show
 that doubles (implemented using recent AVX instructions) don't perform 
as well. However, when you compare these with GPU numbers, it becomes 
evident how fast we can really make things:<ul><li> <b>875,072</b> : OpenCL Gradient Noise double</li><li> <b>126,016</b> : OpenCL Gradient Noise float</li></ul>The
 double version is around 30 times faster than the original 
implementation, however the real fruit from the tree is the float 
version at roughly 200 times faster! If we can find a way to make the 
float version work on a large scale, this could be very good. Of course,
 the economics of GPU use doesn't really net you those gains: the GPU 
version needs to be that fast because there are potentially several free
 CPU cores hanging around that could do the work in 10ms, 3 times a 
frame. The GPU version doesn't have that flexibility as it needs a good 
30ms to render a frame.<br><br>Branchless Simplex noise is worth a quick mention here:<ul><li> <b>3,238,144</b> : OpenCL Simplex Noise double</li><li> <b>283,072</b> : OpenCL Simplex Noise float&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   </li></ul>This
 demonstrates a couple of things: the lack of real double performance on
 GPUs and the greatly increased ALU under-performing table lookups vs. 
the gradient version.<br><br><h3> Making Single Precision Scale </h3><br>The above noise function is already in a format ready for improvement. The first step is to accept doubles as parameters:<br><br><div class="code"><br><span class="keyword">float</span> grad_noise(<span class="keyword">double</span> x, <span class="keyword">double</span> y, <span class="keyword">double</span> z)<br></div><br>This
 is the source position that gets scaled based on what octave it comes 
from. There are cases, for extremely low frequency noise, where you can 
get away with floats. In my planet generator (earth sized planet), my 
first couple of octaves are entirely float-based.<br><br>This also means the conversion to integer needs to be done in double-precision:<br><br><div class="code"><br>    <span class="comment">// Get the nearest lattice indices</span><br>    <span class="keyword">int</span> x0 = (<span class="keyword">int</span>)floor(x);<br>    <span class="keyword">int</span> y0 = (<span class="keyword">int</span>)floor(y);<br>    <span class="keyword">int</span> z0 = (<span class="keyword">int</span>)floor(z);<br></div><br>Assuming
 you have a planet that is earth-sized, most detail will be generated at
 a distance of ~6,000,000 metres from the origin. Up here, the 
resolution of a float goes rapidly <a href="http://www.altdevblogaday.com/2012/02/05/dont-store-that-in-a-float/" target="new">from 0.0625 metres to 1 metre</a>.
 While the rounding won't show its effect until you get above 10,000km, 
there's really no point in trying to marshal the position into a float 
and I'd rather not have to worry about changing the function for larger 
planet radii.<br><br>This resolution becomes extremely important in the next bit of code:<br><br><div class="code"><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get local deltas to lattice positions</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> dx0 = x - x0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> dy0 = y - y0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> dz0 = z - z0;<br></div><br>If
 this delta is calculated with floats at this height, you will get 
multiples of 0.0625 or higher. This produces stair-stepping artifacts 
every few centimetres and a complete loss of detail that looks quite 
horrendous. However, if you calculate the delta using doubles and 
convert the 0-1 value to float, it's all fine:<br><br><div class="code"><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get local deltas to lattice positions</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> dx0 = <span class="keyword">float</span>(x - x0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> dy0 = <span class="keyword">float</span>(y - y0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> dz0 = <span class="keyword">float</span>(z - z0);<br></div><br>The
 rest of the code does not need to touch a double value, ever; the 
distance to the far lattice indices has already been adjusted so that 
it's not in terms of the incoming position.<br><br><h3> A SIMD Implementation </h3><br>There are two ways to write a complete double SIMD implementation. The first is to use the <a href="http://softpixel.com/%7Ecwright/programming/simd/sse2.php" target="new">SSE2</a>
 instructions, storing 3xdouble values in two 128-bit registers. This is
 quite painful and the resulting code has significantly less through-put
 than its float equivalent. I didn't get a chance to correctly profile 
my implementation but initial investigations proved there was little 
benefit, especially for the large increase in complexity.<br><br>The second way is to use the more recent <a href="http://software.intel.com/en-us/avx" target="new">AVX instructions</a>. These have a new, extended 256-bit register set, representing a step forward for Intel that's not without its problems:<ul><li>
 Mixing 128-bit SSE and 256-bit AVX code is very easy to do and can 
cause significant performance penalties. The problem and some solutions 
are discussed in <a href="http://software.intel.com/en-us/articles/avoiding-avx-sse-transition-penalties" target="new">Avoiding AVX-SSE Transition Penalties</a> and <a href="http://software.intel.com/en-us/articles/intel-avx-state-transitions-migrating-sse-code-to-avx" target="new">Intel AVX State Transitions: Migrating SSE Code to AVX</a>.
 I used C intrinsics to write SIMD code so I was having to parse the 
generated assembler from MSVC on each run to double-check me or the 
compiler weren't making mistakes. Intel's solution of running your code 
through an emulator to check sounds just a little too much.</li><li> There is an horrendous Windows 7 WoW64 bug better explained in the post <a href="http://www.os2museum.com/wp/?p=960" target="new">AVX support disrupts WoW64 debugging</a>.
 The short version is that, for 32-bit programs, AVX state is 
incorrectly managed during stack walks leading to incorrect call stacks 
whenever you attach a debugger to a crashed application. A fix is to 
either run with the debugger attached at all times and have <a href="http://www.altdevblogaday.com/2012/07/06/when-even-crashing-doesnt-work/" target="new">Win32 Exceptions Enabled</a> or to disable AVX support in Windows 7 altogether! Not exactly great choices, there.</li><li>
 32-bit programs have access to only half the registers the equivalent 
64-bit programs do. While not really that important for the future, it's
 a pain when you're trying a slow migration to 64-bit.</li><li> AVX is recent enough that you may still need to write an SSE implementation to make up for lack of support on older machines.</li></ul>Given
 that we now have a way of using doubles in only a small portion of the 
code, there's pretty much no reason to need an AVX version. Which is 
good!<br><br>Here's an SSE version:<br><br><div class="code"><br><span class="keyword">namespace</span> simd<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">typedef</span> __m128i v128i;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">typedef</span> __m128d v128d;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">typedef</span> __m128 v128f;<br>}<br><br>simd::v128f __fastcall grad_noise_simd(simd::v128d pos_xy, simd::v128d pos_z)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">using</span> <span class="keyword">namespace</span> simd;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Round to the lowest integer boundary</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// DOUBLE PRECISION</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128d pos_xy_0 = _mm_floor_pd(pos_xy);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128d pos_z_0 = _mm_floor_pd(pos_z);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Convert to integer to get the lower cube corner</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128i xyi = _mm_cvtpd_epi32(pos_xy_0);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128i zi = _mm_cvtpd_epi32(pos_z_0);<br>&nbsp;&nbsp;&nbsp;&nbsp;zi = shuffle_epi32&lt;Az, Aw, Ax, Ay&gt;(zi);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128i cube_pos0 = _mm_add_epi32(xyi, zi);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Add one to get the upper cube corner</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128i cube_pos1 = _mm_add_epi32(cube_pos0, iONE);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get fractional to lower cube corner</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// DOUBLE PRECISION</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128d t_xy_d = _mm_sub_pd(pos_xy, pos_xy_0);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128d t_z_d = _mm_sub_pd(pos_z, pos_z_0);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Convert to higher-throughput float</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t_xy_f = _mm_cvtpd_ps(t_xy_d);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t_zw_f = _mm_cvtpd_ps(t_z_d);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t0 = shuffle_ps&lt;Ax, Ay, Bx, By&gt;(t_xy_f, t_zw_f);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get fractional to upper cube corner</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t1 = _mm_sub_ps(t0, fONE);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> x0 = cube_pos0.m128i_i32[0];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> y0 = cube_pos0.m128i_i32[1];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> z0 = cube_pos0.m128i_i32[2];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> x1 = cube_pos1.m128i_i32[0];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> y1 = cube_pos1.m128i_i32[1];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> z1 = cube_pos1.m128i_i32[2];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Partial hash of extreme cube corner indices</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> ox0 = NOISE_X * x0 + NOISE_SEED;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> oy0 = NOISE_Y * y0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> oz0 = NOISE_Z * z0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> ox1 = NOISE_X * x1 + NOISE_SEED;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> oy1 = NOISE_Y * y1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> oz1 = NOISE_Z * z1;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Hash all cube corners</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index0 = ox0 + oy0 + oz0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index1 = ox1 + oy0 + oz0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index2 = ox0 + oy1 + oz0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index3 = ox1 + oy1 + oz0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index4 = ox0 + oy0 + oz1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index5 = ox1 + oy0 + oz1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index6 = ox0 + oy1 + oz1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index7 = ox1 + oy1 + oz1;<br>&nbsp;&nbsp;&nbsp;&nbsp;index0 ^= (index0 &gt;&gt; NOISE_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index1 ^= (index1 &gt;&gt; NOISE_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index2 ^= (index2 &gt;&gt; NOISE_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index3 ^= (index3 &gt;&gt; NOISE_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index4 ^= (index4 &gt;&gt; NOISE_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index5 ^= (index5 &gt;&gt; NOISE_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index6 ^= (index6 &gt;&gt; NOISE_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index7 ^= (index7 &gt;&gt; NOISE_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index0 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index1 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index2 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index3 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index4 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index5 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index6 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index7 &amp;= 0xFF;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Lookup gradients</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad0 = g_RandomGradients_v128f[index0];<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad1 = g_RandomGradients_v128f[index1];<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad2 = g_RandomGradients_v128f[index2];<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad3 = g_RandomGradients_v128f[index3];<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad4 = g_RandomGradients_v128f[index4];<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad5 = g_RandomGradients_v128f[index5];<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad6 = g_RandomGradients_v128f[index6];<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad7 = g_RandomGradients_v128f[index7];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Project permuted offsets onto gradient vector</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g0_ = _mm_dp_ps(grad0, blend_ps&lt;Ax, Ay, Az&gt;(t0, t1), 0x7F);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g1_ = _mm_dp_ps(grad1, blend_ps&lt;Bx, Ay, Az&gt;(t0, t1), 0x7F);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g2_ = _mm_dp_ps(grad2, blend_ps&lt;Ax, By, Az&gt;(t0, t1), 0x7F);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g3_ = _mm_dp_ps(grad3, blend_ps&lt;Bx, By, Az&gt;(t0, t1), 0x7F);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g4_ = _mm_dp_ps(grad4, blend_ps&lt;Ax, Ay, Bz&gt;(t0, t1), 0x7F);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g5_ = _mm_dp_ps(grad5, blend_ps&lt;Bx, Ay, Bz&gt;(t0, t1), 0x7F);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g6_ = _mm_dp_ps(grad6, blend_ps&lt;Ax, By, Bz&gt;(t0, t1), 0x7F);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g7_ = _mm_dp_ps(grad7, blend_ps&lt;Bx, By, Bz&gt;(t0, t1), 0x7F);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// mix g0, g2, g4, g6 for lerp</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g02__ = blend_ps&lt;Ax, By, Az, Aw&gt;(g0_, g2_);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g__46 = blend_ps&lt;Ax, Ay, Az, Bw&gt;(g4_, g6_);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g0246 = blend_ps&lt;Ax, Ay, Bz, Bw&gt;(g02__, g__46);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// mix g1, g3, g5, g7 for lerp</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g13__ = blend_ps&lt;Ax, By, Az, Aw&gt;(g1_, g3_);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g__57 = blend_ps&lt;Ax, Ay, Az, Bw&gt;(g5_, g7_);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g1357 = blend_ps&lt;Ax, Ay, Bz, Bw&gt;(g13__, g__57);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Apply a cubic fade to the near distance parameter for trilinear interpolation</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f r = _mm_mul_ps(t0, t0);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f r0 = _mm_mul_ps(fTWO, t0);<br>&nbsp;&nbsp;&nbsp;&nbsp;r0 = _mm_sub_ps(fTHREE, r0);<br>&nbsp;&nbsp;&nbsp;&nbsp;r = _mm_mul_ps(r, r0);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Trilinear interpolation </span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f rx = shuffle_ps&lt;Ax, Ax, Bx, Bx&gt;(r, r);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f gx0123 = simd::lerp(rx, g0246, g1357);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f ry = shuffle_ps&lt;Ay, Ay, By, By&gt;(r, r);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f gx1032 = shuffle_ps&lt;Ay, Ax, Bw, Bz&gt;(gx0123, gx0123);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f gy0_1_ = simd::lerp(ry, gx0123, gx1032);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f rz = shuffle_ps&lt;Az, Az, Bz, Bz&gt;(r, r);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f gy1_0_ = shuffle_ps&lt;Az, Az, Bx, Bx&gt;(gy0_1_, gy0_1_);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f gz = simd::lerp(rz, gy0_1_, gy1_0_);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> gz;<br>}<br></div><br>There
 is a bunch of stuff you could do to get a couple milliseconds out of 
this but it's already over twice as fast as the C version, so it's a 
good enough SIMD version for now. The compiler will effectively pipeline
 the int operations with the SSE operations for you and on modern 
processors the dot product is actually quite fast. You could tranpose 
the inner loop for older processors to remove the dot product:<br><br><div class="code"><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Transpose first 4 gradients within XMM registers</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f temp0 = _mm_unpacklo_ps(grad0, grad2);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f temp1 = _mm_unpacklo_ps(grad4, grad6);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f temp2 = _mm_unpackhi_ps(grad0, grad2);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f temp3 = _mm_unpackhi_ps(grad4, grad6);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad0246x = _mm_movelh_ps(temp0, temp1);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad0246y = _mm_movehl_ps(temp1, temp0);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad0246z = _mm_movelh_ps(temp2, temp3);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Transpose second 4 gradients within XMM registers</span><br>&nbsp;&nbsp;&nbsp;&nbsp;temp0 = _mm_unpacklo_ps(grad1, grad3);<br>&nbsp;&nbsp;&nbsp;&nbsp;temp1 = _mm_unpacklo_ps(grad5, grad7);<br>&nbsp;&nbsp;&nbsp;&nbsp;temp2 = _mm_unpackhi_ps(grad1, grad3);<br>&nbsp;&nbsp;&nbsp;&nbsp;temp3 = _mm_unpackhi_ps(grad5, grad7);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad1357x = _mm_movelh_ps(temp0, temp1);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad1357y = _mm_movehl_ps(temp1, temp0);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f grad1357z = _mm_movelh_ps(temp2, temp3);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Tranpose needed permutations</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t0000x = shuffle_ps&lt;Ax, Ax, Bx, Bx&gt;(t0, t0);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t0000y = shuffle_ps&lt;Ay, Ay, By, By&gt;(t0, t0);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t0000z = shuffle_ps&lt;Az, Az, Bz, Bz&gt;(t0, t0);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t1111x = shuffle_ps&lt;Ax, Ax, Bx, Bx&gt;(t1, t1);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t1111y = shuffle_ps&lt;Ay, Ay, By, By&gt;(t1, t1);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t1111z = shuffle_ps&lt;Az, Az, Bz, Bz&gt;(t1, t1);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t0101y = blend_ps&lt;Ax, By, Az, Bw&gt;(t0000y, t1111y);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f t0011z = blend_ps&lt;Ax, Ay, Bz, Bw&gt;(t0000z, t1111z);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Calculate 8 dot products</span><br>&nbsp;&nbsp;&nbsp;&nbsp;v128f mulx = _mm_mul_ps(t0000x, grad0246x);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f muly = _mm_mul_ps(t0101y, grad0246y);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f mulz = _mm_mul_ps(t0011z, grad0246z);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g0246 = _mm_add_ps(mulx, _mm_add_ps(muly, mulz));<br>&nbsp;&nbsp;&nbsp;&nbsp;mulx = _mm_mul_ps(t1111x, grad1357x);<br>&nbsp;&nbsp;&nbsp;&nbsp;muly = _mm_mul_ps(t0101y, grad1357y);<br>&nbsp;&nbsp;&nbsp;&nbsp;mulz = _mm_mul_ps(t0011z, grad1357z);<br>&nbsp;&nbsp;&nbsp;&nbsp;v128f g1357 = _mm_add_ps(mulx, _mm_add_ps(muly, mulz));<br></div><br>However,
 the shuffle overhead makes this slower on modern processors so it's 
only really a gain if your input data is already rotated.<br><br>The 
SIMD approach is valuable. If you have enough free cores, there's 
nothing stopping you using it at the same time as a GPU implementation. 
However, better gains in terms of productivity are more likely if you 
use something like the <a href="http://ispc.github.com/" target="new">Intel SPMD Program Compiler</a>.
 You can also do something like use OpenCL on the CPU but the 
availability of CPU drivers on the PC may make this a little 
problematic.<br><br><h3> An OpenCL Implementation </h3><br>Knowing the float/double trick above, an OpenCL implementation is more straight-forward, <i>provided you have your program setup for loading/running OpenCL kernels</i>.
 The same approach maps to CUDA or whatever favourite compute setup you 
have and you can even change and reload your noise functions on the fly 
(seeing the surface of a planet update in real-time as you edit its 
noise functions is quite funky):<br><br><div class="code"><br><span class="keyword">float</span> gradient_noise_inner(__global <span class="keyword">const</span> <span class="keyword">float</span>3* gradient_table, <span class="keyword">float</span>3 cube_pos0, <span class="keyword">float</span>3 cube_pos1, <span class="keyword">float</span>3 t0, <span class="keyword">float</span>3 t1)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> x0 = cube_pos0.x;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> y0 = cube_pos0.y;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> z0 = cube_pos0.z;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> x1 = cube_pos1.x;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> y1 = cube_pos1.y;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> z1 = cube_pos1.z;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> <span class="keyword">int</span> NOISE_HASH_X = 1213;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> <span class="keyword">int</span> NOISE_HASH_Y = 6203;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> <span class="keyword">int</span> NOISE_HASH_Z = 5237;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> <span class="keyword">int</span> NOISE_HASH_SEED = 1039;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> ox0 = NOISE_HASH_X * x0 + NOISE_HASH_SEED;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> oy0 = NOISE_HASH_Y * y0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> oz0 = NOISE_HASH_Z * z0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> ox1 = NOISE_HASH_X * x1 + NOISE_HASH_SEED;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> oy1 = NOISE_HASH_Y * y1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> oz1 = NOISE_HASH_Z * z1;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> <span class="keyword">int</span> NOISE_HASH_SHIFT = 13;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index0 = ox0 + oy0 + oz0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index1 = ox1 + oy0 + oz0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index2 = ox0 + oy1 + oz0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index3 = ox1 + oy1 + oz0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index4 = ox0 + oy0 + oz1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index5 = ox1 + oy0 + oz1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index6 = ox0 + oy1 + oz1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> index7 = ox1 + oy1 + oz1;<br>&nbsp;&nbsp;&nbsp;&nbsp;index0 ^= (index0 &gt;&gt; NOISE_HASH_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index1 ^= (index1 &gt;&gt; NOISE_HASH_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index2 ^= (index2 &gt;&gt; NOISE_HASH_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index3 ^= (index3 &gt;&gt; NOISE_HASH_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index4 ^= (index4 &gt;&gt; NOISE_HASH_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index5 ^= (index5 &gt;&gt; NOISE_HASH_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index6 ^= (index6 &gt;&gt; NOISE_HASH_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index7 ^= (index7 &gt;&gt; NOISE_HASH_SHIFT);<br>&nbsp;&nbsp;&nbsp;&nbsp;index0 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index1 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index2 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index3 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index4 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index5 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index6 &amp;= 0xFF;<br>&nbsp;&nbsp;&nbsp;&nbsp;index7 &amp;= 0xFF;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 grad0 = gradient_table[index0];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 grad1 = gradient_table[index1];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 grad2 = gradient_table[index2];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 grad3 = gradient_table[index3];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 grad4 = gradient_table[index4];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 grad5 = gradient_table[index5];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 grad6 = gradient_table[index6];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 grad7 = gradient_table[index7];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Project permuted fractionals onto gradient vector</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>4 g0246, g1357;<br>&nbsp;&nbsp;&nbsp;&nbsp;g0246.x = dot(grad0, select(t0, t1, (<span class="keyword">int</span>3){ 0, 0, 0}));<br>&nbsp;&nbsp;&nbsp;&nbsp;g1357.x = dot(grad1, select(t0, t1, (<span class="keyword">int</span>3){-1, 0, 0}));<br>&nbsp;&nbsp;&nbsp;&nbsp;g0246.y = dot(grad2, select(t0, t1, (<span class="keyword">int</span>3){ 0,-1, 0}));<br>&nbsp;&nbsp;&nbsp;&nbsp;g1357.y = dot(grad3, select(t0, t1, (<span class="keyword">int</span>3){-1,-1, 0}));<br>&nbsp;&nbsp;&nbsp;&nbsp;g0246.z = dot(grad4, select(t0, t1, (<span class="keyword">int</span>3){ 0, 0,-1}));<br>&nbsp;&nbsp;&nbsp;&nbsp;g1357.z = dot(grad5, select(t0, t1, (<span class="keyword">int</span>3){-1, 0,-1}));<br>&nbsp;&nbsp;&nbsp;&nbsp;g0246.w = dot(grad6, select(t0, t1, (<span class="keyword">int</span>3){ 0,-1,-1}));<br>&nbsp;&nbsp;&nbsp;&nbsp;g1357.w = dot(grad7, select(t0, t1, (<span class="keyword">int</span>3){-1,-1,-1}));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 r = quintic(t0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>4 gx0123 = lerp4(r.x, g0246, g1357);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2 gy01 = lerp2(r.y, gx0123.xz, gx0123.yw);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> gz = lerp1(r.z, gy01.x, gy01.y);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> gz;<br>}<br><br><br><span class="keyword">float</span> gradient_noise_d(__global <span class="keyword">const</span> <span class="keyword">float</span>3* gradient_table, <span class="keyword">double</span>3 p)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Round to lowest integer boundary</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span>3 pos0 = floor(p);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Convert to integer and get cube corners</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 cube_pos0 = convert_float3(pos0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 cube_pos1 = cube_pos0 + 1;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get fractional to the lower corner and convert to float</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 t0 = convert_float3(p - pos0);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get fractional to upper cube corner</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 t1 = t0 - 1;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> gradient_noise_inner(gradient_table, cube_pos0, cube_pos1, t0, t1);<br>}<br></div><br>There is a crazy amount of work you can do to make this even faster, a couple of examples are:<ul><li>
 The integer hashing is quite slow. Vectorising it is pointless but 
doing some form of float hash can give significant speed gains (with 
potential vendor differences).</li><li> The lookup table can be condensed and maybe moved into constant memory.</li></ul>It's
 already pretty fast but the most important additions I'd suggest are to
 use multiple noise functions: experiment with value noise, reduce the 
problem from 3D to 2D, anything. Getting great performance requires 
domain-specific knowledge of the patterns you're trying to emulate and 
an appreciation for how much you can cheat.<br><br><h3> Memorising _MM_SHUFFLE parameters </h3><br>The SSE code above contains a few calls to some cute little templates that replace use of the <i>_MM_SHUFFLE</i>
 macro. It's a particularly nasty macro to remember, especially when 
multiple calls use it differently. Here's the templates that help make 
life a little easier:<br><br><div class="code"><br><span class="keyword">namespace</span> simd<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">enum</span> VectorSelect<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ax = 0, Ay = 1, Az = 2, Aw = 3,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Bx = 8, By = 9, Bz = 10, Bw = 11,<br>&nbsp;&nbsp;&nbsp;&nbsp;};<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">template</span> &lt;VectorSelect S0, VectorSelect S1, VectorSelect S2, VectorSelect S3&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">inline</span> v128f shuffle_ps(v128f x, v128f y)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S0 &gt;= Ax &amp;&amp; S0 &lt;= Aw);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S1 &gt;= Ax &amp;&amp; S1 &lt;= Aw);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S2 &gt;= Bx &amp;&amp; S2 &lt;= Bw);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S3 &gt;= Bx &amp;&amp; S3 &lt;= Bw);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> _mm_shuffle_ps(x, y, S0 + S1 * 4 + (S2 - Bx) * 16 + (S3 - Bx) * 64);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">template</span>&lt;VectorSelect S0, VectorSelect S1, VectorSelect S2, VectorSelect S3&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">inline</span> v128f blend_ps(v128f x, v128f y)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S0 == Ax || S0 == Bx);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S1 == Ay || S1 == By);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S2 == Az || S2 == Bz);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S3 == Aw || S3 == Bw);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> _mm_blend_ps(x, y, (S0 / Bx) *  1 + (S1 / By) *  2 + (S2 / Bz) *  4 + (S3 / Bw) *  8);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">template</span>&lt;VectorSelect S0, VectorSelect S1, VectorSelect S2&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">inline</span> v128f blend_ps(v128f x, v128f y)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S0 == Ax || S0 == Bx);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S1 == Ay || S1 == By);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S2 == Az || S2 == Bz);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> _mm_blend_ps(x, y, (S0 / Bx) *  1 + (S1 / By) *  2 + (S2 / Bz) *  4);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">template</span> &lt;VectorSelect S0, VectorSelect S1, VectorSelect S2, VectorSelect S3&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">inline</span> v128i shuffle_epi32(v128i x)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S0 &gt;= Ax &amp;&amp; S0 &lt;= Aw);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S1 &gt;= Ax &amp;&amp; S1 &lt;= Aw);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S2 &gt;= Ax &amp;&amp; S2 &lt;= Aw);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATIC_ASSERT(S3 &gt;= Ax &amp;&amp; S3 &lt;= Aw);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> _mm_shuffle_epi32(x, S0 + S1 * 4 + S2 * 16 + S3 * 64);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">inline</span> v128f lerp(v128f t, v128f a, v128f b)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v128f r = _mm_sub_ps(b, a);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r = _mm_mul_ps(r, t);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r = _mm_add_ps(r, a);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> r;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br>The
 static assert should nicely catch any errors you make at compile-time, 
as well as providing implicit documentation on the valid range of 
inputs.<br><br><a href="http://localhost/b/?d=2012-12-17-11-38-22#disqus_thread" data-disqus-identifier="2012-12-17-11-38-22">0 Comments</a><br><br></div></div><div><div style="opacity: 1;" class="post" id="Post20121212192054"><a href="javascript:blog_goto('2012-12-12-19-20-54')" class="title">Star: Planets, Smooth Voxels and Runtime C++ Reloading</a><br><span class="date">Posted 12 December 2012 19:20:54</span><br><br>In
 a previous post I hinted at my next decision: is the game set on an 
island? I think from the title of this post, you can guess that it isn't
 :)<br><br><h4> Let's Render Planets! </h4><br>The noise generation, 
voxelisation and final polygon creation work on a separate worker thread
 that I let Windows assign off to any free cores you might have. As I 
can use any distance generation function I please, I figured I'd try out
 generating a planetary sphere, modified by noise:<br><br><center><a href="" class="image"><img src=""></a></center><br>This
 is a planet of roughly 256 kilometres in radius, with a procedurally 
generated voxel surface. From this vantage point, the gaps between 
various levels of detail are clearly visible. The voxels aren't cached -
 discarded after the polygons are generated - but they are compressed to
 16-bit fixed-point so that the marching cubes algorithm can be exactly 
sure when a vertex must be placed on a voxel corner. It also made the 
inner-loop of polygon generation much faster.<br><br>The blue/green/white colours are generated based on y-value only, matching the old heightfield renderer.<br><br>As
 I wanted to generate an awful lot of polygons, I added a slice history 
buffer to the marching cubes generation. This would keep track of the 
indices of vertices generated in a previous slice so that they could be 
reused whenever possible. This reduced the vertex memory required to 40%
 of the original. I also added generation of normals to get a smoother 
render:<br><br><center><a href="" class="image"><img src=""></a></center><br>Normals
 were now generated directly from the distance field and I'd optimised 
the polygon generation enough that the normalisation of these normals 
became the bottleneck.<br><br><h4> Runtime Code Reloading </h4><br>One of the debugging features I added in this cycle was runtime code reloading. As the entire game was backed by <a href="https://bitbucket.org/dwilliamson/clreflect" target="new">clReflect</a>, I could walk the pointer graph for every live object in the game. These steps would occur:<ul><li> After compiling the C++ code, the Python build script would copy the generated files to the server.</li><li> The build script would generate a manifest file that contained an MD5 of all the server content.</li><li>
 The Java applet would periodically download the manifest file, looking 
for changes. If the MD5 differed, it would download any of the changes.</li><li> The Java applet would instruct the changed executable or DLL (module) to shutdown, persisting its state to memory.</li><li> Any modules which referenced objects in the reloading module would backup their pointers/references.</li><li> The applet would reload the new executable or DLL (module).</li><li> Upon launch, the module would reload its prior state and any dependent modules would update their pointers to the new objects.</li></ul>I
 put a lot of effort into build times so typical turn-around was under 1
 second. clReflect serialisation would seamlessly handle any changed 
data formats so I could sit in the game and change code and data types 
at will, for as long as I wanted. I'm hoping to do a much bigger article
 about this process at a later date when I can guarantee my solution is 
scalable. For now, checkout my <a href="http://www.altdevblogaday.com/2012/01/03/reflection-in-c-part-2-the-simple-implementation-of-splinter-cell/" target="new">Splinter Cell Reflection</a> article for a similar system I wrote back in 2006.<br><br><h4> Am I crazy? </h4><br>At
 this point, I'd deconstructed the entire game. There was no physics, 
collision or character locomotion - that was all based on the 
heightfield code I wrote a few months earlier. I set out on a huge 
gamble that I am to this day fighting with. These differences from the 
normal flow of game development have cost me some serious stress, time 
and complexity:<ul><li> Everything has to be instantaneously renderable from multiple cameras at the same time.</li><li> Any motion has to be replayable, with any point in time accessible instantly.</li><li> The surface is a completely arbitrary distance field, </li><li> Rendering can occur from any point on the surface of the planet or way above it.</li></ul>Sleep
 was scarce around this time period, purely because of worry. I would 
regularly wake up suddenly at 4am in the morning with my brain chewing 
over all the problems I was anticipating. If I'd left this as an island,
 I would be much further along by now... but, damn. I figure, I'm not 
going to be capable of this kind of work forever, so I might as well 
work on the types of things I've always dreamed of working on. Imagine 
being able to create your own space opera!<br><br><a href="http://localhost/b/?d=2012-12-12-19-20-54#disqus_thread" data-disqus-identifier="2012-12-12-19-20-54">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20121206103403"><a href="javascript:blog_goto('2012-12-06-10-34-03')" class="title">Star: Distance Fields to Voxels to Polygons</a><br><span class="date">Posted 06 December 2012 10:34:03</span><br><br>At
 this point things were looking pretty good: I setup a few car chases 
and did some bullet-proofing of clip composition for movies. The next 
stage was to figure out how the world would look and stream/generate as 
you moved around it.<br><br>As mentioned in an earlier post, I was going
 for a heightfield-based island, but something about that approach 
nagged me. It's very easy to make a heightfield renderer; so much so 
that everybody's done one and it's very hard to make them look unique. I
 also understood that you can spend years on making a heightfield 
renderer optimal for your target platform and modification pipeline, and
 that going for anything more complicated was bound to squeeze my 
schedule in some way.<br><br>One of my most memorable games is <a href="http://www.youtube.com/watch?v=D9zrG5DD9hw" target="new">Drakan</a>,
 a game that managed to capture caves, overhangs and other natural 
landscapes through instancing of heightfields (caves would just be 
inverted heightfields). It was pretty effective and something that we 
ended up trying on Fable 3. <br><br>However, I needed something that 
would stand out even more, and went ahead with a decision that would 
cause me lots of sleepless nights.<br><br><h4> Procedural Distance Fields </h4><br>It was this <a href="http://http.developer.nvidia.com/GPUGems3/gpugems3_ch01.html" target="new">GPU Gems 3 article</a> that convinced me to go for isosurfaces, so I coded this up:<br><br><center><a href="" class="image"><img src=""></a></center><br>Using
 a 3D noise function, a signed distance field is generated that is 
sampled to voxels. The voxels are then converted to polygons using the 
classic Marching Cubes algorithm. I could throw any crazy function I 
wanted to at this and it would work seamlessly - I was sold!<br><br>Of 
course, I also wanted massive draw distances so level of detail would 
become a hugely important focus over the coming weeks. To aid that, I 
split the world up with an octree that would adaptively subdivide around
 the camera:<br><br><center><a href="" class="image"><img src=""></a></center><br>Nodes
 in the octree would render polygons from equally sized voxel fields 
(32x32x32) for level of detail. Neighbouring nodes were constrained to 
being 1 level of detail above or below to help solve gaps and seams 
between levels of detail - a problem I'd yet to address. The subdivision
 was scheduled on a concurrent thread using a variation of the ROAM 
split/merge queue:<br><br><center><a href="" class="image"><img src=""></a></center><br>Some
 of the gaps in the landscape should be evident and I had an idea of how
 I was going to fix them, which I'll cover in a future post. The normals
 were generated from the vertices so weren't smooth and there was no 
vertex sharing. It was all pretty inefficient but was a good first pass.<br><br>What's
 evident from the above shot is that I also pulled the log window out. 
This was moved to a separate dev window that was constantly open on a 
second monitor:<br><br><center><a href="" class="image"><img src=""></a></center><br>I'd
 spent a bit of time adding some debugging features - the new window on 
the left was a property editor that could remotely observe and display 
the values of any reflected object live on the server. You can find the 
full two-monitor view on Flickr <a href="http://www.flickr.com/photos/donw/8250225991" target="new">here</a>.<br><br>In the next post I'll cover yet another crazy little change in direction that took a while to pay off!<br><br><a href="http://localhost/b/?d=2012-12-06-10-34-03#disqus_thread" data-disqus-identifier="2012-12-06-10-34-03">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20121130123001"><a href="javascript:blog_goto('2012-11-30-12-30-01')" class="title">Star: Record/Playback and a New Window Manager</a><br><span class="date">Posted 30 November 2012 12:30:01</span><br><br>Before
 we head into December, I figured I'd show you some screenshots from the
 progress I made prior to the scope of this all going a bit crazy :)<br><br>Here's a quick shot of the Editing Room at that point:<br><br><center><a href="http://www.flickr.com/photos/donw/8232472486" target="new"><img src=""></a></center><br>There
 are several pretty interesting new features at work here, some of which
 can't fully be seen unless you see the screenshots of their 
development. You can view them all by checking out the Flickr history 
page for this project:<br><br><center><a href="http://www.flickr.com/photos/donw/sets/72157632133873231" target="new"><img src=""></a></center><br>These lovely new features are:<ul><li> Recording, playback and post-record modifications On Set are all working.</li><li>
 You can manage and preview individual clips within scenes in the new 
Video Player; live-selecting which camera to view the clip from.</li><li>
 Scenes can be dragged onto the timeline and edited. Each clip as a list
 of properties you can edit (currently just which camera to view from).</li><li> The movie timeline has been fully implemented with scrubbing, zoom, pan, cutting, etc.</li><li> I added a new window manager with UI widgets like drop-down combo boxes.</li></ul><br><h4> Record/Playback </h4><br>This
 is the backbone of the application and is responsible for me having to 
do a crazy amount of work for every feature I decide to implement. Every
 time I describe this interaction loop to people, I feel like there's 
way too much to describe and they get lost. However, whenever I demo it,
 there's always this: "Oh. Wow! That's pretty cool." So until I gain the
 confidence to show some videos, this description will have to do :)<ul><li> You drag/drop an actor into the world and double-click to take control of it.</li><li> You hit record, do your thing and a clip is created for that sequence.</li><li>
 You drag/drop more actors into the world, take control of them and hit 
record. Previous actors do their thing while you interact with them.</li><li> Redo previous acts, add more or move to a new location to create entirely new clips.</li><li> Switch to the Editing Room to see a list of all your clips.</li><li> Select clips individually to preview with play, fast-forward, rewind, etc.</li><li> Drag clips onto the timeline and adjust their time and length of play.</li><li> Scrub through the movie to any point in time or just hit play to see what your movie looks like.</li></ul>When
 you initially record an act, only the input to the game logic is 
recorded. This is the input that gets compressed on disk or sent to your
 friends for modifications/additions, so it's pretty light-weight. 
Unfortunately, this format doesn't allow you to easily move through the 
timeline in the Editing Room so upon switching, all out-of-date clips 
will have a "position cache" generated for them on an idle thread/core.<br><br>Determinism
 is key here and I'm still wondering whether it is actually a desired 
goal. I'm thinking of forgoing it entirely at a later point and using 
some form of AI to keep things as sync'ed as possible. But that's all 
for next year when I get a bunch of people playing around with the 
alternatives.<br><br>However, it's pretty fun to play around with all this. Which is good :)<br><br><h4> The Timeline </h4><br>I love this little widget - it's a custom control implemented with the new HTML5 canvas object:<br><br><center><a href="" class="image"><img src=""></a></center><br>Some of the cool features are:<ul><li> Scrolling/panning is super-smooth.</li><li> Zooming smoothly fades in/out the required time ticks and their labels.</li><li> The cursor is custom-implemented to so that I can control the hot-spots of the icons it changes to when you modify elements.</li><li> Time is divided into 1/8ths of a second to allow precise positioning of elements.</li></ul>It
 took me a while to iterate on the Javascript code for this as the data 
it controls is replicated over the network to the C++ game logic. Even 
now, several months later, I have significant work to do on it and I 
anticipate that it will be constantly changing to adapt to new features.<br><br><h4> The Clip List </h4><br>This control isn't yet housed in the window manager but it's still pretty cool:<br><br><center><a href="" class="image"><img src=""></a></center><br>It
 lists all the scenes in your current movie along with a thumbnail 
generated from one of your cameras. As you might have guessed, that bit 
wasn't yet implemented :) However, you can select each clip and preview 
them. The UI is nice with smooth fading and expansion/contraction of the
 lists.<br><br>I had a lot of fun with the CSS of this but I will 
ultimately go back to it and change again to update to CSS 3. A lot of 
the animation code can be deleted, requiring less maintainence from me!<br><br><h4> The Window Manager </h4><br>Finally,
 the Window Manager was my own custom implementation (everything out 
there is wildly over-engineered or just not stable enough yet). Windows 
can be dragged around, overlap each other, switch to front/back, 
smoothly close/pop-open and contain layout code for child controls. A 
good example is the rather minimal clip properties dialogue box that 
pops up whenever you select a clip on the timeline:<br><br><center><a href="" class="image"><img src=""></a></center><br>This
 houses a property grid, which itself houses a combo-box for selecting 
the camera to view the clip from. The design for the Window Manager is 
very "programmer-y". I may hire somebody to make it more pleasing near 
the end, or I may just keep learning about UI concepts and try to make 
it better myself - we'll see :)<br><br><a href="http://localhost/b/?d=2012-11-30-12-30-01#disqus_thread" data-disqus-identifier="2012-11-30-12-30-01">2 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20121122130840"><a href="javascript:blog_goto('2012-11-22-13-08-40')" class="title">Star: Native Browser Games &amp; Tools with clReflect</a><br><span class="date">Posted 22 November 2012 13:08:40</span><br><br>A
 long time passed between development of the previous screenshots and 
the ones I'll show here; I think it was about a month or so. A quick 
summary of the additions would be:<ul><li> The game is now hosted in a browser.</li><li> Added a very simple HTML/Javascript user interface that communicates with the game.</li><li> Added some character locomotion and vehicle physics.</li><li> Defined what a world, scene and clip were, and started work on recording.</li></ul>This is a shot of being "On Set" in the game:<br><br><center><a href="http://www.flickr.com/photos/donw/8208806614" target="new"><img src=""></a></center><br>It
 took a while to get to this point and there are multiple builds of the 
game that represent the version I use for development and the version 
that I want to ship to players.<br><br><h4> clReflect as a Platform </h4><br>The core problem that required solving was seamless communication between native C++ and Javascript - <a href="https://bitbucket.org/dwilliamson/clreflect" target="new">clReflect</a>
 provides a means of safely hiding and abstracting that transport layer.
 It also allows the transport layer to be very minimal and not interfere
 with development. Currently, this is a Java Applet, using JNI to load 
the native code. <br><br>The development stack I ended up with looks like this:<br><br><center><a href="" class="image"><img src=""></a></center><br>The
 browser is the client and the game is the server. clReflect 
transparently serialises data types, events and function calls to and 
from a JSON string buffer, which in turn gets sent over the network. 
This is a format that is native to Javascript and trivial to encode and 
decode in the browser. The final D3D frame buffer is resolved to a 
shared memory buffer, instead of interfering with network traffic. This 
introduces some latency to the game.<br><br>The Server and Applet are 
separated because the Java JNI is still quite an horrendous platform to 
develop for (I experimented with it first over 10 years ago and it's 
still just as bad). It's tough to debug native code that crashes and the
 means of defining interfaces is tedious and error-prone.<br><br>The JNI
 and Host DLLs are separated because I wanted to runtime reload any DLL 
changes while the applet is still running. I tried for a very long time 
to get Java to reload its native DLLs in a session but it's fraught with
 horror stories. The simplest of solutions was also the cleanest: just 
stick it in another DLL and your JNI interaction is limited a single 100
 line C++ file!<br><br>Messages flow directly between the server and the
 browser and the final image is displayed through the Java canvas. This 
is completely browser independent (currently runs in Chrome, Firefox 
&amp; IE); I discussed some of the details in an <a href="javascript:blog_goto('2012-03-08-13-00-00')">earlier post</a>.<br><br>The shipping stack will look like:<br><br><center><a href="" class="image"><img src=""></a></center><br>Network
 I/O is gone and everything is hosted in the JNI DLL. This cuts out a 
number of security holes for the user and replaces the TCP/IP connection
 with a simple in-memory ring buffer replacement.<br><br>It's worth mentioning that the <a href="https://bitbucket.org/dwilliamson/clreflect" target="new">Bitbucket repository for clReflect</a>
 contains most of the code you need to get up and running with a system 
like this. I may open-source the remainder at a later date.<br><br><h4> Java as a Platform </h4><br>Ultimately,
 I'm not in any way invested in Java as the final platform. The way 
everything is set up, I can even support multiple hosting platforms. My 
ideal inbetween layer would be <a href="https://github.com/kripken/emscripten/wiki" target="new">Empscripten</a>
 (or something similar) but the performance is not there yet and I am 
doing so many crazy things that are a long way from being supported (I 
might do some contributing next year).<br><br>The other possibility is Google's <a href="https://developers.google.com/native-client/" target="new">Native Client</a>.
 This has the added bonus of sandbox-style security and multiple OS 
support. When I started this project, NaCl was in its infancy but I can 
see myself supporting it in the future. The important point is that I 
haven't been bottle-necked by any limitations in its maturing feature 
set. The limitation to Chrome and Google Store are somewhat irksome, 
though.<br><br>Origin are really missing a trick. While they're not as 
directly tied to the browser as something like NaCl, they have the 
potential to become as much of an app platform as something like that. 
Either way, I will ship on the Java platform and look to support other 
platforms in the future.<br><br><h4> The Game </h4><br>In the build 
above, you can drag and drop any item into the world and take control of
 it. Obviously, everything is just built up with simple primitives but 
it was a fun start to the game. The hit testing is done by rendering 
everything into the frame buffer with their object IDs and reading back 
the data under the mouse. This is the way it should really be done in 
all editors, unless you have some real-time feedback you need to 
optimise - more on that in a future post.<br><br>Vehicle physics uses 
raycast suspension - a tricky balancing act under Bullet's old-style 
implicit euler integrator. It took a while getting the numbers right 
while trying to keep the time step as large as possible. The character 
locomotion was FPS based, using a sphere driven by physics forces to 
move yourself around. You could drop as many cameras and items into the 
world at that point and run around controlling them.<br><br>I also added
 some fogging to give distance cues and hide the heightfield boundary - 
landscape streaming/generation was not a challenge required for the 
prototype. This was nothing special, just a per-pixel exponential 
fall-off to the sky colour.<br><br>Any new game updates are 
automatically updated and all my data is JSON-serialised with clReflect.
 While this means it's naturally versionable, I know that I will have 
some tricky scenarios to solve with auto-updating on client machines at a
 later date.<br><br>Finally, I roughed out the "Editing Room" tab for bringing all your clips together into a movie:<br><br><center><a href="http://www.flickr.com/photos/donw/8207716695/" target="new"><img src=""></a></center><br>None
 of that was functional, but the ability to quickly mock-up the user 
interface in HTML/Javascript was really nice. The game window is just a 
translated version of the On Set window.<br><br>Now we're getting somewhere! :)<br><br><a href="http://localhost/b/?d=2012-11-22-13-08-40#disqus_thread" data-disqus-identifier="2012-11-22-13-08-40">2 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20121115124324"><a href="javascript:blog_goto('2012-11-15-12-43-24')" class="title">Star: Scale, Physics and Shading</a><br><span class="date">Posted 15 November 2012 12:43:24</span><br><br>My
 goal for this project is to run in a browser with no installation steps
 required. This means I can't rely on any software on the host machine 
that needs to be installed by hand. I also wanted the executables to be 
as small as possible so that I could ship regular updates and limit the 
amount of bandwidth I have to pay for.<br><br><h4> The Build System </h4><br>After
 roughly 12 years of working within the MSVC build system and seeing 
multiple very large projects crumble under the weight of required 
maintainence, I decided to go for another build system. Because I wanted
 to use <a href="https://bitbucket.org/dwilliamson/clreflect" target="new">clReflect</a>, individual build steps needed to be configurable. <a href="javascript:blog_goto('2011-06-28-17-04-00')">This post</a> explains a little bit on why I decided to make my own build system.<br><br>The result was <a href="https://bitbucket.org/dwilliamson/pib" target="new">PiB</a>.
 It's served me well, but the first few months threw up its fair share 
of bugs. I use this to build all the code across all languages, 
including generating shader code permutations.<br><br><h4> The Base Libraries </h4><br>The
 first code step was building my own custom C Runtime Libraries (CRT). 
Programs built by MSVC can link statically with their own or dynamically
 with versions installed on the host machine. The former approach leads 
to large executable sizes and repeat updates of a large portion of the 
same code on each update. The latter requires users to install MSVC 
redistributables.<br><br>I started with <a href="http://msdn.microsoft.com/library/bb985746.aspx" target="new">Matt Pietrek's</a> articles/code as a base, extended it with some of the work in the <a href="http://www.codeproject.com/Articles/15156/Tiny-C-Runtime-Library" target="new">Tiny CRT</a> and added a whole host of my own modifications. This included:<ul><li> An sprintf implementation (relies on David Gay's <a href="http://www.netlib.org/fp/dtoa.c" target="new">dtoa</a>).</li><li> Lots of custom floating point math utilities (including an implementation of <a href="javascript:blog_goto('2012-05-15-10-36-23')">__CIpow</a>).</li><li> Some platform-optimised implementations of memset, memcpy, etc. as I wanted to work in debug builds as much as possible.</li><li> A lot of missing functionality to bring the library up to the code generation level the latest MSVC.</li><li> Functions required to emulate 64-bit arithmetic (e.g. _aulldiv).</li><li> Exception handling and buffer overrun detection support.</li></ul>All
 this gave me the benefit of a tiny executable, no host machine 
dependencies and a single header file to access all the CRT features I 
needed (this also benefits compile times).<br><br>On top of that, I added my own version of windows.h, a little trick I used on <a href="http://www.altdevblogaday.com/2012/01/03/reflection-in-c-part-2-the-simple-implementation-of-splinter-cell/" target="new">Splinter Cell: Conviction</a>.
 This can cut the compilation of an individual file from 3s to as little
 as a tenth of a second as its a single header file with nothing but 
forward declarations and type definitions. (The latest Splinter Cell 
apparently no longer does this because it became a pain to maintain - I 
shall have to see if it does for me, too)<br><br><h4> The Prototype </h4><br>The
 next step was some interaction! I set out on a 6 month prototyping 
adventure, with the goal of testing as many of the risky aspects of my 
game idea as possible, so visuals were far from being a priority. 
However, a playing area looks a bit dull without a little bit of 
lighting! The first thing I did was calculate normals for the 
heightfield and do some basic N.L shading based on some arbitrary light 
direction:<br><br><center><a href="http://www.flickr.com/photos/donw/8185789044/" target="new"><img src=""></a></center><br>The
 sky colour was initially red so that I could flicker between two 
different colours to double-check presenting to the window was working. 
Normals were calculated directly from the heightfield and I think its 
size was around 1024x1024 - I can't remember exactly.<br><br>As I didn't
 want to spend any time loading assets and wanted to get to the gameplay
 challenges as soon as possible, I added a few primitive generators:<br><br><center><a href="http://www.flickr.com/photos/donw/8185749175" target="new"><img src=""></a></center><br>These
 were just simple primitives, such as spheres, planes, cubes, cylinders,
 cones and a whole bunch of others that would try to render as strips; 
the plan was to use them as gameplay avatars during prototyping. For 
some reason I also changed the resolution to something like 640x480 (it 
may have been to test out some aspect ratio code).<br><br>After that I 
started work on an entity component system that was 
concurrency-friendly. I might discuss more of this in future posts but 
it's pretty awesome to work with (took a while to settle on a simple 
design). It works by gathering all components of a specific type in a 
frame and updating them: great for your code/data cache and seems to 
result in much more understandable code.<br><br><h4> Physics and Collision </h4><br>I've
 written several physics and collision detection systems in the past and
 was well aware of the amount of effort it takes to make something 
robust. It was thanks to that experience that I decided to go with <a href="http://bulletphysics.org/wordpress/" target="new">Bullet</a> and not write my own. I will admit; at one point I was considering it, just "for fun." I'm so glad I didn't!<br><br>I
 hooked up Bullet in its own DLL, for which updates should be very, very
 rare (and it isolates me from any excessive code build times associated
 with a large project such as that). I also made Bullet use my custom 
CRT, changes I've not yet submitted patches for (a CRT-independent 
Bullet would definitely aid its portability):<br><br><center><a href="http://www.flickr.com/photos/donw/8185789362" target="new"><img src=""></a></center><br>This
 image shows the physics hooked up to the game, with a custom 
heightfield collider. The existing Bullet collider doesn't correctly 
account for internal edges and I wrote <a href="http://bulletphysics.org/Bullet/phpBB3/viewtopic.php?f=9&amp;t=7498" target="new">a post</a> about my solution so that others may benefit.<br><br>I
 also added a little tri-planar procedural texture so that I could 
visually gauge the movement of objects. This becomes more useful when I 
start working on the character locomotion, which I'll talk about next 
time!<br><br><a href="http://localhost/b/?d=2012-11-15-12-43-24#disqus_thread" data-disqus-identifier="2012-11-15-12-43-24">2 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20121107171002"><a href="javascript:blog_goto('2012-11-07-17-10-02')" class="title">Announcing Project: Star</a><br><span class="date">Posted 07 November 2012 17:10:02</span><br><br>It's
 about time I started talking about my new game. I want to keep things 
very low-key for the moment so I'll limit activity to this blog until I 
have more to show. Over the coming months, starting with the first 
screenshot I took of the game a year ago, I'll slowly add more 
information about the project with some increasingly delicious 
accompanying screenshots.<br><br><h3> Overview </h3><br>The core 
principle is to democratise the art of story telling through movie 
making. The end goal being to give creative users like you or I the 
ability to make Pixar-style movies, without expensive tools or arduous 
creative process.<br><br>I hope to allow people to achieve this using 
the everyday mechanics that we are used to in video games. To that 
effect, multiple people will be able to collaborate on various parts of a
 movie in several distinct steps:<br><br><h4> Explore </h4><br>You are 
placed on a procedurally generated planet the size of our own Earth and 
tasked with finding good locations at various times of day to film. You 
can walk around the surface, swim in the oceans or explore caves 
underground. If you want to look further afield you can drop a car, 
plane or any other vehicle into the world and explore to your heart's 
content. Not satisfied being bound to the planet? Not a problem! Get in 
any space vehicle and you can travel above the atmosphere to host your 
own space opera.<br><br><h4> Create </h4><br>Once you have found your 
various sets you can extend them further by digging into and sculpting 
the terrain around them. It's all smooth-voxel based so you can create 
whatever structures you can imagine with different types of brush; from 
simple bricks to smoothly modifying air brushes. The same techniques can
 be used to create your own custom props, vehicles and characters that 
can be shared with your friends - kind of like sculpting clay in a game,
 but a lot simpler :)<br><br><h4> Film </h4><br>To plot the path of a 
car in a chase scene there's no need to deal with complicated 3D curve 
or animation tools; just drop a car into the world and get your actor to
 drive it using typical game controls. Hit record and play out your 
scene. Once you've filmed your scene, you can add more actors, vehicles,
 props, cameras, or whatever else you need and when you hit record, the 
actions of prior actors will be played out as you act. You can go back 
and change performances on an individual basis. Think the actor 
animations aren't good enough? Make some better ones by hooking up your 
Kinect and acting out live, in-game!<br><br><h4> Edit </h4><br>After 
you've filmed a few scenes, pull them into the edit room where you can 
drag everything onto a timeline and stitch them together to make your 
movie. Add post-processing effects (black &amp; white with film grain?),
 text overlays, extra sound-effects, cross fades or whatever else you 
need to tell your story. If something isn't quite right with a scene 
(camera angle not good enough?), switch right back to it and adjust 
whatever isn't right without affecting other performances.<br><br><h4> Share </h4><br>The
 final result is a recorded movie with all the rendering bells &amp; 
whistles dialed up to high, shareable on sites such as Youtube or Vimeo.<br><br><h3> The Beginning </h3><br>One
 year ago, the plan for the game was to make movies on an island, as one
 of my inspirations for the game is the fabled Stunt Island from Disney.
 Of course, as I'm self-employed and really want to push myself, this 
was shelved in favour of an entire planet (sheesh, I really don't like 
to make my life easy).<br><br>So once I had some very simple base 
libraries I needed a means to render an island. This called for a very 
basic heightfield renderer and a good old plasma generator to randomise 
the heights:<br><br><center><a href="http://www.flickr.com/photos/donw/8163775012/in/photostream" target="new"><img src=""></a></center><br>I
 suppose what's interesting about this little window is that it's just a
 dummy application that does nothing but send/receive network messages, 
sending input to the main game executable when it receives it and 
displaying images whenever the game sends them over. The eventual goal 
was to host the game in a browser, using all the standard HTML5 tools to
 build the user interface.<br><br><h4> Where next? </h4><br>This is 
where it all kicks off. I'm nervous as hell typing this up. I've been 
tight-lipped about this project for a year now and it's really starting 
to wear me down. I didn't want to share for many reasons, including: 
fear of the idea being "stolen" (<a href="http://www.flarkminator.com/2011/01/09/no-one-cares-about-your-cool-game-idea/" target="new">No One Cares About Your Cool Game Idea</a>),
 a complete inability to describe what I had in my head to people, fear 
of people thinking the idea was complete nonsense and a lack of concrete
 direction: the first 6 months were crazy-disorganised experimentation 
and discovery.<br><br>There are so many routes I can take this project, I
 sometimes get overwhelmed thinking about it. Just the thought of having
 multiple people coming into your own world and acting out a scene in a 
movie makes me giddy with excitement. The possible render modifications 
and platform modding tools I can expose to make each movie as unique as 
possible is crazy. The ability for people with different skills to 
contribute to whatever part of a movie they can, create a library of 
props for specific movie types (a Western?), make different characters 
or just film small movies on their own buzzes the imagination.<br><br>I 
now know exactly where I want to go with this and it's my hope that 
writing some open, honest posts about the development of the game will 
help combat a few of the irrational fears I have.<br><br>Coincidentally,
 today also marks 2 years to the day that I moved my life from Guildford
 to Hove to live with my beautiful girlfriend. I've only just found this
 out now - pretty awesome :)<br><br><a href="http://localhost/b/?d=2012-11-07-17-10-02#disqus_thread" data-disqus-identifier="2012-11-07-17-10-02">4 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20120820160723"><a href="javascript:blog_goto('2012-08-20-16-07-23')" class="title">Skeletal Animation Looping with Autocorrelation</a><br><span class="date">Posted 20 August 2012 16:07:23</span><br><br><br>This
 is a bit of a fun post highlighting how some simple maths can be used 
to create great visual results. With some basic statistics, we can 
create looping skeletal animations from an input data set that contains 
non-exact loops. A typical example is a motion capture sampled run 
animation:<br><br><center><a href="" class="image"><img src=""></a></center><br>This is derived from the <a href="http://mocap.cs.cmu.edu/" target="new">CMU Graphics Lab Motion Capture Database</a>, which has been <a href="https://sites.google.com/a/cgspeed.com/cgspeed/motion-capture/cmu-bvh-conversion" target="new">converted to BVH files</a>
 by Bruce Hahne. I can load BVH files and dynamically retarget them to 
my animation rigs so that I never have to worry about changing animation
 rigs again (this is absolutely key to some of the features of my 
product and would have been immensely useful for the animation pipelines
 in many of my past games).<br><br>The first task is to center the 
animation on the origin to allow movement to be controlled by the game. 
Appropriate playback timing/blending and IK foot fixups are added after 
that. Many games simply strip the root bone offset from the animation 
but you lose a lot of animated weight transfer and bounce. I chose 
instead to send out a "rabbit" node that attempts to keep up with the 
moving skeleton via a fixed linear velocity, subtracting its position to
 get:<br><br><center><a href="" class="image"><img src=""></a></center><br>You
 can notice the three-and-a-bit steps the skeleton takes, the slow 
raising of the torso and the hard snap at the end when the animation 
ends. Somewhere in there is a two step loop that can be used to create a
 seamlessly looping animation. The tasks required are:<ul><li> Use auto/cross correlation to identify potential loop lengths in the animation.</li><li> Search the animation using the loop lengths for start and end frames whose poses match.</li><li> Cross-fade the beginning and end of the animation to smooth out the differences.</li></ul>Statistics aren't my strong point so I would really appreciate any corrections to this post!<br><br><br><h4> Cross Correlation </h4><br>Given two discrete real data sets:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">x = [ x0, x1, x2 ... xn ]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">y = [ y0, y1, y2 ... yn ]</span><br><br><a href="http://en.wikipedia.org/wiki/Correlation_and_dependence" target="new">Correlation</a>
 can give you a single number that tells you how similar these two data 
sets are. This number is generally called the correlation coefficient 
and can be calculated in a number of different ways, depending on what 
particular features of the data set you're interested in highlighting.<br><br>The most common coefficient appears to be the <a href="http://en.wikipedia.org/wiki/Pearson_product-moment_correlation_coefficient" target="new">Pearson product-moment correlation coefficient</a>.
 The coefficient is in the range [-1,1] where 1 means there is a perfect
 linear relationship, 0 means there is no relationship and -1 means 
there is a negative linear relationship. A simple definition is:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation"><table style="margin-top:0.5em; margin-bottom:0.5em; text-align:center;" cellpadding="0" cellspacing="0"> <tbody><tr> <td rowspan="2"> &nbsp;&nbsp;&nbsp;R(x,y) = &nbsp;</td> <td> 1 </td> <td rowspan="2"> &nbsp;<span class="equation_large">&#8721;</span> </td> <td> x(i) - m(x) </td> <td rowspan="2"> <span class="equation_sym">&nbsp;</span> &nbsp; </td> <td> y(i) - m(y) </td> </tr> <tr> <td style="border-top:solid 1px black;"> n </td> <td style="border-top:solid 1px black;"> s(x) </td> <td style="border-top:solid 1px black;"> s(y) </td> </tr> </tbody></table></span><br><br>where <span class="equation">m(z)</span> is the median and <span class="equation">s(z)</span> is the standard deviation.<br><br>Interestingly,
 this coefficient is independent of the unit of measurement: it can 
report 100% correlation between data sets that differ in scale or 
offset. For example, if set <span class="equation">x</span> recorded your age in months and set <span class="equation">y</span>
 recorded your height in inches at that age, it will be able to report 
any linear relationship (e.g. you get taller as you get older) with a 
correlation coefficient close to 1. This nice result is achieved by 
first of all centering each data set on its median and then transforming
 the set into units of its standard deviation.<br><br><a href="http://en.wikipedia.org/wiki/Cross-correlation" target="new">Cross Correlation</a>
 uses this basic tool to evaluate how similar two input data sets are 
when one of them is offset (or, time-lagged in the case of audio 
samples). Assuming the data sets are equal in length, for every sample 
in <span class="equation">x</span>, the correlation coefficient is calculated with an offset version of <span class="equation">y</span>:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">xcorr(x, y) = &#8721; x' [m] <span class="equation_sym">&nbsp;</span> y[m + n]</span><br><br>Here, <span class="equation">'</span>
 is the complex conjugate. As we'll be dealing with real numbers, this 
can safely be ignored. You can use this for many things, like detecting 
the presence of one signal (or similar) somewhere within another, 
measuring tempo or even auto-tuning (yes, Mathematicians helped create 
our current generation of <a href="http://www.time.com/time/magazine/article/0,9171,1877372,00.html" target="new">talentless musicians</a>).<br><br>This leads to the following code:<br><br><div class="code"><br><span class="keyword">double</span> CrossCorrelate(<span class="keyword">const</span> std::vector&lt;<span class="keyword">double</span>&gt;&amp; x, <span class="keyword">const</span> std::vector&lt;<span class="keyword">double</span>&gt;&amp; y)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Assume data sets are the same size</span><br>&nbsp;&nbsp;&nbsp;&nbsp;size_t size = x.size();<br>&nbsp;&nbsp;&nbsp;&nbsp;assert(size == y.size());<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Calculate mean and standard deviation of data sets</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> mx = mean(x);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> my = mean(y);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> sx = stddev(x);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> sy = stddev(y);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Calculate correlation coefficient for each offset</span><br>&nbsp;&nbsp;&nbsp;&nbsp;std::vector&lt;<span class="keyword">double</span>&gt; Rxy(size);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (size_t i = 0; i &lt; size; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// First term can be pulled out of the inner loop</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> a = (x[i] - mx) / sx;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> c = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (size_t j = 0; j &lt; size; j++)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Second term is always offset by the constant 'i'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// I'm choosing to wrap here whereas you can also zero-pad</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t ij = (i + j) % size;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> b = (y[ij] - my) / sy;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c += a * b;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rxy[i] = c / size;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br>Assuming
 the input data sets are the same size is not very useful in reality, 
however we don't need to do full cross correlation. With animation, we 
want to be able to detect loops within one dataset; essentially making <span class="equation">x</span> and <span class="equation">y</span> the same.<br><br>This is called <a href="http://en.wikipedia.org/wiki/Autocorrelation" target="new">Autocorrelation</a>
 and it gets even better. Given that we're not interested in the 
unit-independent properties of cross correlation (we're comparing the 
same data set values), we can set the median to zero and standard 
deviation to one, leaving:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation"><table style="margin-top:0.5em; margin-bottom:0.5em; text-align:center;" cellpadding="0" cellspacing="0"> <tbody><tr> <td rowspan="2"> &nbsp;&nbsp;&nbsp;R(x,y) = &nbsp;</td> <td> 1 </td> <td rowspan="2"> &nbsp;<span class="equation_large">&#8721;</span> </td> <td rowspan="2"> x(i) </td> <td rowspan="2"> <span class="equation_sym">&nbsp;</span> &nbsp; </td> <td rowspan="2"> y(i) </td> </tr> <tr> <td style="border-top:solid 1px black;"> n </td> </tr> </tbody></table></span><br><br><h4> Application to Skeletal Animation </h4><br>The
 data set we have is the rotation values of each bone in an animation 
for each frame (I'm ignoring scale as you don't generally get that from 
BVH data and translations are present only on root bones). We want to 
perform autocorrelation for each frame of the animation with a frame 
offset version of itself.<br><br>Autocorrelation above was defined in 
terms of scalar value multiplication, so an equivalent data type and 
multiplication operator needs to be defined for a single frame of 
animation. This can be achieved by using a vector of all bone rotations 
for a specific frame, combined with a vector dot product, which is 
effectively a projection of one frame onto another (result is max when 
all bones line up).<br><br>You can use the quaternion values directly or
 euler angles; it doesn't matter. We're not interested in the values 
themselves, we're just interested in how they relate to each other. I 
have found, though, that I'm getting better results using rotations that
 are relative to their parent bone, as opposed to object-space 
rotations.<br><br>This leads to the following code:<br><br><div class="code"><br><span class="keyword">struct</span> Anim<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t <span class="keyword">int</span> nb_bones;<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t <span class="keyword">int</span> nb_frames;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Just rotation data for all bones in all frames</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// size = nb_bones * nb_frames</span><br>&nbsp;&nbsp;&nbsp;&nbsp;std::vector&lt;quat&gt; frame_data;<br>};<br><br><span class="keyword">double</span> DotProduct(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> std::vector&lt;quat&gt;&amp; x,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> std::vector&lt;quat&gt;&amp; y,<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t ox,<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t oy,<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t vector_size)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Dot product of two frame vectors. As they're just collections of rotation quaternions,</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// sum all quaternion dot products.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> dp = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (size_t i = 0; i &lt; vector_size; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quat q0 = x[ox + i];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quat q1 = y[oy + i];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp += q0.x * q1.x + q0.y * q1.y + q0.z * q1.z + q0.w * q1.w;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> dp;<br>}<br><br><br><span class="keyword">double</span> Correlate(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> Anim&amp; anim,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> std::vector&lt;quat&gt;&amp; x,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> std::vector&lt;quat&gt;&amp; y,<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t frame_offset)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> Rxy = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (size_t i = 0; i &lt; anim.nb_frames; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Shift and wrap to keep the inputs the same length</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t ox = i;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t oy = (frame_offset + i) % anim.nb_frames;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Calculating the Pearson correlation co-efficient using mean of zero and stdev of 1</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rxy += DotProduct(x, y, ox, oy, anim.nb_bones);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> Rxy / anim.nb_frames;<br>}<br><br><span class="comment">// Calculate the cross-correlation sequence using the same animation for both inputs (auto-correlation)</span><br>std::vector&lt;<span class="keyword">double</span>&gt; Rxy(anim.nb_frames);<br><span class="keyword">for</span> (size_t i = 0; i &lt; anim.nb_frames; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;Rxy[i] = Correlate(anim, anim.frame_data, anim.frame_data, i);<br></div><br><br>When applied to the centered animation above, the sequence looks like this:<br><br><br>
	<div id="xcorr_anim_graph" style="width:400px;height:250px;margin-left:auto;margin-right:auto;"></div>
<br><br><br>We're interested here in looking for the peaks of the graph,
 answering the question: other than at the start, where does the 
animation most look like itself? This is a standard local maximum search
 that starts off with computing the first derivative:<br><br><div class="code"><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// We want to detect the local minimum/maximum points in the sequence, as periodicity</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// estimates for the animation so calculate 1st derivative</span><br>&nbsp;&nbsp;&nbsp;&nbsp;std::vector&lt;<span class="keyword">double</span>&gt; Rxy_df(anim.nb_frames);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (size_t i = 1; i &lt; Rxy.size(); i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rxy_df[i] = Rxy[i] - Rxy[i - 1];<br></div><br>leading to:<br><br>
	<div id="1stderiv_anim_graph" style="width:400px;height:250px;margin-left:auto;margin-right:auto;"></div>
<br><br><br>Local minima/maxima are located at the zero crossings and local maxima can be detected where the derivative is decreasing.<br><br><br><h4> Searching for Start and End Frames </h4><br>Just
 as autocorrelation in audio can only measure tempo and not tell you 
where specific beats are, this technique will only tell you potential 
lengths of the animation. Autocorrelation is a function of the signal, 
not a frame, so we will need to search the animation for start/end 
frames that match each other as closely as possible.<br><br>Beyond 
rotation similarity, we also want to ensure velocity/acceleration and 
general trajectory similarity. Given a potential start and end frame, we
 can determine a simple measure of similarity by summing squared 
distances within a set window. By walking through all possible start/end
 frames and keeping the smallest sum, we can get our best match.<br><br>This code is based on Benjy Cook's Python mocap tools for Blender, linked below.<br><br><div class="code"><br><span class="keyword">double</span> SqrDistance(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> std::vector&lt;quat&gt;&amp; x,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> std::vector&lt;quat&gt;&amp; y,<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t ox,<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t oy,<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t vector_size)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> d = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (size_t i = 0; i &lt; vector_size; i++)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quat q0 = x[ox + i];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quat q1 = y[oy + i];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quat q = { q0.x - q1.x, q0.y - q1.y, q0.z - q1.z, q0.w - q1.w };<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d += q.x * q.x + q.y * q.y + q.z * q.z + q.w * q.w;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> d;<br>}<br><br><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> WINDOW_SIZE = 5;<br><span class="keyword">int</span> best_fit_frame = -1;<br>size_t best_fit_length = 0;<br><span class="keyword">double</span> best_fit_sum = 0;<br><br><span class="keyword">for</span> (size_t i = 0; i &lt; local_maxima.size(); i++)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t length = local_maxima[i];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Precalculate distances between all possible start/end frames at this length</span><br>&nbsp;&nbsp;&nbsp;&nbsp;std::vector&lt;<span class="keyword">double</span>&gt; distance(anim.nb_frames - length);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (size_t j = 0; j &lt; distance.size(); j++)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t ox = j * anim.nb_bones;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size_t oy = (j + length) * anim.nb_bones;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;distance[j]
 = SqrDistance(anim.frame_data, anim.frame_data, ox, oy, anim.nb_bones);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Search for the best start/end frame pair</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (size_t j = WINDOW_SIZE; j &lt; distance.size() - WINDOW_SIZE - 1; j++)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Sum distances in local neighbourhood</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> sum = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (size_t k = j - WINDOW_SIZE; k &lt;= j + WINDOW_SIZE; k++)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum += distance[k];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Keep the best fit</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (best_fit_frame == -1 || sum &lt; best_fit_sum)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_fit_frame = j;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_fit_length = length;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;best_fit_sum = sum;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br><br>Using the best fit frame and length, the animation can then be clipped to give:<br><br><br><center><a href="" class="image"><img src=""></a></center><br><br>There are a few things to note about the result:<ul><li> The two step loop has been correctly identified.</li><li> The start and end frames match pretty well: both leg and arm movement is almost seamless.</li><li> There is a visible snap after the torso still rises for the duration of the animation.</li></ul>Beyond
 employing better loop detection methods, this is really the best we can
 do without modifying the original animation. Even if we tried to look 
for better techniques, the chances of a single mocap shoot giving a 
perfectly loopable animation are minimal.<br><br><br><h4> Cross-fading Around the Seam </h4><br>The
 final simple part to this is to blend the last few frames in the 
animation so that they meet seamlessly with the frame at the start of 
the animation:<br><br><div class="code"><br><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> BLEND_SIZE = 10;<br><span class="keyword">for</span> (size_t i = 0; i &lt; BLEND_SIZE; i++)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;size_t offset = (anim.nb_frames - BLEND_SIZE + i) * anim.nb_bones;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">double</span> t = (<span class="keyword">double</span>)i / BLEND_SIZE;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> (size_t j = 0; j &lt; anim.nb_bones; j++)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> math::frame&amp; dst = anim.frame_data[j];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;math::frame&amp; src = anim.frame_data[offset + j];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;src = fLerp(src, dst, (<span class="keyword">float</span>)t);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br>A <i>frame</i> in my code base is an <a href="http://en.wikipedia.org/wiki/Affine_frame" target="new">Affine Frame</a>
 with vector position and quaternion rotation. I linearly interpolate 
both components based on their distance from the end of the animation 
(the quaternion lerp is normalised, as opposed to <a href="http://number-none.com/product/Understanding%20Slerp,%20Then%20Not%20Using%20It/" target="new">using slerp</a>). This cleans up any small position differences in the hip bone.<br><br>The final result is pretty cool!<br><br><center><a href="" class="image"><img src=""></a></center><br>You can tweak the number of blend frames a little to get a smoother transition.<br><br><br><h4> Conclusion </h4><br>There
 is a whole bunch of stuff that you'll need to do to make this 
production-ready (loops within loops, signal filtering, artist pre/post 
input/modification, etc) but it this should be a good start.<br><br>Curiously,
 while debugging all my code for this I found that zero-crossings of the
 second differential (representing local minima of the first derivative)
 were giving good approximations to the start and end frame in animation
 loops:<br><br><br>
	<div id="2ndderiv_anim_graph" style="width:400px;height:250px;margin-left:auto;margin-right:auto;"></div>
<br><br><br>If I start this specific animation at 15 and end it at 123, 
it loops just as well! I've not tested this on many data sets or dug 
into the maths further to see if there is anything to this, but it's an 
interesting avenue for future investigation.<br><br>Here's some links for further reading:<br><br><a href="http://wiki.blender.org/index.php/Extensions:2.6/Py/Scripts/Animation/Motion_Capture_Tools" target="new">Blender Mocap Tools</a> - A great source code reference for stuff like this, written by <a href="https://plus.google.com/104243235864119960562" target="new">Benjy Cook</a>. (Python)<br><a href="http://www.hawaii.edu/powerkills/UC.HTM" target="new">Understanding Correlation</a> - Online book hoping to shed some intuition on correlation.<br><a href="http://audiograins.com/blog/tag/cross-correlation/" target="new">Autocorrelation for Tempo Estimation</a><br><a href="http://dsp.stackexchange.com/questions/736/how-do-i-implement-cross-correlation-to-prove-two-audio-files-are-similar" target="new">How do I implement Cross-correlation to prove two audio files are similar?</a><br><br><a href="http://localhost/b/?d=2012-08-20-16-07-23#disqus_thread" data-disqus-identifier="2012-08-20-16-07-23">2 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20120802180122"><a href="javascript:blog_goto('2012-08-02-18-01-22')" class="title">Smoother Assert Response with Visual Studio</a><br><span class="date">Posted 02 August 2012 18:01:22</span><br><br><br>In
 my never-ending crusade to make my programming life as easy as 
possible, reducing click counts and milliseconds between iteration, I 
came up with a quick hack to my setup that speeds up my assert response.
 But what does that mean, exactly?<br><br>Let's say you have an assert function that uses the <i>__debugbreak()</i> macro (documented <a href="http://msdn.microsoft.com/en-us/library/f408b4et.aspx" target="new">here</a>):<br><br><div class="code"><br><span class="keyword">void</span> Assert(<span class="keyword">bool</span> expression)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (expression == <span class="keyword">false</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxA(0, <span class="string">"&lt;&lt;expression goes here&gt;&gt;"</span>, <span class="string">"ASSERT Failed"</span>, MB_OK);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__debugbreak();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br>Obviously, the first dialogue it pops up is for your specific assert [1]:<br><br><center><a href="" class="image"><img src=""></a></center><br>On a new development machine in Windows 7, the first dialogue box you get is this one [2]:<br><br><center><a href="" class="image"><img src=""></a></center><br>This
 can take a long time before it finally figures out there's nothing it 
can do about your own program and then pops up this one [3]:<br><br><center><a href="" class="image"><img src=""></a></center><br>You hit <i>Debug the program</i> and the next popup you get is this one [4]:<br><br><center><a href="" class="image"><img src=""></a></center><br>Annoyingly,
 this window isn't brought to the top so you have to locate its flashing
 icon in the task bar and switch to it (or ALT-TAB). After selecting the
 existing Visual Studio instance and pressing <i>Yes</i>, the debugger attaches to your program, jumps to the line where you have the problem and pops up its final dialogue [5]:<br><br><center><a href="" class="image"><img src=""></a></center><br>Again, the Visual Studio window isn't brought to the top so you have to manually switch before you can hit <i>Break</i>.<br><br>It's
 exhausting. To make it worse, switching to some of the windows doesn't 
automatically switch keyboard focus, either. You can do two things 
immediately: The first is to remove your custom assert dialogue and the 
second is to type "Choose how to report problems" in the start menu and 
make sure "Never check for solutions (not recommended)". This will 
remove the first two popups, still leaving you with the long trail of 
dialogue clicks and switches before you figure out what's just happened.
 Annoyingly, you've just removed the assert dialogue box so you won't 
know what they problem is until you click through the mess.<br><br>After
 searching for a while I couldn't find anything that would disable those
 dialogue boxes so I figured I'd have a go at putting the app in a 
situation where they wouldn't have to show up.<br><br><br><h4> Solving the simple case </h4><br>If
 you run with the debugger attached from the outset, this entire process
 is skipped. All you get is dialogues [1] and [5] popping up. You can 
detect this specific scenario using <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms680345%28v=vs.85%29.aspx" target="new">IsDebuggerPresent</a> and suppress the dialogue box in that case:<br><br><div class="code"><br><span class="keyword">void</span> Assert(<span class="keyword">bool</span> expression)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (expression == <span class="keyword">false</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (!IsDebuggerPresent())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxA(0, <span class="string">"&lt;&lt;expression goes here&gt;&gt;"</span>, <span class="string">"ASSERT Failed"</span>, MB_OK);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__debugbreak();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br>Instantly,
 Visual Studio becomes the app with primary focus and only brings up 
dialogue [5]. Given that I can't find any means of disabling [5], this 
is the ideal solution. Visual Studio also has keyboard focus so you just
 press ENTER and continue into your source code.<br><br><br><h4> Forcing Visual Studio to attach before breaking </h4><br>In a <a href="javascript:blog_goto('2012-02-07-11-37-23')">previous post</a>, I covered how you can remotely request that Visual Studio attaches to a running program. The steps required were:<ul><li> Write a Visual Studio macro that attaches to the program (source is in the previous post).</li><li> Write a vbscript or executable that uses Visual Studio's COM Automation Model to execute that macro.</li></ul>I've
 upgraded to Visual Studio 2010 since then and took the opportunity to 
rewrite the C++ program that executes the macro. As far as I can recall,
 I couldn't actually get it to work with 2010 so I had to write it in C#
 instead. That actually turned out to be a huge benefit because the 
program simplified to:<br><br><div class="code"><br><span class="keyword">using</span> EnvDTE;<br><br><span class="keyword">namespace</span> AttachDebugger<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">class</span> Program<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span> <span class="keyword">void</span> Main(string[] args)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DTE
 dte = (DTE)System.Runtime.InteropServices.Marshal.GetActiveObject(<span class="string">"VisualStudio.DTE.10.0"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dte.ExecuteCommand(<span class="string">"Macros.StarVSMacros.Debug.AttachToGame"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br>This required the single .NET reference <i>EnvDTE</i> to build successfully.<br><br>Assuming use of the <i>RunProcess</i> function from the initial post, the assert function can then become:<br><br><div class="code"><br><span class="keyword">void</span> Assert(<span class="keyword">bool</span> expression)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (expression == <span class="keyword">false</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (IsDebuggerPresent())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__debugbreak();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Popup your assert info - you may want an extra check here to disable</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// it on programmer machines.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxA(0, <span class="string">"&lt;&lt;expression goes here&gt;&gt;"</span>, <span class="string">"ASSERT Failed"</span>, MB_OK);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Try and launch the executable that gets Visual Studio to attach the debugger</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (RunProcess(<span class="string">"AttachDebugger.exe"</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Wait around for it to complete - make sure you have a time-out here</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span> (!IsDebuggerPresent())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// This is a completely arbitrary wait period. If __debugbreak is called before</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// the attach macro gets a chance to finish, Visual Studio goes into an infinite</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// loop that requires you to kill devenv.exe and attachdebugger.exe.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// This isn't ideal, you may want to introduce a more explicit sync, but this works</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// well enough for me on my own project.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(100);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__debugbreak();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br>This
 works really well. With my implementation, I always display the assert 
dialogue when the debugger isn't attached. I instantly get dialogues [1]
 and [5] with full window/keyboard focus switches.<br><br><a href="http://localhost/b/?d=2012-08-02-18-01-22#disqus_thread" data-disqus-identifier="2012-08-02-18-01-22">2 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20120727124230"><br><a href="javascript:blog_goto('2012-07-27-12-42-30')" class="title">Getting Google to Index AJAX Content</a><br><span class="date">Posted 27 July 2012 12:42:30</span><br><br>I'm
 stuck on quite a major feature and only have a few hours of time 
available to work today so I thought I'd take a break and work on 
something that has been confusing me for a while, now.<br><br>I use <a href="javascript:blog_goto('TinyBlog')">TinyBlog</a>
 to write posts/pages on this website and, since it uses jQuery's AJAX 
functions to dynamically load the posts, Google does not index it. If 
you dynamically generate content with Javascript, Google can <a href="http://www.seomoz.org/ugc/can-google-really-access-content-in-javascript-really" target="new">apparently</a> <a href="http://searchengineland.com/google-can-now-execute-ajax-javascript-for-indexing-99518" target="new">index</a> <a href="http://www.adherewebdesign.com/can-google-index-javascript-generated-content-results/" target="new">it</a>.
 AJAX is a no go, however. I know a few people use TinyBlog to host 
their site so this information should hopefully be useful to you.<br><br>The first port of call is the page <a href="https://developers.google.com/webmasters/ajax-crawling/" target="new">Making AJAX Applications Crawlable</a>
 from Google. It's quite thorough and gives some good general advice. 
There are a few different routes you can take so I'll just describe the 
one specific to my site.<br><br><br><h4> Telling Google that you're different </h4><br>The first step I took was to add a <i>meta</i> tag to the head of my HTML file telling Google's crawl bot that I wanted it to index my site in a specific way:<br><br><div class="code"><br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;html&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;head&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta name=<span class="string">"fragment"</span> content=<span class="string">"!"</span>&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/head&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;&lt;/html&gt;<br></div><br>When
 the crawl bot encounters this tag it modifies the URL it used to 
download your page and performs another request. If the bot initially 
requested the page <i>http://donw.org/b/</i>, it would be modified to <i>http://donw.org/b/?_escaped_fragment_=</i> and requested again. It's then up to you to configure your server to redirect such requests to a HTML snapshot of your page.<br><br>Note that if you have a query string somewhere in that URL then it will be preserved appropriately. So, <i>http://donw.org/b/?d=About</i> becomes <i>http://donw.org/b/?_escaped_fragment_=d=About</i>.
 If your snapshot executes Javascript, it might be worth getting it to 
strip the additional content from the query string before it parses it.<br><br><br><h4> Generating a snapshot </h4><br>This
 is the simple bit. I just loaded my page in Chrome and saved the full 
page to disk. Saving it as just HTML didn't capture any of the content 
so wasn't good enough. I tried Firefox but its full save was about 4 
times the size of the Chrome version, however, it did have a very useful
 save as text feature. If you're concerned about bandwidth, that might 
be a good option for you.<br><br>Alternatively, you can use tools such as <a href="http://htmlunit.sourceforge.net/" target="new">HtmlUnit</a>, <a href="http://www.crawljax.com/" target="new">crawljax</a> or <a href="http://www.watij.com/" target="new">watij.com</a> if you want more control over what your snapshot looks like.<br><br><br><h4> Configuring the server </h4><br>With the snapshot setup, you will need to tell your server to redirect any requests with <i>_escaped_fragment_=</i>
 in the query string to your snapshot. Not only that, you need to 
preserve the query string beyond this when redirecting. This can be 
achieved using the Apache HTTPD <a href="http://httpd.apache.org/docs/current/mod/mod_rewrite.html" target="new">rewrite module</a>.<br><br>Assuming this is setup on your server, the first step is to add a <i>.htaccess</i> file to the directory that hosts your blog. There's a great tutorial on controlling these files <a href="http://www.javascriptkit.com/howto/htaccess.shtml" target="new">here</a>. Mine looks like this:<br><br><div class="code"><br>RewriteEngine on<br>RewriteCond %{QUERY_STRING} ^_escaped_fragment_=(.*)$<br>RewriteRule ^$ /b/Snapshot/Gazoo.cpp.htm [QSA,L]<br></div><br>The <a href="http://httpd.apache.org/docs/current/mod/mod_rewrite.html#rewritecond" target="new">RewriteCond</a> directive tells the server to match the URL query string with the provided regular expression. Upon success, the <a href="http://httpd.apache.org/docs/current/mod/mod_rewrite.html#rewriterule" target="new">RewriteRule</a> directive redirects to the snapshot webpage. The <i>[QSA,L]</i> flags tell the server to append the query string and stop executing any more rewrite rules.<br><br><br><h4> Testing that this works </h4><br>The first test is obviously to test the rewrite module works. For example, <a href="http://donw.org/b/?_escaped_fragment_=" target="new">http://donw.org/b/?_escaped_fragment_=</a> should redirect you to <i>http://donw.org/b/Snapshot/Gazoo.cpp.htm</i> with the URL and query string preserved. Hit view source and all your dynamically loaded content should be there.<br><br>The next step is to see how the crawl bot views it. You can use Google's <a href="http://support.google.com/webmasters/bin/answer.py?hl=en&amp;answer=158587" target="new">Fetch as Google</a> tool to do this. If you haven't already signed up for the <a href="http://www.google.com/webmasters/tools/" target="new">Webmaster Tools</a> then you need to do so to use it.<br><br>The important, undocumented point to realise is that even though the Google crawl bot supports the above <i>meta</i> tag, the Fetch as Google tool does not! When you instruct the tool to fetch your page, instead of typing something like <i>http://donw.org/b/</i>, you need to explicitly inform the tool to request the alternative URL. This is done by using <i>http://donw.org/b/#!</i> instead.<br><br>Submit the final page for indexing and you're done!<br><br><br><h4> Final words </h4><br>Since the initial version of TinyBlog I've made a lot of modifications, such as <a href="http://disqus.com/" target="new">Disqus</a>
 comment integration and very simple equation formatting (not submitted 
to Bitbucket yet, but you can view the source of this page to check out 
its implementation). The lack of indexing support from Google was one of
 the really interesting fall-out problems I didn't anticipate and it's 
taken me until now to sort that out.<br><br>The biggest fall-out of them
 all, however, is the lack of previews in my RSS feed generation. All 
the content is loaded and formatted on the client in Javascript and as 
an RSS feed can only be generated offline or by server-side code, I 
either have to dump previews raw, write a formatting engine in PHP or 
just get the PHP to strip the formatting.<br><br>It all seems a bit 
redundant and after making a stab at some PHP code which doesn't stress 
the server file system, I'm almost tempted to ditch all my PHP code and 
write some offline Python that just does the lot for me. Tempting.<br><br><a href="http://localhost/b/?d=2012-07-27-12-42-30#disqus_thread" data-disqus-identifier="2012-07-27-12-42-30">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20120719125203"><br><a href="javascript:blog_goto('2012-07-19-12-52-03')" class="title">Quaternions and Dual Quaternion Skinning</a><br><span class="date">Posted 19 July 2012 12:52:03</span><br><br>For some reason I like quaternions. I fell in love with complex numbers back in school when I found out that they <a href="http://en.wikipedia.org/wiki/Algebraically_closed_field#Examples" target="new">made more sense than real numbers</a>. While it <a href="http://t.co/28OKagHl" target="new">might not exactly be helpful</a>
 to visualise quaternions as an extension of complex numbers, there's 
something in there that just grabs at me. Unlike previous posts, I've 
managed to update to D3D11 so I'll be discussing implementation details 
in terms of HLSL (Shader Model 4, as I also have a D3D10 dev machine).<br><br>I'm no mathematician so hopefully this information in this post should be pretty accessible.<br><br><br><h4> Dual Quaternion Skinning </h4><br>I
 spent a couple of hours last week converting my skinning pipeline to 
use dual quaternions. My animation pipeline works with quaternions; the 
source animation data, skeleton pose and inverse base pose are 
quaternion-based. Right at the very end, the composited result is 
converted to matrix and sent to the GPU. In effect, I'm doing this:<br><br><div class="code"><br><span class="keyword">for</span> (<span class="keyword">int</span> i = 0; i &lt; nb_bones; i++)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> rend::Bone&amp; bone = skeleton.bones[i];<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> rend::Keyframe&amp; kf = keyframes[i + frame * nb_bones];<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Calculate inverse base pose</span><br>&nbsp;&nbsp;&nbsp;&nbsp;math::quat q0 = qConjugate(bone.base_pose.rotation);<br>&nbsp;&nbsp;&nbsp;&nbsp;math::vec3 p0 = qTransformPos(q0, v3Negate(bone.base_pose.position));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Concatenate with animation keyframe</span><br>&nbsp;&nbsp;&nbsp;&nbsp;math::quat q = qMultiply(q0, kf.rotation);<br>&nbsp;&nbsp;&nbsp;&nbsp;math::vec3 p = qTransformPos(kf.rotation, p0);<br>&nbsp;&nbsp;&nbsp;&nbsp;p = v3Add(p, kf.position);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Set the transform</span><br>&nbsp;&nbsp;&nbsp;&nbsp;math::mat4&amp; transform = transforms[i];<br>&nbsp;&nbsp;&nbsp;&nbsp;transform = qToMat4(q);<br>&nbsp;&nbsp;&nbsp;&nbsp;transform.r[3] = math::v4Make(p.x, p.y, p.z, 1);<br>}<br></div><br>In reality, I precalculate the inverse base pose, keeping the inner loop tight and low on ALU operations. My goals were:<ul><li>
 Capitalise on the quaternion input and remove the conversion to matrix 
step. On all past games I've worked on, the matrix multiply with base 
pose has had a destructive influence on CPU performance; if I could 
remove this step, I'd have a solution that would be faster than my past 
implementations.</li><li> Reduce the amount of data being mapped/sent to
 the GPU. While my existing solution was sending 4x4 matrices, one of 
the columns was redundant - I could be sending 4x3. However, dual 
quaternions would allow me to halve the amount of data sent.</li><li> Get volume-preserving skinning on joints under extreme rotation.</li><li> Have a bit of fun and exercise some neglected quaternion/vector math muscles.</li></ul>
 I skimmed the paper, copied the HLSL source code and tested everything 
on a basic idle animation. Bad idea, right? But everything seemed to 
work. I hooked up my mocap pipeline this week and everything went wrong -
 limbs were folding inside each other and the character was skewing all 
over the place.<br><br> Searching the internets for equivalent 
implementations found that most basically copied and pasted from the 
paper. Some seemed to make an effort to understand what was going on 
under the hood but all of them produced the same results (oddly, the 
nVidia shader was the most needlessly complicated and inefficient of 
them all). So I knuckled down and decided to read the following papers 
in more detail:<ul><li> <a href="http://wscg.zcu.cz/wscg2012/cd-rom/short/A29-full.pdf" target="new">A Beginners Guide to Dual Quaternions</a></li><li> <a href="http://isg.cs.tcd.ie/projects/DualQuaternions/" target="new">Geometric Skinning with Approximate Dual Quaternion Blending</a></li></ul>The basic method is this:<ul><li> Convert your quaternion rotation and position vector to a dual quaternion on the CPU for each bone.</li><li> In your vertex shader, load all dual quaternion bone transforms for the vertex.</li><li> Create a single dual quaternion that is the weighted average of all the bone transforms.</li><li> Transform the vertex position and normal by this dual quaternion.</li></ul><br><h4> Quaternion/Vector Multiplication </h4><br>To
 cut a long story short, the reason none of this was working for me was 
that I was looking at Cg code, as opposed to HLSL code. Having never 
really used Cg, it never occurred to me that the order of cross product 
parameters should be swapped to account for handedness. Cross products 
are used to define the quaternion multiplication:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q = (w, V)</span> <br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>r</sub> = Q<sub>0</sub>Q<sub>1</sub></span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>r</sub> = (w<sub>0</sub>w<sub>1</sub> - V<sub>1</sub><span class="equation_sym">&nbsp;</span>V<sub>2</sub>, w<sub>0</sub>V<sub>1</sub> + w<sub>1</sub>V<sub>0</sub> + V<sub>0</sub>&nbsp;V<sub>1</sub>)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;(<span class="equation"><span class="equation_sym">&nbsp;</span></span> is the vector dot product and <span class="equation">&nbsp;</span> is the vector cross product)<br><br>Naturally,
 this is then a non-commutative operation, giving the order in which you
 pass arguments into your multiply functions importance, too. A basic 
C++ implementation of the multiplication looks like:<br><br><div class="code"><br>math::quat math::qMultiply(<span class="keyword">const</span> math::quat&amp; a, <span class="keyword">const</span> math::quat&amp; b)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;quat q =<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.w * b.x + a.x * b.w + a.y * b.z - a.z * b.y,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.w * b.y - a.x * b.z + a.y * b.w + a.z * b.x,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.w * b.z + a.x * b.y - a.y * b.x + a.z * b.w,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z,<br>&nbsp;&nbsp;&nbsp;&nbsp;};<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> q;<br>}<br></div><br>Assuming we're using unit quaternions, you can rotate a vector by a quaternion using multiplication:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">P<sub>rot</sub> = Q<span class="equation_sym">&nbsp;</span>(0, P)<span class="equation_sym">&nbsp;</span>Q'</span><br><br>Here, <span class="equation"><span class="equation_sym">&nbsp;</span></span> is the quaternion multiplication, <span class="equation">'</span> is the quaternion conjugate and <span class="equation">(0,P)</span>
 is construction of a pure quaternion using the vector, setting the 
quaternion real component to zero. This equation is used to convert to 
and from dual quaternions, so it's important you keep order of 
multiplications in mind.<br><br>If you work with Cg, make sure you have your cross products round the other way to my shader examples below!<br><br><br><h4> Converting to Dual Quaternion </h4><br>I'd
 suggest reading the second paper linked above to get a good 
introduction to what dual quaternions are and what the various 
components mean. For our means here it's enough to say that dual 
quaternions are just a pair of quaternions - the "real" quaternion and 
the "dual" quaternion:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">DQ = (Q<sub>r</sub>, Q<sub>d</sub>)</span><br><br>Converting a quaternion rotation and position vector to this representation is simple. The <span class="equation">Q<sub>r</sub></span> term is a simple copy of your quaternion rotation and <span class="equation">Q<sub>d</sub></span> is:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>d</sub> = 0.5(0, V)<span class="equation_sym">&nbsp;</span>Q<sub>r</sub></span><br><br>This allows the matrix conversion code on the CPU to become:<br><br><div class="code"><br><span class="comment">// Convert position/rotation to dual quaternion</span><br>math::dualquat&amp; transform = transforms[i];<br>transform.r = q;<br>transform.d = qScale(qMultiplyPure(q, p), 0.5f);<br></div><br>Much nicer! <i>MultiplyPure</i> is a simple function that does a special case multiply where <i>p.w</i> is zero.<br><br><br><h4> Blending Dual Quaternions </h4><br>Now we can move over to the HLSL side. This is my transform loading code:<br><br><div class="code"><br>Buffer&lt;<span class="keyword">float</span>4&gt; g_BoneTransforms;<br><br><span class="keyword">float</span>2x4 GetBoneDualQuat(uint bone_index)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Load bone rows individually</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>4 row0 = g_BoneTransforms.Load(bone_index * 2 + 0);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>4 row1 = g_BoneTransforms.Load(bone_index * 2 + 1);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="keyword">float</span>2x4(row0, row1);<br>}<br></div><br>As
 mentioned before, we want to load the bones that influence a vertex, 
weight them and transform the vertex position and normal:<br><br><div class="code"><br><span class="keyword">float</span>2x4 BlendBoneTransforms(uint4 bone_indices, <span class="keyword">float</span>4 bone_weights)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Fetch bones</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2x4 dq0 = GetBoneDualQuat(bone_indices.x);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2x4 dq1 = GetBoneDualQuat(bone_indices.y);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2x4 dq2 = GetBoneDualQuat(bone_indices.z);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2x4 dq3 = GetBoneDualQuat(bone_indices.w);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// ...blend...</span><br>}<br></div><br>As
 with quaternions, weighting dual quaternions can be achieved using a 
normalised lerp of its components. As explained in the paper <a href="http://number-none.com/product/Understanding%20Slerp,%20Then%20Not%20Using%20It/" target="new">Understanding Slerp, Then Not Using It</a>,
 it's not as good as a SLERP in that it's not constant velocity. 
However, it has minimal torque, rotating along the sphere and unlike 
SLERP, is commutative; meaning, if you combine multiple quaternions in a
 different order, the result will always be the same.<br><br>Besides, 
when you're regenerating bone rotations each frame, interpolation 
velocity won't really factor into the solution. The weighting code thus 
becomes:<br><br><div class="code"><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Blend</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2x4 result =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone_weights.x * dq0 +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone_weights.y * dq1 +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone_weights.z * dq2 +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone_weights.w * dq3;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Normalise</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> norm = length(result[0]);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> result / norm;<br></div><br>Simples!
 In the original paper, Kavan goes into great detail on why this works 
so well over previous solutions and why a SLERP isn't the ideal 
solution. Well worth a read.<br><br><br><h4> Antipodality or, Quaternion Double-Cover </h4><br>Take a look at one of the classic release bugs of this generation:<br><br><center></center><br>There's
 a pretty awesome reason for why the head can spin the long way around 
to get to its target rotation (no doubt the bug will be more complicated
 than that). Casey Muratori goes into <a href="https://mollyrocket.com/837" target="new">great detail on this</a> and I'll attempt to summarise.<br><br>The axis-angle definition of a quaternion is:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q = (cos(&#952;/2), Vsin(&#952;/2))</span><br><br>Inherent
 in this definition is the ability for quaternions to represent up to 
720 degrees of rotation. Assuming we use the x-axis as our example 
vector, this leads to these quantities:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q(0) = (1, 0, 0, 0)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q(360) = (-1, 0, 0, 0)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q(720) = (1, 0, 0, 0)</span><br><br>While
 sine and cosine are periodic every 360 degrees, the division by two of 
the input angle leads the quaternion representation to be periodic every
 720 degrees.<br><br>Clearly, 360 degrees and 720 degrees represent the 
same geometrical rotation. However, when you interpolate between 
rotations, you may find yourself interpolating the long way round. Your 
source/target rotation range may geometrically be only 30 to 35 degrees 
but your quaternion may represent that as 30 to 395 degrees!<br><br>If 
you've glimpsed at the inner workings of a SLERP, this is the case they 
are trying to avoid when trying to solve for the "shortest path". Given 
that <span class="equation">Q</span> and <span class="equation">-Q</span>
 represent the rotation, you can ensure interpolation between two 
quaternions follows this shortest path by negating one of the 
quaternions if the dot product between them is negative.<br><br>When 
blending dual quaternions, you have to watch for the same case. Not only
 that, you have to ensure that all of your bone transforms are in the 
same neighbourhood. While there are <a href="http://pages.cs.wisc.edu/%7Ejoony/RESEARCH/online_locomotion.pdf" target="new">complicated ways of achieving that</a>,
 most of the time it can be guaranteed by comparing all bone rotations 
to the first one and adjusting the sign of the blend weight.<br><br>This leads to the final code:<br><br><div class="code"> <br><span class="keyword">float</span>2x4 BlendBoneTransforms(uint4 bone_indices, <span class="keyword">float</span>4 bone_weights)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Fetch bones</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2x4 dq0 = GetBoneDualQuat(bone_indices.x);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2x4 dq1 = GetBoneDualQuat(bone_indices.y);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2x4 dq2 = GetBoneDualQuat(bone_indices.z);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2x4 dq3 = GetBoneDualQuat(bone_indices.w);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Ensure all bone transforms are in the same neighbourhood</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (dot(dq0[0], dq1[0]) &lt; 0.0) bone_weights.y *= -1.0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (dot(dq0[0], dq2[0]) &lt; 0.0) bone_weights.z *= -1.0;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (dot(dq0[0], dq3[0]) &lt; 0.0) bone_weights.w *= -1.0;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Blend</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>2x4 result =<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone_weights.x * dq0 +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone_weights.y * dq1 +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone_weights.z * dq2 +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bone_weights.w * dq3;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Normalise</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span> norm = length(result[0]);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> result / norm;<br>}<br></div><br>There
 are cases which can still fail these checks but they are very rare for 
the general use-case of skinning - I can't imagine this working well for
 severe joint twists, for example (beyond the range of human 
constraints, that is).<br><br><br><h4> Transforming the Vertex with Dual Quaternions </h4><br>Once
 you have the blended result you need to convert it back into 
quaternion/vector form and transform your vertex. There are two ways of 
achieving this:<ul><li> Convert straight to matrix and use the matrix to transform the vertex.</li><li> Convert to quaternion/vector and transform the vertex using that.</li></ul>The
 fastest and by far cleanest way is the second so I will concentrate on 
that. Given that you already have the rotation in the <span class="equation">Q<sub>r</sub></span> component of the dual quaternion, extraction of the translation vector is achieved using the following:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">V = 2Q<sub>d</sub><span class="equation_sym">&nbsp;</span>Q<sub>r</sub>'</span><br><br>This can be implemented directly as:<br><br><div class="code"><br><span class="keyword">float</span>4 Conjugate(<span class="keyword">float</span>4 q)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="keyword">float</span>4(-q.x, -q.y, -q.z, q.w);<br>}<br><br><span class="keyword">float</span>4 Multiply(<span class="keyword">float</span>4 a, <span class="keyword">float</span>4 b)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="keyword">float</span>4(a.w * b.xyz + b.w * a.xyz + cross(b.xyz, a.xyz), a.w * b.w - dot(a.xyz, b.xyz));<br>}<br><br><span class="keyword">float</span>3 ReconstructTranslation(<span class="keyword">float</span>4 Qr, <span class="keyword">float</span>4 Qd)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// The input is the dual quaternion, real part and dual part</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> Multiply(Qd, Conjugate(Qr)).xyz;<br>}<br></div><br>Of course, the complete calculation can be collapsed by directly applying the conjugate sign and discarding w:<br><br><div class="code"><br><span class="keyword">float</span>3 ReconstructTranslation(<span class="keyword">float</span>4 Qr, <span class="keyword">float</span>4 Qd)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> 2 * (Qr.w * Qd.xyz - Qd.w * Qr.xyz + cross(Qd.xyz, Qr.xyz));<br>}<br></div><br>Using
 the Conjugate and Multiply functions, it's then easy to transform a 
position and vector by the quaternion rotation and reconstructed 
position:<br><br><div class="code"><br><span class="keyword">float</span>3 QuatRotateVector(<span class="keyword">float</span>4 Qr, <span class="keyword">float</span>3 v)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Straight-forward application of Q.v.Q', discarding w</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> Multiply(Multiply(Qr, <span class="keyword">float</span>4(v, 0)), Conjugate(Qr)).xyz;<br>}<br><br><span class="keyword">float</span>3 DualQuatTransformPoint(<span class="keyword">float</span>4 Qr, <span class="keyword">float</span>4 Qd, <span class="keyword">float</span>3 p)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Reconstruct translation from the dual quaternion</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">float</span>3 t = 2 * (Qr.w * Qd.xyz - Qd.w * Qr.xyz + cross(Qd.xyz, Qr.xyz));<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Combine with rotation of the input point</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> QuatRotateVector(Qr, p) + t;<br>}<br></div><br>This leaves you with the final code:<br><br><div class="code"><br><span class="keyword">float</span>2x4 skin_transform = BlendBoneTransforms(input.bone_indices, input.bone_weights);<br><span class="keyword">float</span>3 pos = DualQuatTransformPoint(skin_transform[0], skin_transform[1], input.pos);<br><span class="keyword">float</span>3 normal = QuatRotateVector(skin_transform[0], input.normal);<br></div><br><h4> Optimising the Vertex Transformation </h4><br>There's
 a bit of redundancy in the transformation code above; results being 
thrown away and inputs being used when they could be discarded. There 
are also some identities we can apply to the rotation equation that can 
simplify it. As it stands, reconstruction of the translation is good 
enough.<br><br>Starting with QuatRotateVector, we can already see that the first multiplication uses <span class="equation">w=0</span>, allowing us to construct a function which removes the necessary terms in its calculation:<br><br><div class="code"><br><span class="keyword">float</span>4 MultiplyPure(<span class="keyword">float</span>4 a, <span class="keyword">float</span>3 b)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> <span class="keyword">float</span>4(a.w * b + cross(b, a.xyz), -dot(a.xyz, b));<br>}<br><br><span class="keyword">float</span>3 QuatRotateVector(<span class="keyword">float</span>4 Qr, <span class="keyword">float</span>3 v)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> Multiply(MultiplyPure(Qr, v), Conjugate(Qr)).xyz;<br>}<br></div><br>The final redundancy is that we're calculating w and throwing it away, leading to:<br><br><div class="code"><br><span class="keyword">float</span>3 MultiplyConjugate3(<span class="keyword">float</span>4 a, <span class="keyword">float</span>4 b)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> b.w * a.xyz - a.w * b.xyz - cross(b.xyz, a.xyz);<br>}<br><span class="keyword">float</span>3 QuatRotateVector(<span class="keyword">float</span>4 Qr, <span class="keyword">float</span>3 v)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> MultiplyConjugate3(MultiplyPure(Qr, v), Qr);<br>}<br></div><br>Realistically,
 the shader compiler should be able to handle all that for you. However,
 it gives us a good starting point to take this further.<br><br><br><h4> We can do better than that </h4><br>Let's
 try to explode the transformation and bring it back to something far 
simpler. I'll work through the steps I took in simplifying this 
explicitly - it serves as a nice record for me and will hopefully help 
if you're trying to understand where the final result came from (I was 
always losing signs during my school days - I'm no better 15 years on!)<br><br>We're trying to simplify:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">P<sub>rot</sub> = Q<span class="equation_sym">&nbsp;</span>(0,V)<span class="equation_sym">&nbsp;</span>Q'</span><br><br>This is a sequence of two quaternion multiplies. Again, quaternion multiplication is defined as:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = (w<sub>0</sub>w1 - V<sub>1</sub><span class="equation_sym">&nbsp;</span>V<sub>2</sub>, w<sub>0</sub>V<sub>1</sub> + w<sub>1</sub>V<sub>0</sub> + V<sub>0</sub>&nbsp;V<sub>1</sub>)</span><br><br>Let's make a few quick substitutions:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">R = Q<sub>xyz</sub></span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">w = Q<sub>w</sub></span><br><br>Expand the first multiplication of quaternion by pure vector first:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = (-R<span class="equation_sym">&nbsp;</span>V) + w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V)(w - R)</span><br><br>Expand the second multiplication:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = (-(R<span class="equation_sym">&nbsp;</span>V))<span class="equation_sym">&nbsp;</span>w &#8722; ((w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V)<span class="equation_sym">&nbsp;</span>(-R)) + (-(R<span class="equation_sym">&nbsp;</span>V))<span class="equation_sym">&nbsp;</span>(-R) + w<span class="equation_sym">&nbsp;</span>(w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V) + (w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V)&nbsp;(-R)</span><br><br>Remove a few brackets to make things a little clearer:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = -R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>w &#8722; (w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V)<span class="equation_sym">&nbsp;</span>-R + -(R<span class="equation_sym">&nbsp;</span>V)<span class="equation_sym">&nbsp;</span>-R + w<span class="equation_sym">&nbsp;</span>(w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V) + (w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V)&nbsp;-R</span><br><br>Simplify by multiplying signs:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = -R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>w + (w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V)<span class="equation_sym">&nbsp;</span>R + R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>R + w<span class="equation_sym">&nbsp;</span>(w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V) - (w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V)&nbsp;R</span><br><br>The dot product distributes over addition so distribute them all:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = -R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>w + R<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V<span class="equation_sym">&nbsp;</span>R + R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>R + w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + w<span class="equation_sym">&nbsp;</span>R&nbsp;V - (w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V)&nbsp;R</span><br><br>The first two terms cancel:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = R&nbsp;V<span class="equation_sym">&nbsp;</span>R + R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>R + w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + w<span class="equation_sym">&nbsp;</span>R&nbsp;V - (w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V)&nbsp;R</span><br><br>Using the identity <span class="equation">A&nbsp;B=-B&nbsp;A</span> swap the last cross product around:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = R&nbsp;V<span class="equation_sym">&nbsp;</span>R + R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>R + w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + w<span class="equation_sym">&nbsp;</span>R&nbsp;V + R&nbsp;(w<span class="equation_sym">&nbsp;</span>V + R&nbsp;V)</span><br><br>The cross product distributes over addition so distribute the last cross product:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = R&nbsp;V<span class="equation_sym">&nbsp;</span>R + R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>R + w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + w<span class="equation_sym">&nbsp;</span>R&nbsp;V + R&nbsp;(w<span class="equation_sym">&nbsp;</span>V) + R&nbsp;(R&nbsp;V)</span><br><br>As we're only interested in the <i>xyz</i> components of the result, discard all scalar terms:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>R + w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + w<span class="equation_sym">&nbsp;</span>R&nbsp;V + R&nbsp;(w<span class="equation_sym">&nbsp;</span>V) + R&nbsp;(R&nbsp;V)</span><br><br>Pull the scalar out of <span class="equation">R&nbsp;(w.V)</span> and sum with its neighbour:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>R + w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + w<span class="equation_sym">&nbsp;</span>R&nbsp;V + w<span class="equation_sym">&nbsp;</span>R&nbsp;V + R&nbsp;(R&nbsp;V)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>R + w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + 2<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>R&nbsp;V + R&nbsp;(R&nbsp;V)</span><br><br>The next bit requires knowledge of the <a href="http://en.wikipedia.org/wiki/Triple_product#Vector_triple_product" target="new">vector triple product</a> (or Lagrange's formula - of many). This takes the form:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">R&nbsp;(R&nbsp;V) = (R<span class="equation_sym">&nbsp;</span>V)R - (R<span class="equation_sym">&nbsp;</span>R)V</span><br><br>If we rearrange that to equal zero then we can add that to the end of our existing equation and play around with it a little:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">R&nbsp;(R&nbsp;V) - (R<span class="equation_sym">&nbsp;</span>V)R + (R<span class="equation_sym">&nbsp;</span>R)V = 0</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>R + w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + 2<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>R&nbsp;V + R&nbsp;(R&nbsp;V) + R&nbsp;(R&nbsp;V) - (R<span class="equation_sym">&nbsp;</span>V)R + (R<span class="equation_sym">&nbsp;</span>R)V</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = R<span class="equation_sym">&nbsp;</span>V<span class="equation_sym">&nbsp;</span>R + w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + 2<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>R&nbsp;V + 2<span class="equation_sym">&nbsp;</span>R&nbsp;(R&nbsp;V) -(R<span class="equation_sym">&nbsp;</span>V)R + (R<span class="equation_sym">&nbsp;</span>R)V</span><br><br>The <span class="equation">R.V.R</span> terms cancel:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Vt = w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + 2<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>R&nbsp;V + 2<span class="equation_sym">&nbsp;</span>R&nbsp;(R&nbsp;V) + (R<span class="equation_sym">&nbsp;</span>R)V</span><br><br>We can now group the scale by <span class="equation">V</span>:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = w<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>V + (R<span class="equation_sym">&nbsp;</span>R)V + 2<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>R&nbsp;V + 2<span class="equation_sym">&nbsp;</span>R&nbsp;(R&nbsp;V)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = (w<span class="equation_sym">&nbsp;</span>w + R<span class="equation_sym">&nbsp;</span>R)V + 2<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>R&nbsp;V + 2<span class="equation_sym">&nbsp;</span>R&nbsp;(R&nbsp;V)</span><br><br>The quaternion norm operation is given by:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">norm(q) = q<sub>w</sub>q<sub>w</sub> + q<sub>x</sub>q<sub>x</sub> + q<sub>y</sub>q<sub>y</sub> + q<sub>z</sub>q<sub>z</sub></span><br><br>Assuming
 we're dealing with unit quaternions, the norm will always be 1. Looking
 above, we can see the norm right at the beginning and can get rid of 
it:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = V + 2<span class="equation_sym">&nbsp;</span>w<span class="equation_sym">&nbsp;</span>R&nbsp;V + 2<span class="equation_sym">&nbsp;</span>R&nbsp;(R&nbsp;V)</span><br><br>Finally, factor the 2:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub>  = V + 2<span class="equation_sym">&nbsp;</span>(w<span class="equation_sym">&nbsp;</span>R&nbsp;V + R&nbsp;(R&nbsp;V))</span><br><br>And factor the cross product:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="equation">Q<sub>0</sub>Q<sub>1</sub> = V + 2<span class="equation_sym">&nbsp;</span>(R&nbsp;(wv + (R&nbsp;V))</span><br><br>This is a delightfully simple result! The HLSL code is:<br><br><div class="code"><br><span class="keyword">float</span>3 QuatRotateVector(<span class="keyword">float</span>4 Qr, <span class="keyword">float</span>3 v)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> v + 2 * cross(Qr.w * v + cross(v, Qr.xyz), Qr.xyz);<br>}<br></div><br><a href="http://localhost/b/?d=2012-07-19-12-52-03#disqus_thread" data-disqus-identifier="2012-07-19-12-52-03">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20120515103623"><a href="javascript:blog_goto('2012-05-15-10-36-23')" class="title">An Implementation of _CIpow</a><br><span class="date">Posted 15 May 2012 10:36:23</span><br><br>The
 game I'm working on is playable in a browser and written in C++. There 
are no installation steps: you just head to the webpage, it syncs the 
latest version and you play. To achieve this I had to build my own C/C++
 CRT implementation, not relying on the countless versions shipped by 
Microsoft in DLL or LIB form that may or may not be on the host machine.
 Given that I want an entire version to be downloaded within a few 
seconds, I've also invested a bit of effort in making the game code as 
compact as possible. At 80k lines of code, my total download currently 
hovers around 200k - which is nice.<br><br>The <a href="http://msdn.microsoft.com/en-us/library/dt5dakze.aspx" target="new">pow</a> function is one of a few standard C runtime functions that the Visual C++ Compiler <a href="http://msdn.microsoft.com/en-us/library/tzkfha43.aspx" target="new">treats differently to others</a>.
 Without specific optimisations enabled, the standard function will be 
called. However, in release builds, it's likely to invoke <a href="http://msdn.microsoft.com/en-us/library/ff770583.aspx" target="new">_CIpow</a>, allowing it to push arguments directly onto the FPU stack with its own custom calling convention.<br><br>For
 fast code, this and many others require implementation if you are 
writing your own CRT. Anybody who writes 4k/64k demos should be familiar
 with this practice. The declaration of _CIpow is:<br><br><div class="code"><br><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(naked) <span class="keyword">void</span> _CIpow()<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// double r = pow(double x, double y)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// st0 = y, st1 = x</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// result left in st0</span><br>}<br></div><br>This
 function has to be naked as the calling convention is custom with no 
exposed compiler support; all parameters are managed on the FPU stack. 
This means that you're playing with fire if you attempt to store local 
variables or call other functions that handle the implementation for 
you. Of course, you could take the inputs, construct your own stack 
frame and call out to an implementation function with inline assembly 
but that just seems like one big waste of time.<br><br>I decided to write an implementation of _CIpow that takes account of:<ul><li> Early outs for exponents of one or zero, or a base of zero with positive exponent.</li><li> Result of 0^0 is 1, as defined in <a href="http://en.wikipedia.org/wiki/IEEE_754-2008" target="new">IEEE 754-2008</a>.</li><li> Early out for negative one exponent with a division.</li><li> Domain error checks to prevent division by zero.</li><li> Negative exponents result in division.</li><li> Negative integer bases properly negate result based on exponent oddness.</li><li> Non-integer negative bases result in domain error.</li></ul>I
 couldn't find anything other than quick/hacky implementations that 
failed to take account of many of the issues above. Given that I'm using
 3rd party libraries and don't want to be caught out by unexpected 
inputs. Error handling wasn't important for now - what was important was
 that any errors in input were handled predictably. As such, I return 
zero in error conditions without setting any form of error flags. I will
 address these issues at a later date.<br><br>To be fair, FPU 
programming for the x87 class of co-processors is tedious - I love 
assembly programming but this somehow grinds on me. However, the FPU has
 some surprisingly robust instructions that can be used for many 
purposes in what I can only guess is a great attempt at saving silicon.<br><br>Implementing a pow function requires expressing <i>r=x^y</i> as <i>r=2^(y.log2(x))</i>, a feat achieved using the <a href="http://siyobik.info.gf/main/reference/instruction/FYL2X" target="new">FYL2X</a>, <a href="http://siyobik.info/main/reference/instruction/F2XM1" target="new">F2XM1</a> and <a href="http://siyobik.info/main/reference/instruction/FSCALE" target="new">FSCALE</a> instructions. My complete implementation, along with detailed explanation of what's going on is below:<br><br><div class="code"><br><span class="keyword">extern</span> <span class="string">"C"</span> __declspec(naked) <span class="keyword">void</span> _CIpow()<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// st0 = y, st1 = x</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;__asm<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// al = negative exponent, ah = negative result from odd negative exponent</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push eax<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push ebx<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov al, 0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov ah, 0<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Check for exponent of 0</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fldz<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fcomip st(0), st(1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne exp_not_0<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Return 1</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fld1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp exit_fn<br><br>&nbsp;&nbsp;&nbsp;&nbsp;exp_not_0:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Check for exponent of 1</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fld1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fcomip st(0), st(1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne exp_not_1<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Return x</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp exit_fn<br><br>&nbsp;&nbsp;&nbsp;&nbsp;exp_not_1:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Do further checks if base is 0</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fldz<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fcomip st(0), st(2)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne base_not_0<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Check for positive exponent</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fldz<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fcomip st(0), st(1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jle exp_less_equal_zero<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Return 0</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fldz<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp exit_fn<br><br>&nbsp;&nbsp;&nbsp;&nbsp;exp_less_equal_zero:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Check for exponent of 0</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fldz<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fcomip st(0), st(1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne exp_less_zero<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// 0^0 defined as 1 in IEE 754-2008</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fld1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp exit_fn<br><br>&nbsp;&nbsp;&nbsp;&nbsp;exp_less_zero:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Domain error if x=0 and y&lt;0 (division by zero), just return 0</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fldz<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp exit_fn<br><br>&nbsp;&nbsp;&nbsp;&nbsp;base_not_0:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Check for exponent of -1</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fld1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fchs<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fcomip st(0), st(1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne exp_not_minus_1<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Return 1/x</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fld1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fdiv<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp exit_fn<br><br>&nbsp;&nbsp;&nbsp;&nbsp;exp_not_minus_1:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Check for negative exponent</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fldz<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fcomip st(0), st(1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jge exp_positive<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Make the exponent positive and record its sign</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fchs<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov al, 1<br><br>&nbsp;&nbsp;&nbsp;&nbsp;exp_positive:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Check for negative base</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fldz<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fcomip st(0), st(2)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jge base_positive<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Check to see if the exponent is an integer</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fld st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frndint<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fcomip st(0), st(1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;je exp_integer<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Domain error with negative base and non-integer exponent, just return 0</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fldz<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp exit_fn<br><br>&nbsp;&nbsp;&nbsp;&nbsp;exp_integer:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Negate final result based on oddness of exponent</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub esp, 4<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fist <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov ah, <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and ah, 1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add esp, 4<br><br>&nbsp;&nbsp;&nbsp;&nbsp;base_positive:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Calculating:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    r = x^y</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Construct logarithm equivalent:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    log.x(r) = y</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Change to base 2:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    log2(r)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    ------- = y</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    log2(x)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Re-arrange to make r the dependent:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    log2(r) = y.log2(x)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Invert the dependent logarithm:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    r = 2^(y.log2(x))</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// st0 = y.log2(x)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fxch<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fyl2x<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Assuming the result is in R, now need to calculate 2^R</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// The f2xm1 instruction will do this with values in the range [-1,1]:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    f2xm1 = 2^st0 - 1</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// R needs to be split into its integer and fractional parts to allow use of this instruction:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    2^R = 2^(int(r) + frac(r)) = 2^int(R) . 2^frac(R)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// And then finally, fscale can be used to calculate 2^int(R) and multiply by the result of f2xm1</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// st0 = frac(R), st1 = int(R)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fld st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frndint<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fsub st(1), st(0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fxch<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// st0 = 2^frac(R)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f2xm1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fld1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fadd<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// st0 = st0.2^int(R)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fscale<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Leave result on the top of the FP stack</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fwait<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fstp st(1)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Negative exponent is a division</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp al, 1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne exp_positive_2<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fld1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fdiv<br>&nbsp;&nbsp;&nbsp;&nbsp;exp_positive_2:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Use oddness of negative exponent to determine final sign</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp ah, 1<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne neg_base_even<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fchs<br>&nbsp;&nbsp;&nbsp;&nbsp;neg_base_even:<br><br>&nbsp;&nbsp;&nbsp;&nbsp;exit_fn:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop ebx<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop eax<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br>The
 latest Visual C compilers contain SSE implementations of this function 
which are faster but lower precision. As I'm working with physics at a 
planetary scale, I'm erring on the side of accuracy over performance at 
this early stage. However, it's much more enjoyable to work with SSE so I
 will definitely revisit this later (at which point I'll probably be 
more interested in <a href="http://www.dctsystems.co.uk/Software/power.html" target="new">approximations</a>).<br><br>My
 journey with this kind of code has been a long one with many surprising
 detours (sprintf was a monster). At some point I'd like to open source 
the small CRT I've written, along with the browser technology. Hopefully
 I'll have the time to clean it up at a later point.<br><br><a href="http://localhost/b/?d=2012-05-15-10-36-23#disqus_thread" data-disqus-identifier="2012-05-15-10-36-23">2 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20120411225623"><a href="javascript:blog_goto('2012-04-11-22-56-23')" class="title">Risk, Prototypes and Planetary Bodies</a><br><span class="date">Posted 11 April 2012 22:56:23</span><br><br>Last
 month quietly welcomed the completion of my game/platform prototype: 8 
months in the making! I'm only a few months away from an announcement 
for what I'm working on but it's worth taking a step back and looking at
 that figure for a minute.<br><br>It's taken me 8 months to build... a "prototype."<br><br>This
 is quite obviously not your standard prototype, but a complete 
implementation of the backbone of the game, demonstrating that it's 
technically feasible, achievable with my limited resources and fun to 
play. I've had some interesting reactions to this:<ul><li> I'm still not
 ready to show it to people close to me, although I'm more comfortable 
talking about what it is. While the concept works, developing it has 
given me a few ideas that I want to adjust/add first.</li><li> I took 2 
weeks out to throw away all my heightfield rendering and collision code 
to make a hugely sweeping change: the world is now a spherical planet 
with deep caves, overhangs and some incredibly interesting world 
generation functions. While the impact of change will still be felt 2 
months from now (the physics is tricky, populating it is tricky), the 
result is beautiful. Oh, it's also deformable, as in: you can blow huge 
chunks out of the planet, if you like! Whether this will make it into 
the game design is yet to be seen, but it was trivial to add once I had 
the basics.</li><li> I've become a lot more confident in my own ability 
to ship a beta without bringing anybody else onboard. This sounds pretty
 crazy and I would rather have an art director help me out, but finding 
somebody in a similar situation to my own is tough.</li><li> The 
schedule is extended and I'm considering spending more of my money on 
making the game. However, the realisation that I need to get something 
out there this year still remains. If anything, the realisation is 
heightened.</li><li> I have no real attachment to my distribution 
platform of choice (Web-based, native C++ gameplay and Javascript 
client). I will literally use anything as long as it doesn't get in my 
way.</li></ul>I think what I'll do is some kind of slow reveal of what 
the project is. I have a complete visual history of the development of 
the game and I reckon slowly showing the screenshots would be fun.<br><br><h4> A bit of fun </h4><br>Last
 thursday night I decided to hang around at work and implement a live 
editing environment for Notch's DCPU-16 program, for Mojang's game <a href="http://0x10c.com/doc/dcpu-16.txt" target="new">0x10c</a>.
 I stayed until about 6am the next day - something I haven't done in 
years (I used to work 36 hour stretches in 120 hour weeks back when I 
was a bit greener). The result is <a href="http://t.co/2MvNTRvi" target="new">here</a>.<br><br>This
 was immensely fun to work on - I've made a few fixes but not really 
worked on it too much. However, the temptation is there to make it a 
much nicer environment to work in. The internets seem to have <a href="https://github.com/blog/1098-take-over-the-galaxy-with-github" target="new">reacted</a> <a href="https://twitter.com/#%21/C418/status/190010024330936320" target="new">positively</a> to it and it's been pretty amazing to see how people have used it.<br><br>Part
 of me believes I should be working like that for my own game, but the 
experienced guy inside me realises I'd burn out in a few weeks. I'm in 
this for the long haul :)<br><br><a href="http://localhost/b/?d=2012-04-11-22-56-23#disqus_thread" data-disqus-identifier="2012-04-11-22-56-23">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20120308130000"><br><a href="javascript:blog_goto('2012-03-08-13-00-00')" class="title">Cross-browser, Native/Remote D3D Rendering with C++</a><br><span class="date">Posted 08 March 2012 13:00:00</span><br><br>As
 my little game project builds steam and I become more confident that it
 will actually work, it's becoming easier for me to talk about the 
various problems I've had to tackle.<br><br>A little background on my 
setup will probably help here. I have two main programs to write: the 
client and server. The client is a webpage, written primarily in 
Javascript and the server is your typical CPU/GPU-intensive game program
 written in C++.<br><br>For now, the two communicate via a custom <a href="javascript:blog_goto('clReflect')">clReflect</a>-based
 protocol over the TCP/IP stack (localhost). This allows me to iterate 
on one or the other without taking the other down and makes debugging 
far easier. Mainly, it avoids the pain of embedding every single bit of 
my code behind the JNI wall of doom that loves to crash itself out of 
existence without leaving trace of what your code did wrong. At a later 
date, I may go into the pain I've had trying to get (and failing) the 
JVM to release applet references so that I could reload my code on the 
fly.<br><br>The final shipping version will not do that as it's a big 
security hole and requires the user to allow the communication via their
 firewall when they first run the application. Not a good first 
impression.<br><br><br><h4> How does Minecraft do this? </h4><br>Under the hud, one of the great things about <a href="http://www.minecraft.net/" target="new">Minecraft</a> is that it uses the native C++ library <a href="http://jogamp.org/jogl/www/" target="new">JOGL</a>
 to use the OpenGL API for its rendering. This is a very practical, 
cross-browser/platform means of getting great visuals for a game in your
 browser. <br><br>JOGL has various ports for Windows, Mac OSX and Linux 
but I'll only talk about Windows here. The first task it needs to 
achieve is initialising an OpenGL context with a window handle, 
typically:<br><br><div class="code"><br><span class="comment">// Get window handle and device context from somewhere</span><br>HWND hWnd = ...;<br>HDC hDC = GetDC(hWnd);<br><br><span class="comment">// Initialise a pixel format</span><br>PIXELFORMATDESCRIPTOR pfd;<br>...<br>...<br><br><span class="comment">// Set on the device context</span><br>int format = ChoosePixelFormat(hDC, &amp;pfd);<br>SetPixelFormat(hDC, format, &amp;pdf);<br><br><span class="comment">// Create the render context</span><br>HGLRC wglCreateContext(hDC);<br></div><br>The
 basic requirement of having a window handle for display is similar to 
D3D. For this post, I'm going to reference D3D9 as that is what I'm most
 comfortable with:<br><br><div class="code"><br><span class="comment">// Create the D3D object</span><br>IDirect3D9* d3d = Direct3DCreate(D3D_SDK_VERSION);<br><br><span class="comment">// Create a D3D device using a window handle from somewhere</span><br>D3DPRESENT_PARAMETERS d3dpp;<br>d3dpp.hDeviceWindow = ...;<br>...<br>...<br>IDirect3D9* device = 0;<br>d3d-&gt;CreateDevice(D3DADAPTER_DEFAULT, D3DDEVTYPE_HAL, 0, D3DCREATE_HARDWARE_VERTEXPROCESSING, &amp;d3dpp, &amp;device);<br></div><br>Alternatively, with D3D, you can specify the window handle at a later point in the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb174423%28v=vs.85%29.aspx" target="new">Present</a> call, instead of binding it to the device at such an early point (allowing you to target multiple windows easily).<br><br>So where does the window handle come from?<br><br>You start by embedding a Java applet in your browser and compiling your render code to a DLL using some <a href="http://docs.oracle.com/javase/1.5.0/docs/guide/jni/" target="new">Java JNI</a>
 entry-points. To load native code, your Java applet must also be 
signed. How you load native code in an applet and sign it is beyond the 
scope of this article but here are some links which you may find useful:<ul><li> <a href="http://profs.etsmtl.ca/mmcguffin/learn/java/" target="new">Java Applet Tutorial</a></li><li> <a href="http://vkessels.home.xs4all.nl/articles/jnijarapplet.html" target="new">JNI + JAR + Applet</a></li><li> <a href="http://drdobbs.com/184401335" target="new">JNI-C++ Integration Made Easy</a> on Dr. Dobb's.</li><li> <a href="http://www-personal.umich.edu/%7Elsiden/tutorials/signed-applet/signed-applet.html" target="new">Signed Applet Tutorial</a></li></ul>Assuming you have an applet setup and a <a href="http://docs.oracle.com/javase/1.4.2/docs/api/java/awt/Canvas.html" target="new">canvas</a>
 created over the applet (applets themselves are canvases), you need to 
get the native window handle of the applet and pass it over to the 
rendering code.<br><br>This can be done quite simply using the little <a href="http://download.oracle.com/javase/1.3/docs/guide/awt/AWT_Native_Interface.html" target="new">AWT Native Interface</a> library (JAWT). This has implementations for each platform but on Windows, allows you to get a window handle by doing:<br><br><div class="code"><br><span class="comment">// JNI &amp; JAWT headers</span><br> <span class="keyword">#include</span> &lt;jni.h&gt;<br><span class="keyword">#include</span> &lt;jawt.h&gt;<br><span class="keyword">#include</span> &lt;jawt_md.h&gt;<br><br><span class="keyword">extern</span> <span class="string">"C"</span> JNIEXPORT <span class="keyword">void</span> JNICALL Java_NativeGame_InitRendering(JNIEnv* env, jobject, jobject canvas)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get the AWT</span><br>&nbsp;&nbsp;&nbsp;&nbsp;JAWT jawt;<br>&nbsp;&nbsp;&nbsp;&nbsp;jawt.version = JAWT_VERSION_1_4;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (JAWT_GetAWT(env, &amp;jawt) == JNI_FALSE)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> 0;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get the drawing surface</span><br>&nbsp;&nbsp;&nbsp;&nbsp;JAWT_DrawingSurface* ds = jawt.GetDrawingSurface(env, canvas);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (ds == 0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> 0;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Lock the drawing surface</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> ((ds-&gt;Lock(ds) &amp; JAWT_LOCK_ERROR) != 0)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jawt.FreeDrawingSurface(ds);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get the drawing surface info</span><br>&nbsp;&nbsp;&nbsp;&nbsp;JAWT_DrawingSurfaceInfo* dsi = ds-&gt;GetDrawingSurfaceInfo(ds);<br>&nbsp;&nbsp;&nbsp;&nbsp;JAWT_Win32DrawingSurfaceInfo* dsi_win = (JAWT_Win32DrawingSurfaceInfo*)dsi-&gt;platformInfo;<br>&nbsp;&nbsp;&nbsp;&nbsp;HWND hwnd = dsi_win-&gt;hwnd;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Release all resources</span><br>&nbsp;&nbsp;&nbsp;&nbsp;ds-&gt;FreeDrawingSurfaceInfo(dsi);<br>&nbsp;&nbsp;&nbsp;&nbsp;ds-&gt;Unlock(ds);<br>&nbsp;&nbsp;&nbsp;&nbsp;jawt.FreeDrawingSurface(ds);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Pass HWND onto your rendering initialisation code...</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>}<br></div><br>Your Java applet would call this on initialise and call your render function whenever it receives a <a href="http://docs.oracle.com/javase/1.4.2/docs/api/java/awt/Canvas.html#paint%28java.awt.Graphics%29" target="new">paint</a> request.<br><br>This technique is used by a few other libraries:<ul><li> <a href="http://www.lwjgl.org/" target="new">LWJGL</a></li><li> <a href="http://code.google.com/p/jebgl/" target="new">JebGL</a></li><li> <a href="http://code.google.com/p/directx4java/" target="new">DirectX4Java</a></li><li> <a href="http://sourceforge.net/projects/java-direct3d/" target="new">Java-Direct3D wrapper</a></li></ul>In
 Minecraft's case, OpenGL calls are generated on the JVM-side and 
shuffled over to C++ by JOGL at a pretty low level. Your level of 
abstraction is entirely up to you but security, above all, must be a 
primary concern.<br><br><br><h4> Interaction with Overlayed Browser Elements </h4><br>One
 thing Minecraft didn't have to deal with was overlaying HTML elements 
on the applet. I need to do this for drop-down menus, pop-ups and 
drag-and-drop items. If you attempt to drag a HTML element over one of 
these applet windows then the behaviour will be different based on what 
browser you're using. Consistently, Firefox is the only browser that 
works to any acceptable degree. Chrome will render the applet on top of 
whatever HTML element you choose and will sometimes flash like crazy.<br><br>This
 has been a well-known problem for many years and there is one solution 
that works very well across the 3 main browsers, however finding 
descriptions of it has been tough. I have a few references but there is 
only which is any good and that can only be accessed on the Wayback 
Machine:<ul><li> <a href="http://web.archive.org/web/20110707212850/http://www.oratransplant.nl/2007/10/26/using-iframe-shim-to-partly-cover-a-java-applet/" target="new">Using IFrame Shim to (partly) cover a Java applet</a></li></ul>The
 basic idea is that whenever you create an element that may cover your 
applet window, you create an iframe element on the fly, attach it to 
document.body and make sure it covers the region occupied by your 
element. My code for doing that is:<br><br><div class="code"><br>function CreateShimmer(parent)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;var shimmer = document.createElement(<span class="string">"iframe"</span>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Position the shimmer so that it's the same location/size as its parent</span><br>&nbsp;&nbsp;&nbsp;&nbsp;shimmer.style.position = <span class="string">"fixed"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;shimmer.style.left = parent.style.left;<br>&nbsp;&nbsp;&nbsp;&nbsp;shimmer.style.top = parent.style.top;<br>&nbsp;&nbsp;&nbsp;&nbsp;shimmer.style.width = parent.offsetWidth;<br>&nbsp;&nbsp;&nbsp;&nbsp;shimmer.style.height = parent.offsetHeight;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// We want the shimmer to be one level below its contents</span><br>&nbsp;&nbsp;&nbsp;&nbsp;shimmer.style.zIndex = parent.style.zIndex - 1;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Ensure it's empty</span><br>&nbsp;&nbsp;&nbsp;&nbsp;shimmer.setAttribute(<span class="string">"frameborder"</span>, <span class="string">"0"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;shimmer.setAttribute(<span class="string">"src"</span>, <span class="string">""</span>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Add to the document and the parent</span><br>&nbsp;&nbsp;&nbsp;&nbsp;document.body.appendChild(shimmer);<br>&nbsp;&nbsp;&nbsp;&nbsp;parent.Shimmer = shimmer;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> shimmer;<br>}<br></div><br>This works really well across Firefox, Chrome and Internet Explorer but there are a couple of problems:<ul><li>
 If you can drag your HTML elements across an applet, trails of the 
applet background colour will be left behind. You can minimise this by 
overloading the <a href="http://docs.oracle.com/javase/1.4.2/docs/api/java/awt/Canvas.html#update%28java.awt.Graphics%29" target="new">update</a>
 method of your canvas to not call clear, however the iframe 
interfaction still seems to blitz anything behind it to the background 
colour with no evident Java means of stopping it. You can make this look
 a little better by setting your applet background to a similar colour 
to your element. Setting the iframe to transparent doesn't do anything.</li><li>
 You will lose certain elements of CSS3 rendering based on what browser 
you use. The only way to solve this is to avoid the use of stuff like <a href="https://developer.mozilla.org/en/CSS/border-radius" target="new">border-radius</a> and <a href="https://developer.mozilla.org/en/CSS/box-shadow" target="new">box-shadow</a>.
 Experiment with what you can use a little; the situation may improve in
 the future as these are still early implementations of the standard 
(I'm guessing the problem may be on the Java implementation side).</li></ul><center><a href="" class="image"><img src=""></a> vs. <a href="" class="image"><img src=""></a></center><br>iframe
 was actually removed from the Strict HTML and XHTML standards but is 
back with HTML5. Desktop browsers have consistently supported them for 
many years and there seems no reason for them to be dropped any time 
soon.<br><br><br><h4> Remote Process Rendering </h4><br>So this is nice 
and all, but given that my native application is remote and communicates
 with a thin JNI layer via TCP/IP, it's of no use to me in this form.<br><br>Way
 back in 2002 I was working on some really cool rendering technology 
that didn't have an accompanying editor so all levels/content were 
constructed in <a href="http://www.newtek.com/lightwave.html" target="new">Lightwave Layout</a>.
 We wanted realtime feedback from the engine in the editor but Lightwave
 had a poor record of making any updates to their Plugin API. At one 
point we were promised improved API developments specifically for game 
developers, including a viewport we could render to (not to mention a 
skinning algorithm that was actually documented). I believe Maya and MAX
 have had support for such viewports for a long time and I've been so 
happy not work with the Lightwave API that I've not dared look back 
since.<br><br>We gave up waiting and tried something nefarious. In our 
plugins, we launched the engine on a separate process, searched for the 
Lightwave window handle using <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms633497%28v=vs.85%29.aspx" target="new">EnumWindows</a>
 and manually enumerated all the child windows until we found the 
viewport we wanted to render into. We then passed its handle onto the 
engine executable which proceeded to render into it.<br><br>It worked! 
As long as we weren't fighting Lightwave for the viewport, this worked 
amazingly well. I believe the scenarios where Lightwave would render 
into said viewport became too hard for us to control so we ended up just
 spawning a separate window to get our real-time feedback.<br><br>However, I reused the same technique with success for some of the <a href="http://altdevblogaday.com/2012/01/03/reflection-in-c-part-2-the-simple-implementation-of-splinter-cell/" target="new">Splinter Cell tools</a> back in 2005 and was wondering if it still worked on Windows 7...<br><br>It did!<br><br>So
 for a while my JNI code would pass the window handle of the Java applet
 over the TCP/IP connection and the server would happily render into it.
 While this is great for quick tools and a proof of concept, it has some
 drawbacks:<ul><li> This is not likely to be a concept that works on all
 platforms and is entirely unsupported by Microsoft, despite it working 
for the last 10 years or so.</li><li> All the hard work put into 
creating an iframe shim and making HTML elements smoothly move across 
your applet is undone by the fact that the AWT GUI rendering thread in 
the applet will be fighting with the rendering thread on the server. The
 distracting background flashes return.</li></ul>Making the applet run 
in lock-step with the server would introduce unnecessary complexity and 
failure points that I was unhappy with and still wouldn't address the 
first issue so I needed another solution.<br><br><br><h4> Memory Mapped Files </h4><br>I
 had to create a means of getting the server frame buffer over to the 
applet and let the applet render in its AWT GUI thread via paint(). The 
first step is to get the frame buffer data on the server and that 
required the use of <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb174405%28v=vs.85%29.aspx" target="new">GetRenderTargetData</a>.
 On D3D9 it is not clear whether this is an async process. There are 
indications that it merely puts the request into the command buffer and 
any subsequent calls into the device block until the data is transferred
 to the CPU, implying that you have to do some useful CPU work while 
that is going on.<br><br>So rather than calling Present at the end of 
your frame, Ignacio Castao describes a stable technique for getting 
async behavior with GetRenderTargetData over on <a href="http://the-witness.net/news/2010/09/hemicube-rendering-and-integration/" target="new">The Witness blog</a>.
 This works well for me but be aware that it introduces extra latency to
 the visual feedback of the game. Alternatively, you could switch to the
 latest D3D to get this behaviour, which is something I'm in the process
 of doing.<br><br>The next step is to create a fast means of 
transferring that data from the server to the client JNI layer. A TCP/IP
 transfer, while easy, is out of the question as it will break your data
 up and introduce all manner of performance issues preventing this from 
being practical.<br><br><a href="http://msdn.microsoft.com/en-us/library/dd997372.aspx" target="new">Memory mapped files</a>
 are the perfect IPC mechanism to achieve this on Windows and there are 
equivalents (or fallbacks) on other platforms. I created a very simple 
shared memory class that used a view on the system page file to 
continually keep some frame buffer memory mapped, similar to:<br><br><div class="code"><br>core::SharedMemBlock::~SharedMemBlock()<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;UnmapViewOfFile(m_Buffer);<br>&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(m_FileMappingHandle);<br>}<br><br><span class="keyword">void</span> core::SharedMemBlock::InitServer(<span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">unsigned</span> <span class="keyword">int</span> buffer_size)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Create a pagefile-mapped file object </span><br>&nbsp;&nbsp;&nbsp;&nbsp;m_FileMappingHandle = CreateFileMappingA(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INVALID_HANDLE_VALUE,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PAGE_READWRITE,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_size,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Map a view of the entire file into memory</span><br>&nbsp;&nbsp;&nbsp;&nbsp;m_Buffer = MapViewOfFile(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_FileMappingHandle,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_MAP_ALL_ACCESS,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_size);<br>}<br><br><span class="keyword">void</span> core::SharedMemBlock::InitClient(<span class="keyword">const</span> <span class="keyword">char</span>* name, <span class="keyword">unsigned</span> <span class="keyword">int</span> buffer_size)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Open an existing mapped file</span><br>&nbsp;&nbsp;&nbsp;&nbsp;m_FileMappingHandle = OpenFileMappingA(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_MAP_ALL_ACCESS,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FALSE,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Map a view of the entire file into memory</span><br>&nbsp;&nbsp;&nbsp;&nbsp;m_Buffer = MapViewOfFile(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_FileMappingHandle,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_MAP_ALL_ACCESS,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer_size);<br>}<br></div><br>Each
 frame, the server would lock the offscreen plain surface that held the 
frame buffer and memcpy the data into one of these buffers. The JNI C++ 
client could then happily read the frame buffer whenever it needed to.<br><br>On the Java applet side, this meant the rendering code looked similar to:<br><br><div class="code"><br><span class="keyword">public</span> <span class="keyword">class</span> extends Applet implements Runnable<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// JNI DLL loader with auto-imported C++ functions</span><br>&nbsp;&nbsp;&nbsp;&nbsp;NativeGame m_NativeGame;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Create a drawable image and get direct access to the pixel data</span><br>&nbsp;&nbsp;&nbsp;&nbsp;BufferedImage m_FrameBuffer = <span class="keyword">new</span> BufferedImage(800, 600, BufferedImage.TYPE_INT_ARGB);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>[] m_Pixels = ((DataBufferInt)m_FrameBuffer.getRaster().getDataBuffer()).getData();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;Thread m_UpdateThread;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span> <span class="keyword">void</span> start()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;enableEvents(AWTEvent.KEY_EVENT_MASK
 | AWTEvent.MOUSE_EVENT_MASK | AWTEvent.MOUSE_MOTION_EVENT_MASK);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Create an update thread, separate to the applet thread (typical Java applet animation approach)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_UpdateThread = <span class="keyword">new</span> Thread(<span class="keyword">this</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_UpdateThread.start();<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span> <span class="keyword">void</span> stop()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_UpdateThread = null;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span> <span class="keyword">void</span> run()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Perform JNI init on the update thread</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_NativeGame = <span class="keyword">new</span> NativeGame();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span> (Thread.currentThread() == m_UpdateThread)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Do lots of network updates between server/client</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Request a paint on the AWT GUI thread and sleep for a while</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// This effectively gives us our input latency to the server</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;repaint();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span> { Thread.sleep(10); } <span class="keyword">catch</span> (InterruptedException e) { }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">public</span> <span class="keyword">void</span> paint(Graphics g)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// The main paint function, called from the AWT GUI thread in these scenarios:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    1. Implementing this prevents the horrible Java logo displaying while the applet initialises.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    2. Whenever windows/elements obscure part of the applet, requiring a partial rebuild of the image.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    3. When the browser window is moved or resized.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//    4. When the update thread schedules a paint with a call to repaint().</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_NativeGame.CopyFrameBuffer(m_Pixels);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g.drawImage(m_FrameBuffer, 0, 0, null);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>};<br></div><br>The function CopyFrameBuffer is a JNI C++ function that looks like:<br><br><div class="code"><br><span class="keyword">extern</span> <span class="string">"C"</span> JNIEXPORT <span class="keyword">void</span> JNICALL Java_NativeGame_CopyFrameBuffer(JNIEnv* env, jobject, jintArray dest)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// This function gets called from the AWT GUI thread, which implies potential contention with the other</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// JNI functions which get called from the update thread. Be careful here and lock if necessary.</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//</span><br>&nbsp;&nbsp;&nbsp;&nbsp;jint* frame_buffer = (jint*)g_MemoryMappedFile-&gt;GetBuffer();<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (frame_buffer != 0)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Copy the frame buffer data</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jint dst_size = env-&gt;GetArrayLength(dest);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (dst_size == g_MemoryMappedFile-&gt;GetSize())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env-&gt;SetIntArrayRegion(dest,
 0, dst_size, frame_buffer);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br>You
 need to make sure here that you are protected against the incoming byte
 buffer and source memory mapped file being of different sizes.<br><br>So we have a several transfers of the frame buffer data going on here:<ul><li> GPU to CPU with GetRenderTargetData.</li><li> memcpy from the offscreen plain surface to the memory mapped file.</li><li> memcpy from the memory mapped file into the BufferedImage pixels.</li><li> Whatever rendering mechanism Java uses to render a BufferedImage to the canvas.</li></ul>Even
 with that, I'm not feeling any measurable latency with my kind-of 
twitchy gameplay. You can remove a memcpy using the D3D9Ex feature of 
specifying ahead of time where the memory for an offscreen plain surface
 resides. See this section on <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb219800%28v=vs.85%29.aspx" target="new">Texture Creation in System Memory</a>.<br><br><br><h4> Taking this to its Final Conclusion </h4><br>A
 ideal step now would be to transfer the final frame buffer back to 
Javascript so that it can be used directly with WebGL or a HTML5 Canvas 
2D context. This would fix all of the CSS rendering issues and give 
trail-free HTML drag-and-drop elements.<br><br>However, there are a few problems currently preventing that:<ul><li> Communication between Java and Javascript, achieved using <a href="https://developer.mozilla.org/en/JavaScript/Guide/LiveConnect_Overview" target="new">LiveConnect</a>
 is marshalled at a very high-level. There is no means of sending 
arbitrary binary data between the two languages beyond arrays or strings
 and access to these is painfully slow.</li><li> Modifying canvas pixel 
data on the Javascript side is very slow currently. You can get nice 
looking, small window stuff up and running but there is a lack of 
support for the new <a href="https://developer.mozilla.org/en/JavaScript_typed_arrays" target="new">Javascript Typed Arrays</a>
 required to accelerate everything. Not to mention the performance of 
the individual interpreters which may or may not JIT your code 
on-the-fly.</li></ul>I tried for hours to get something practical. While
 the results looked great, they were very slow with different 
performance problems across all browsers. It's early days, yet and this 
may get better.<br><br><a href="http://localhost/b/?d=2012-03-08-13-00-00#disqus_thread" data-disqus-identifier="2012-03-08-13-00-00">2 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20120207113723"><a href="javascript:blog_goto('2012-02-07-11-37-23')" class="title">An RPC Debugging Workflow with Visual Studio</a><br><span class="date">Posted 07 February 2012 11:37:23</span><br><br>I love <a href="http://www.sublimetext.com/2" target="new">Sublime Text 2</a>.
 For me, it does nearly everything a modern C++ code editing platform 
should do and is constantly moving in a direction that is pleasing to 
the soul. I've worked with Visual Studio since 1998 for editing my C++ 
code, and I don't like it. It gets slower year on year, adds many 
features which are useless to your average game developer and 
consistently ignores our needs as a community.<br><br><a href="http://channel9.msdn.com/achievements/visualstudio" target="new">This</a>. This is nonsense. I can't say any more on the issue because I despair just thinking about it.<br><br><br><h4> My Setup </h4><br>Depsite all that, the Visual Studio debugger is still pretty damned good and very hard to beat. <a href="http://msdn.microsoft.com/en-us/windows/hardware/gg463009" target="new">WinDbg</a>
 is much more powerful and, at times, more stable, but its interface and
 learning curve is a little too obtuse for me. I use it mainly as a 
crash dump inspection tool for post-mortem debugging.<br><br>I use 
Sublime Text 2 to edit all my code in the many different languages my 
game uses, with Visual Studio to debug. On top of that, the game's user 
interface communicates with the game executable via a network RPC layer.
 The non-dev version will use a custom, more tightly controlled 
transport layer for security and accessibility reasons. Why I'm doing 
this is not important now and will become apparent at a later date (but I
 promise to document it).<br><br>So I have a typical client/server setup:<ul><li> Client launches, issues a server launch request and waits.</li><li> Server launches and waits for a connection.</li><li> Client wakes up after server launch and opens a connection to the server.</li><li> Server accepts connection and enters the main loop.</li></ul>The
 client is a thin client with no real logic or state attached to it. It 
is directly responsible for launching the server executable and, as 
such, I needed a means of attaching to the server as soon as it's 
launched.<br><br><br><h4> A Macro for Attaching to any Process </h4><br>The simplest of solutions is to select <i>Debug|Attach to Process...</i> in Visual Studio, find your process and click <i>Attach</i>:<br><br><center><a href="http://www.flickr.com/photos/donw/6835176511/" target="new"><img src=""></a></center><br>I'm
 sure many of you know this dialogue box intimately - a required tool 
when a certain, unnamed console stubbornly refuses to launch with the 
debugger attached.<br><br>This easily isn't good enough: it's too slow 
and there's too much to find/remember. To address the problem, I wrote a
 Visual Studio Macro that automates the process of finding the game 
process and attaching to it:<br><br><div class="code"><br>Sub AttachToGame()<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> output_window <span class="keyword">As</span> OutputWindow = DTE.ToolWindows.OutputWindow<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> output_window_pane <span class="keyword">As</span> OutputWindowPane = output_window.OutputWindowPanes.Item(<span class="string">"Debug"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;output_window_pane.Activate()<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">' Figure out the computer name</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> computer_name <span class="keyword">As</span> String = WindowsIdentity.GetCurrent().Name<br>&nbsp;&nbsp;&nbsp;&nbsp;computer_name = computer_name.Substring(0, computer_name.IndexOf(<span class="string">"\"</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;output_window_pane.OutputString(<span class="string">"Computer name: "</span> &amp; computer_name &amp; vbCrLf)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">' Get the debugger</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> debugger <span class="keyword">As</span> EnvDTE80.Debugger2 = DTE.Debugger<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> transport <span class="keyword">As</span> EnvDTE80.Transport = debugger.Transports.Item(<span class="string">"Default"</span>)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">' Setup a half-second timeout, checking every 10ms</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> attempts = 0<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> sleep_ms = 10<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> max_attempts = 500 / sleep_ms<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">' Loop waiting for Game.exe to launch</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> game_process <span class="keyword">As</span> EnvDTE80.Process2<br>&nbsp;&nbsp;&nbsp;&nbsp;output_window_pane.OutputString(<span class="string">"Trying to locate Game.exe..."</span> &amp; vbCrLf)<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">While</span> game_process <span class="keyword">Is</span> Nothing <span class="keyword">And</span> attempts &lt; max_attempts<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">' Snapshot the running process list and search for the game</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> processes <span class="keyword">As</span> EnvDTE.Processes = debugger.GetProcesses(transport, computer_name)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Try</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    game_process = processes.Item(<span class="string">"game.exe"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Catch</span> ex <span class="keyword">As</span> Exception<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">End</span> <span class="keyword">Try</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Threading.Thread.Sleep(sleep_ms)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attempts += 1<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">End</span> <span class="keyword">While</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">' Give up if game.exe can't be found</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">If</span> game_process <span class="keyword">Is</span> Nothing Then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_window_pane.OutputString(<span class="string">"   not found"</span> &amp; vbCrLf)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">End</span> <span class="keyword">If</span><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">' Attach the debugger!</span><br>&nbsp;&nbsp;&nbsp;&nbsp;game_process.Attach2()<br><br><span class="keyword">End</span> Sub<br></div><br>Double-clicking
 on this through the macro explorer will quickly locate the game (or 
give up if it's not there) and put you in the debugger.<br><br><br><h4> What about Game Startup? </h4><br>After
 launching the game, it takes a few seconds to focus Visual Studio and 
double-click on the macro. By this point, all your game initialisation 
code has happened which probably skips some of the most important code 
you've written.<br><br>This is solved pretty simply by adding a 
sync-point with command-lines. I have a check-box in the client that 
gets sent to the server on launch, instructing it to wait for a debugger
 to attach. Launching the game is done with the Win32 API:<br><br><div class="code"><br><span class="keyword">void</span> RunProcess(<span class="keyword">const</span> <span class="keyword">char</span>* filename, <span class="keyword">bool</span> wait_for_debugger)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Arguments must be constructed with the EXE filename first</span><br>&nbsp;&nbsp;&nbsp;&nbsp;core::String arguments(filename);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (wait_for_debugger)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arguments += <span class="string">" -wait_for_debugger"</span>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Launch the process and release any handles</span><br>&nbsp;&nbsp;&nbsp;&nbsp;STARTUPINFOA si;<br>&nbsp;&nbsp;&nbsp;&nbsp;memset(&amp;si, 0, <span class="keyword">sizeof</span>(si));<br>&nbsp;&nbsp;&nbsp;&nbsp;si.cb = <span class="keyword">sizeof</span>(si);<br>&nbsp;&nbsp;&nbsp;&nbsp;PROCESS_INFORMATION pi;<br>&nbsp;&nbsp;&nbsp;&nbsp;memset(&amp;pi, 0, <span class="keyword">sizeof</span>(pi));<br>&nbsp;&nbsp;&nbsp;&nbsp;CreateProcessA(filename, arguments.data(), 0, 0, FALSE, 0, 0, 0, &amp;si, &amp;pi);<br>&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(pi.hThread);<br>&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(pi.hProcess);<br>}<br></div><br>Meanwhile, in WinMain on the server side, the first thing it does is check the command-line for the instruction to wait:<br><br><div class="code"><br><span class="keyword">int</span> WINAPI CALLBACK WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="keyword">int</span> nShowCmd)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Wait for the debugger to attach, if requested</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (strstr(lpCmdLine, <span class="string">"-wait_for_debugger"</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;core::LogText(<span class="string">"Waiting for debugger to attach...\n"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span> (!IsDebuggerPresent())<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sleep(1);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></div><br>This nicely syncs everything up so that I don't miss any breakpoints in my initialisation code.<br><br><br><h4> A Slice of COM Automation to Complete the Puzzle </h4><br>I worked like this for a few months. With the debugger, my iteration was:<ul><li> If I don't need to debug, uncheck "Wait for Debugger" and iterate.</li><li> Otherwise, check "Wait for Debugger" and restart the client.</li><li> Switch to Visual Studio window and double-click "AttachToGame".</li></ul>It
 works quite well but I was losing seconds between steps 2 and 3 each 
time that would break my flow and mostly irritate me. If I could find 
some way of remotely instructing Visual Studio to attach after I'd 
launched the game, life would be good.<br><br>The entire Visual Studio 
automation object model is implemented with COM and you can get access 
to many live (registered) COM objects through the use of <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms221467%28v=vs.85%29.aspx" target="new">GetActiveObject</a>.
 Languages such as VBScript and C# hide an awful lot of boiler-plate COM
 nastiness for you and you can write some VBScript using the <a href="http://technet.microsoft.com/en-us/library/ee156607.aspx" target="new">Windows Scripting Host</a> that can remotely play with anything in Visual Studio:<br><br><div class="code"><br><span class="comment">' VBScript crazy exception-style handling</span><br>On Error Resume Next<br><br><span class="comment">' Get any live Visual Studio object</span><br>Set DTE = GetObject(,<span class="string">"VisualStudio.DTE"</span>)<br><span class="keyword">If</span> Err.Number = 0 Then<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">' Locate the macro</span><br>&nbsp;&nbsp;&nbsp;&nbsp;Set cmds = DTE.Commands<br>&nbsp;&nbsp;&nbsp;&nbsp;Set attach_cmd = cmds.Item(<span class="string">"Macros.MyVSMacros.Debug.AttachToGame"</span>)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">' Run it!</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">Dim</span> customin, customout<br>&nbsp;&nbsp;&nbsp;&nbsp;cmds.Raise attach_cmd.Guid, attach_cmd.ID, customin, customout<br><br><span class="keyword">End</span> <span class="keyword">If</span><br></div><br>Saving
 this to a .vbs file in Windows and double-clicking from outside the IDE
 will run the attach macro for you. You could run the game process then 
run a shell to execute this, or you could embed some C++ code in your 
client that does just that after you've launched the game:<br><br><div class="code"><br><br><span class="keyword">#include</span> &lt;windows.h&gt;<br><br><br><span class="keyword">#pragma</span> warning(disable : 4278)<br><span class="keyword">#pragma</span> warning(disable : 4146)<br><br><span class="comment">// The following #import imports EnvDTE based on its LIBID.</span><br>#import <span class="string">"libid:80cc9f66-e7d8-4ddd-85b6-d9e6cd0e93e2"</span> version(<span class="string">"8.0"</span>) lcid(<span class="string">"0"</span>) raw_interfaces_only named_guids<br><span class="comment">//The following #import imports EnvDTE80 based on its LIBID.</span><br>#import <span class="string">"libid:1A31287A-4D7D-413e-8E32-3B374931BD89"</span> version(<span class="string">"8.0"</span>) lcid(<span class="string">"0"</span>) raw_interfaces_only named_guids<br><br><span class="keyword">#pragma</span> warning(<span class="keyword">default</span> : 4146)<br><span class="keyword">#pragma</span> warning(<span class="keyword">default</span> : 4278)<br><br><br><span class="keyword">int</span> APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="keyword">int</span> nShowCmd)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;CoInitialize(0);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;CLSID clsid;<br>&nbsp;&nbsp;&nbsp;&nbsp;CLSIDFromProgID(<span class="string">"VisualStudio.DTE.8.0"</span>, &amp;clsid);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get any running instance of Visual Studio</span><br>&nbsp;&nbsp;&nbsp;&nbsp;IUnknown* dte_unknown = 0;<br>&nbsp;&nbsp;&nbsp;&nbsp;HRESULT hr = GetActiveObject(clsid, 0, &amp;dte_unknown);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (dte_unknown)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EnvDTE80::DTE2Ptr dte = dte_unknown;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get a list of commands from Visual Studio</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EnvDTE::CommandsPtr commands;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hr = dte-&gt;get_Commands(&amp;commands);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get a pointer to the macro</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EnvDTE::CommandPtr command;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variant_t key = <span class="string">"Macros.MyVSMacros.Debug.AttachToGame"</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hr = commands-&gt;Item(key, 0, &amp;command);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Get the macro GUID and ID</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bstr_t cmd_guid;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hr = command-&gt;get_Guid(cmd_guid.GetAddress());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">long</span> cmd_id;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hr = command-&gt;get_ID(&amp;cmd_id);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// Execute the macro</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;variant_t custom_in, custom_out;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;commands-&gt;Raise(cmd_guid,
 cmd_id, custom_in.GetAddress(), custom_out.GetAddress());<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;CoUninitialize();<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> 0;<br>}<br></div><br><br>Note I'm referencing <i>"VisualStudio.DTE.8.0"</i>,
 which is the object for VS2005. If you use later versions, you'll need 
to replace them. There are no special dependencies you have to setup 
here, just create an empty Windows project in Visual Studio and create a
 C++ file you can put that code in and it compiles and links just fine.<br><br>Now
 I just keep Visual Studio running in the background and my "Wait for 
Debugger" checkbox is now an "Attach Debugger" checkbox. If set, my 
iteration is:<ul><li> Run client. Visual Studio instantly attaches to Server.</li></ul>Brilliant!<br><br>Some references:<ul><li> <a href="http://www.mztools.com/resources_vsnet_addins.aspx" target="new">Visual Studio extensibility</a></li><li> <a href="http://msdn.microsoft.com/en-us/library/yf86a8ts%28v=vs.80%29.aspx" target="new">How to: Add References to the EnvDTE and EnvDTE80 Namespaces</a></li><li> <a href="http://msdn.microsoft.com/en-us/library/68shb4dw%28v=vs.80%29.aspx" target="new">How to: Get References to the DTE and DTE2 Objects</a></li><li> <a href="http://msdn.microsoft.com/en-US/library/ms228691%28v=vs.80%29.aspx" target="new">Visual Studio Automation Reference</a></li><li> <a href="http://technet.microsoft.com/en-us/library/ee198896.aspx" target="new">VBScript Primer</a></li><li> <a href="http://technet.microsoft.com/en-us/library/ee692852.aspx" target="new">VBScript Error Handling</a></li></ul><a href="http://localhost/b/?d=2012-02-07-11-37-23#disqus_thread" data-disqus-identifier="2012-02-07-11-37-23">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20120116222600"><a href="javascript:blog_goto('2012-01-16-22-26-00')" class="title">A New Year (monster) update</a><br><span class="date">Posted 16 January 2012 22:26:00</span><br><br>I'm writing this post from the comfort of my very large sofa, under a dimmed lamp, while <a href="http://www.qi.com/tv/" target="new">QI</a>
 plays amusingly on the TV in the background. We finally managed to find
 a nice house to rent and have slowly got our lives back to normality. 
And there's an entire year ahead for me to try and get this game out the
 door! With some of the work we wanted to do on the house we attempted 
to buy, I'm sure it would have been a huge distraction during a time 
when I need most focus.<br><br>I managed to get approval for part 2 of my <a href="http://altdevblogaday.com/2012/01/03/reflection-in-c-part-2-the-simple-implementation-of-splinter-cell/" target="new">Reflection in C++</a> series on <a href="http://altdevblogaday.com/" target="new">#AltDevBlogADay</a> that managed to get a <a href="http://www.gamasutra.com/view/news/39500/Reflection_in_C_The_simple_implementation_of_Splinter_Cell.php" target="new">Gamasutra</a>
 reprint. Work on part 3 is progressing well and thankfully won't need 
any publishing approval, so you should see that very soon.<br><br><h4> Starting from scratch </h4><br>It's
 been very hard starting this project and working on my own. I'm a much 
better programmer than I am salesman/designer, so I like to convey my 
ideas in code before I try to attract other people to work with me. 
Sounds crazy and it has some downsides.<br><br>When you start coding, 
besides the 3rd party libraries you choose to use, you have nothing. 
I've been in this situation many times before. Most memorably at a 
company back in 2002 where I started a code-base that eventually grew to
 around half a million lines of code, supporting a team of 20 people. 
However, there comes a point in your career where you get tired of 
rewriting the same code over and over again. The last 5 years of my 
career have been dominated by two code bases whose roots can be traced 
back as far as 1994, and while the teams I've worked on had the freedom 
to transform them quite significantly, they carried with them an immense
 library of tools that helped you in your day to day job. Not only that;
 they provided a platform to make increasingly more sophisticated tools 
that I can't possibly recreate with the limited resources I have.<br><br>At the start, I had several very interesting problems to solve, including:<ul><li> How do I get native code in as many browsers as possible with no installation required and transparent updates?</li><li> How do I make my code as tiny as possible with no required 3rd party installations (such as the MSVC redistributables)?</li><li> How can I seamlessly perform interop between C++ and Javascript?</li><li> How do I write a cache-efficient entity/component system, having not written game code for years?</li><li>
 How can I get C++ reflection that's non-intrusive, easy to use and not 
engineered to continually cause me problems when I hit up against its 
limitations?</li></ul><a href="javascript:blog_goto('clReflect')">clReflect</a>
 has proven to be my biggest visible achievement so far. It's helped me 
solve so many problems very simply and has many more goodies yet to be 
released. Here's a teaser of how clReflect has helped me with the native
 code/javascript interop:<br><br><a href="" class="image"><img src=""></a><br><br>Since
 I took the screenshot, the process has simplified further and it's a 
joy to use. Once the game becomes public and I've eased my paranoia, 
I'll write a few posts on the rest of the stuff.<br><br>One other thing I'm missing is being able to find inspiration in those around me. Working on <a href="http://marketplace.xbox.com/en-US/Product/Fable-III/66acd000-77fe-1000-9115-d8024d5308d6" target="new">Fable 3</a>, <a href="http://marketplace.xbox.com/en-US/Product/Fable-II/66acd000-77fe-1000-9115-d8024d5307f1" target="new">Fable 2</a> and <a href="http://splintercell.ubi.com/conviction/" target="new">Splinter Cell</a>
 and some of the stuff after that was an amazing experience; there were 
so many artists, designers and programmers who would create crazy stuff 
on a daily basis that would just blow you away.<br><br>Either way, I'm 
now at a point where the core fundamentals of the gameplay/experience 
are functional and everything is starting to look like something people 
would actually enjoy using. This is such a huge boost and I find myself 
disconnecting my internet connection at work so that I have no 
distractions and can focus entirely on the project.<br><br><h4> The code </h4><br>I've
 been searching for months for a look to the game world that would make 
it unique. I'm no artist or art director and I'll be leaving the large 
majority of that to somebody else, but looking at <a href="http://www.minecraft.net/" target="new">Minecraft</a>, it's obvious that the technology dictates the starting point for the art direction in a very unique way.<br><br>The
 rendering engine for my game is very rudimentary at the moment, but I'm
 getting to the point where I'll need to settle on the core technology 
that drives it. I <b>think</b> I've finally settled on what I'm going to
 do and have a few experiments to run through before I make that choice.
 But it's looking promising.<br><br>I've spent the last month knee-deep 
in HTML5, the canvas element, CSS, javascript and cross-browser 
compatibility issues. To start with, it was a chore, but now that I'm 
getting to know the quirks of each browser and the DOM, I'm enjoying it 
and feel a lot more confident. This has resulted in some pretty cute 
user interface elements.<br><br>I've always loved Javascript but have 
never really found an application for it since the DOM put me off 
considerably. It's easy to get optimal, cross-browser 2D canvas 
rendering at the moment - obviously a sign of the more coherent 
standardisation initiative. But CSS and HTML is still awful. There are 
times where I switch to canvas rendering for UI elements, rather than 
going through HTML/CSS.<br><br>WebGL is very cool but for the kind of 
thing I'm doing, not optimal. However, I will be using it in some very 
dastardly ways to achieve stuff that would otherwise require me to 
package huge libraries with the download.<br><br>The biggest help has been <a href="http://getfirebug.com/" target="new">Firebug</a>.
 Once I figured out how to use the console and inspect the structure of 
the page at runtime, it opened up a lot of closed doors. Another thing 
it's fantastic for is figuring out how webpages do what they do. (I also
 wrote a <a href="http://codepad.org/k1sLkkYu" target="new">hack</a> to make debugging a little less painful while iterating on code).<br><br>The
 months before that were spent writing physics code and spending many 
days iterating on just a few lines of code to get gameplay that's in 
some way "fun". I haven't done this kind of code for years and it's been
 very easy for me to focus on it too much, rather than have the 
experience to realise I need to move on and concentrate on other things.
 Engine and game code are difficult for very different reasons, and I'm 
really enjoying finding out what makes game code tick these days.<br><br>So
 that's it for now... I'll try to write posts with more frequency and 
openness as I get confident nobody is going to get to this idea before I
 do :)<br><br><a href="http://localhost/b/?d=2012-01-16-22-26-00#disqus_thread" data-disqus-identifier="2012-01-16-22-26-00">0 Comments</a><br></div></div><div><div style="opacity: 1;" class="post" id="Post20111215130200"><a href="javascript:blog_goto('2011-12-15-13-02-00')" class="title">The UK: Credit is King and the self-employed live outside the castle walls</a><br><span class="date">Posted 15 December 2011 13:02:00</span><br><br>I
 figured I'd cover a bit about what's been going on behind the scenes 
lately while I try to build my game. It's a bit personal but I suppose 
it can be considered a "human interest" story and may be useful to 
others who are looking for alternatives to so-called AAA game 
development. It also highlights some of my naivety and how doing this 
really is an amazing learning experience for me.<br><br>My situation is, briefly:<ul><li> I have been gainfully employed for 13 years in the games industry, in the UK, Canada and France.</li><li> Throughout that time period I've saved money fervently and built up enough savings to self-fund myself for a few years.</li><li> I quit my job at Microsoft to build my own game.</li><li> I am registered self-employed with HMRC, still pay NI tax and will be doing self-assessment.</li><li> I will build a business before the tax year ends if the game shows promise and I need other people on-board.</li></ul>I
 live with my girlfriend in a very nice 3 bedroom house in 
Hove/Brighton. The neighbourhood is lovely and quiet but there are a 
couple of issues:<ul><li> It's expensive. When I'm not receiving a monthly income, it's not justifiable.</li><li> Our contract is up on January 1st.</li></ul>What follows is part of our story over the last few months, trying to address this... we needed a plan!<br><br><br><h4> Buying a house will save me money </h4><br>If
 I could get a mortgage with my girlfriend then our monthly property 
outgoings would be halved. More importantly: a significant chunk of that
 money would be going into our future.<br><br>I didn't hold out much 
hope of getting a mortgage myself as, when self-employed, you need 3 
years of accounts from your business. Some lenders are willing to make 
that 2 years if your business is within your existing trade. However, I 
could put down a sizeable deposit and in the process <b>double</b> the amount of time I could stay self-employed, building the game.<br><br>Given
 that I'm pretty much an employable entity even if the game/business 
doesn't work out, this all sounded too good to be true.<br><br>The plan was thus:<ul><li> Start looking 4 months before we're due to move out.</li><li> Put an offer in on a house as early as possible using the fact that we're not part of a chain as an advantage.</li><li> If everything goes pear-shaped, we can move into my girlfriend's much smaller flat temporarily.</li><li>
 I would supply the deposit, my girlfriend the mortgage, we would both 
be on the deeds and we'd sign some monetary agreement contracts.</li></ul>We
 didn't fancy the idea of moving into my girlfriend's flat long term for
 lots of reasons. Although, we weren't ruling it out as a last resort.<br><br><br><h4> Howard Brown wants my money. No... ALL of it! </h4><br>We
 first met success with Halifax as my girlfriend already had a mortgage 
with them and we had a joint account there. My suspicions were 
comfirmed; when it comes to me and mortgages, "computer says no." 
However, my girlfriend was told she could have a 90% mortgage, provided 
she could raise the deposit, so we went house hunting.<br><br>Quickly, 
we found a great house within our price range, in the perfect location 
and put an offer in. After some negotiation it was accepted, on the 
understanding that we get a <a href="http://www.direct.gov.uk/en/MoneyTaxAndBenefits/ManagingMoney/Mortgages/DG_10013667" target="new">Mortgage in Principle</a>
 from Halifax. After arriving at the branch, the nice lady typed our 
details back in and looked somewhat puzzled. "Sorry, it looks like we 
can only offer you an 85% mortgage."<br><br>Cue look of disbelief.<br><br>After
 some calculations and concessions we figured that we could just about 
stretch to that amount. By the time we got back to the estate agents, 
however, the property was gone; given to a cash buyer for the asking 
price. Apparently.<br><br>So we went out looking again; this time for a 
cheaper property. Luckily, we found a place that accepted a 
significantly lower figure than the asking price. It needed about a 
month's worth of work before being livable (e.g. it had no kitchen) but 
we had just enough time and could move into my girlfriend's place if it 
took any longer. We also calculated that we could make a good bit of 
money if we sold the property at a later date.<br><br>My girlfriend's 
solicitor was let off the leash and our the mortgage application went 
off to the underwriters (there's no coincidence their name reminds me of
 undertakers, as you will soon discover).<br><br>After a few days of 
delays and no feedback we got some information. (Note the use of the 
term "got," here. These people never contact you - they wait for you to 
contact them and then they give you the bad news.) Apparently, due to 
the fact that my girlfriend already had a mortgage with Halifax, they 
could now only offer us a 75% mortgage.<br><br>75%. Thousands of pounds. They had that information. In the branch. The day we first walked in.<br><br>We told them where they could stick their "mortgage offer" and went to some other lenders.<br><br><br><h4> The helpful IFA who may have driven a yellow Reliant Regal </h4><br>Speaking
 with my banks, we were immediately told that we couldn't afford a 
second mortgage on a single income, which was actually quite nice. 
Quick, if somewhat negative, news delivered with no craziness.<br><br>It
 looked like we were going to have to pull out before a friend put us in
 contact with an IFA that thought our application was "one of the 
simplest he'd ever seen; an application that would be completed in a few
 days." Wohey!<br><br>After a few days, he found us an offer with 
Santander at 85% and we quickly contacted the vendor to reassure them 
that everything was going OK. Even better, he said I could go on the 
mortgage, too! It took a couple of weeks to push through after news came
 back that I had a lack of positive credit in the UK, despite growing up
 here (working overseas tends to do that for you). Due to a 
misunderstanding with postal addresses, the only contribution I had was a
 negative 10 gas bill that was eventually settled once the company I 
owed money to eventually figured out where I lived.<br><br>Note that at 
this point I'd been paying a significant amount of money each month to 
various landlords, inland revenue, energy companies and that single mark
 was enough to make Santander cagey. We resorted to the original plan 
and continued. A couple more weeks later with "everything was going 
fine" and "it should be done in a couple of days" being the standard 
response from our IFA, we started getting worried and annoyed. 
Eventually he came back to us saying that everything had been approved 
and that all that was required was the valuation to be instructed.<br><br>We'd
 already payed the solicitors for a survey and various other bits and 
pieces and so now had to pay for the valuation. This was good. Things 
were getting further than before.<br><br>Another couple of weeks later 
and Santander hadn't got round to instructing the valuation so we 
complained to our IFA while the vendor was getting restless. He 
complained to Santander. We got word back a few days later that there 
was a backlog of mortgage applications near christmas and Santander were
 still pushing it through. After another week we got more vocal and 
found out that they had apparently made an error with our application, 
ammended it and put it right to the back of the queue. After some angry 
complaining they pushed it back up to try and instruct the valuation.<br><br>And
 then they hit us. Hard. "We won't instruct the valuation unless you 
give us another 10,000 deposit". Jebus on a bike. This was stressful 
and wasn't making any sense. We managed to very thankfully secure the 
money with our family and Santander accepted the mortgage. Again. I 
think. "The valuation will be instructed in 3 days," we were told, along
 with a reduction in the interest by 1% to keep us sweet.<br><br>If there were any more delays beyond this point, we'd be moving into my girlfriend's flat.<br><br><br><h4> Have you ever seen it rain indoors? </h4><br>We
 were having a coffee and going through all of the numbers when my 
girlfriend got a worrying phone call about a small water leak that was 
coming through the ceiling of the tenant who was living below her flat. I
 left for work while she went to check out the flat. Half an hour later I
 received a distressed phone call about a mammoth water leak, so I 
quickly cycled over to see what the trouble was.<br><br>Walking into the
 flat, I could quite clearly see, feel and hear rain. Only this wasn't 
water. This was faeces and waste from a soil pipe that had burst in the 
ceiling of the bedroom. The soil pipe supplied two flats with 5 tenants 
and was horizontally fitted so that whenever waste entered the pipe, it 
never really went anywhere.<br><br>The flat, its carpet, floorboards, 
roof and walls were ruined. After a highly stressful couple of days, the
 good news was that everything was covered by the insurance (yet again; 
the flat has a bad history of stuff like this happening and the 
insurance company not paying enough to get it properly diagnosed and 
fixed). The bad news was that the place was an active health hazard and 
could not be lived in for the next 2 to 3 months while it was 
decontaminated and repaired.<br><br>On top of that, there were more 
mortgage delays and we were looking at the prospect of living in a cold,
 dirty house with no kitchen and an interminable smell of tobacco that 
was growing on the walls.<br><br><br><h4> The solictor sounds the death knell </h4><br>Everything
 was looking like it was going to complete and we initiated contact with
 our solicitor again. We were told: because I was not on the mortgage I 
could not be on the title deeds. Not only that, they said I had to sign 
my deposit over to my girlfriend as a "gift," waiver all rights to or 
interest in the property and seek separate legal advice. They tell us 
this when from day one we were paying them and they were aware of that 
information. If ever there was a time for a slow, painful elaboration of
 the words "What. The. Fuck.", it was now.<br><br>We had no option but 
to end everything and quickly, frantically search for a new place to 
rent. Our first port of call was to ask our landlord for a month's 
extension but his response was a negative: he didn't want the fuss of 
extra legal paperwork and was getting a new carpet fitted which he 
didn't want our cat to walk on. Yeah...<br><br><br><h4> Moving into a smaller rented place will save me money </h4><br>We
 went on the hunt - it's quite an odd feeling, packing to move house 
knowing that you don't yet have anywhere to go. Being christmas time, 
there wasn't much on the market but we found an amazing place for an 
asking price that was less than our current place. It was on with 4 
estate agents and the guy told us that the owner would accept much less 
than the asking price and so we offered. He gave us a counter-offer but 
by the time we could get word back, he'd found somebody to rent at the 
full price with another estate agent. We really should have just paid 
the asking price.<br><br>Having no luxury to be picky and with a little 
bit of panic, we kept looking. We soon found another place and promptly 
offered to rent. Our case was put to a referencing company, where the 
troubles began.<br><br>At first they said my girlfriend couldn't afford 
her share of the rent because her income couldn't demonstrate it. We 
talked things over, sent a few faxes and I guess they realised they got 
their figures wrong because they amended that position and then turned 
on me. As I was self-employed I needed a reference from an accountant, 
similar to applying for a mortgage. Of course, as I'd only just started 
building my product, had no need for an accountant and couldn't 
demonstrate any form of business income, I was deemed somebody who 
couldn't afford the rent.<br><br>Let's back-track here. I had been out 
of work for 6 months, studiously paying the rent on a much more 
expensive house. I had enough money in the bank to rent the place for 
the next 10 years. And I was told I couldn't afford to rent it and thus 
had no right to. Apparently that money could be "there one minute and 
gone the next." Unlike a job (in the games industry, no less). Of 
course!<br><br>The running theme that every estate agent, banker and IFA
 kept telling me was that if I went out and got a job for two months (it
 could be anything!), there wouldn't be a problem.<br><br>So I needed a 
guarantor for the rent, who I was told had to be a house owner. I asked a
 very close family member who was more than happy to help. And they 
declined them as they were retired. Forget the fact that they were quite
 wealthy and owned multiple properties. Oh, no, that's not remotely good
 enough!<br><br><br><h4> Closure </h4><br>So this is where we are. 
Almost done packing and still unsure if we'll get the keys to the new 
place. We've arranged somebody else as the guarantor and the estate 
agent thinks there'll be no further problems. I think many would forgive
 us for being slightly anxious about that.<br><br>It's almost enough to 
make you think you've made a mistake and should go back to a well paid 
job, chasing the ideals of Familialism, Social Order and loyal 
Consumerist Debt. Only it's not. This is exactly the kind of thing that 
gets me more charged and determined to do things my way. If something's 
easy, it's not worth having. If something is different, troubled with 
challenges and not exactly clear-cut, it needs to be tamed and made your
 own.<br><br>Meanwhile, there are thousands, if not millions of people 
in worse off situations than this and I consider myself extremely lucky 
to be in the situation I am in today.<br><br><i>If you have the ability, please consider a donation to <a href="http://www.shelter.org.uk/" target="new">Shelter</a> to help families and individuals in the UK that are at risk of becoming homeless.</i><br><br>Let's hope we get what we need this time!<br><br><a href="http://localhost/b/?d=2011-12-15-13-02-00#disqus_thread" data-disqus-identifier="2011-12-15-13-02-00">2 Comments</a><br></div></div><div><div style="opacity: 1;" class="post" id="Post20111129111830"><a href="javascript:blog_goto('2011-11-29-11-18-30')" class="title">clReflect 0.3 released</a><br><span class="date">Posted 29 November 2011 11:18:30</span><br><br>After a couple months hard work, the latest version of clReflect has been uploaded; you can download it <a href="https://bitbucket.org/dwilliamson/clreflect/downloads/clReflect-0.3.7z" target="new">here</a> or browse the latest source code <a href="https://bitbucket.org/dwilliamson/clreflect/overview" target="new">here</a>.
 It's in continuous use on my new game project and I'm picking away at 
bugs and features as I need them. As always, if there's something that 
you don't like or a feature I haven't got round to adding yet, please 
send patches!<br><br>There are some very cool new features in 0.3, including:<ul><li> Container support with iterator interfaces and a means of registering/parsing the containers in C++.</li><li> Support for constant-size arrays as field types (classes, functions, methods).</li><li>
 Constant-time, string-less GetType and GetTypeNameHash functions so 
that a runtime should never need to depend on string processing and the 
functions can be used in templated functions.</li><li> A new utility library (clReflectUtil) that contains optional C++ runtime components that can be used with clReflect.</li><li> Versioned, binary serialisation for reflected types.</li><li> A very complete JSON serialiser for reflected types with no external library dependencies.</li><li> A basic object model implementation with base objects and object database with iterators.</li><li> DLL support with function pointer rebasing and an interface/implementation abstraction for plugin development.</li></ul>There
 are many C++ language support improvements (e.g. anonymous 
structs/unions, __int64, typedefs, templated base classes) and bug fixes
 that are detailed in the <a href="https://bitbucket.org/dwilliamson/clreflect/src/9db41e8a22ff/release/README" target="new">release notes</a>. This is also the first version to use the latest LLVM/clang 3.0 release branch for a stable base.<br><br>In other news, I've started a <a href="http://altdevblogaday.com/2011/09/25/reflection-in-c-part-1-introduction/" target="new">Reflection in C++</a> tutorial series over at <a href="http://altdevblogaday.com/" target="new">#AltDevBlogADay</a>
 that may interest users of clReflect. Part 2 is complete, awaiting 
publishing clearance from Ubisoft and going through proof-reading.<br><br><a href="https://bitbucket.org/dwilliamson/pib" target="new">PiB</a>
 continues to evolve and receive performance improvements. The API has 
settled down but there are many internals that I'd like to 
improve/rewrite. However, that's not likely to happen soon as it's more 
than satisfactory for my needs and I have my startup to concentrate on.<br><br>Likewise, <a href="https://bitbucket.org/dwilliamson/tiny-blog" target="new">TinyBlog</a> has improved, receiving <a href="http://disqus.com/" target="new">Disqus</a>
 commenting support more recently. I haven't updated the Bitbucket copy 
of the source yet but if you view the source of this website, it's all 
there.<br><br><a href="http://localhost/b/?d=2011-11-29-11-18-30#disqus_thread" data-disqus-identifier="2011-11-29-11-18-30">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20110908214100"><a href="javascript:blog_goto('2011-09-08-21-41-00')" class="title">The life of a self-employed</a><br><span class="date">Posted 08 September 2011 21:41:00</span><br><br>So
 I'm at the 3 month mark of being self-employed and everything is going 
good. It's about time I broke the trend of technical posts and covered 
some real life news.<br><br>As far as project progress is concerned, I'm
 not where I expected I'd be after 3 months. I'm taking a technology 
route that's quite unusual in order to make my product as accessible as 
possible, which means there's not much prior art I can easily root out. 
There have been a few dead-ends along the way, although there have been 
at least as many successes I didn't predict when I first started.<br><br>The
 fact that I'm behind schedule has been worrying me. When you work for a
 larger company there are certain stresses related to feeling powerless 
when decisions are taken away from you, especially when you have a 
certain amount of emotional investment in the work you do. Working for 
yourself you have the freedom to do what you want, bounded by the more 
pressing requirement of releasing something. It feels amazing and 
therapeutic but there are times when it can be just as stressful.<br><br>I've
 been constantly thinking about what I would do if everything didn't 
work and it saps quite a bit of energy. Should I move sideways into VFX?
 Should I move overseas again where the industry is more stable? Should I
 take my newfound experience and move away from console games? These 
questions and more would sometimes keep me up into the early hours of 
the morning.<br><br>I've come to realise it's completely the wrong 
mindset, however - I need to trust my own ability to think of a solution
 if that time ever comes. That single realisation has made me feel a 
whole lot better about things.<br><br>The feeling you get when suddenly a
 regular wage isn't coming into your account after years of steady jobs 
is sobering. I was expecting this as I left my job 10 years ago for 3 
months to further my abilities on what meagre savings I had. But that 
doesn't stop the shock and it really works to sharpen your money skills.<br><br>My
 personal spending took a while to calm down. It's still not where I 
want it to be but we are making more changes to help that:<ul><li> I've cancelled my phone insurance and gone for a much cheaper <a href="http://www.protectyourbubble.com/" target="new">online solution</a>.</li><li>
 I tried to buy myself out of my HTC phone contract with my previous 
insurance but they had a clause whereby they took ownership of the phone
 and number. Given the phone is pretty good, I'll save more money 
staying until the end of the contract, selling the phone and getting a 
cheaper model.</li><li> Going out for meals in the evening is something we used to do often but that's been cut back quite a bit.</li><li>
 I'm going to the supermarket once a week and buying stuff to make lunch
 with instead of walking around town and buying everything pre-made.</li><li>
 The office I'm in is too expensive. It's really nice but simply 
overkill. I need some smaller desk space in an open-plan office with 
other people and I have some good candidates that will save me a lot of 
money.</li><li> Visiting my family has become less regular. I live about
 150 miles away from them and the cost of a train fare is something I 
have to seriously consider before going.</li><li> All my old gadgets and
 clothes that are still worth some good money, I've been ebaying (I 
haven't used my Macbook Air in 2 years!).</li></ul>And so much more...<br><br>This
 is really changing my outlook on life and giving me some good skills 
which I lost a long time ago. However the one thing I could never have 
predicted is that all of a sudden I want to buy a house! We live in a 
great house in Brighton but the majority of what I'm paying myself is 
going directly to our landlord and that really winds me up.<br><br>I 
never used to care - I always loved being able to move quickly between 
cities/countries; a luxury when you're getting a regular income. So I'm 
going to sink some money into a deposit and we should hopefully have our
 own house by the new year! This decision has similarly relieved me of 
an awful lot of anxiety.<br><br>And finally the project itself: I'm 
kicking out code like there's no tomorrow. I'm obviously not as fast as I
 was 10 years ago (and I need routine rest, food and exercise) but I'd 
like to think I'm many times more efficient. I'm writing the code I've 
been trying to convince other people to pay me to write for years and 
I'm loving every bit of it. Hopefully it will pay off!<br><br><a href="http://localhost/b/?d=2011-09-08-21-41-00#disqus_thread" data-disqus-identifier="2011-09-08-21-41-00">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20110817143604"><a href="javascript:blog_goto('2011-08-17-14-36-04')" class="title">Introducing clReflect - C++ Reflection with clang</a><br><span class="date">Posted 17 August 2011 14:36:04</span><br><br>Over
 the last few weeks I've been working, advisable or not, on what I think
 is a pretty reliable way of generating and using Reflection information
 for programs written in C++. The result is <a href="javascript:blog_goto('clReflect')">clReflect</a> - part self-indulgence, mostly incredibly useful for what I'm currently working on!<br><br>It's
 by no means finished but it's reached the first releasable milestone 
that I'm not afraid to show. There are so many uses for this, which I 
will cover in future blog posts.<br><br>I've been writing Reflection 
APIs for many years and try to shoe-horn them in on whatever project I'm
 working on (Splinter Cell: Conviction being by far the most successful 
example - more info <a href="http://donw.org/rfl" target="new">here</a>). This will hopefully settle my angst at not having a decent C++ solution and stop me writing them forever more :)<br><br>Check it out, let me know what you think and if you can lend a hand, please do!<br><br><a href="http://localhost/b/?d=2011-08-17-14-36-04#disqus_thread" data-disqus-identifier="2011-08-17-14-36-04">0 Comments</a><br></div></div><div><div style="opacity: 1;" class="post" id="Post20110816172723"><a href="javascript:blog_goto('2011-08-16-17-27-23')" class="title">Lightweight Javascript Blogging</a><br><span class="date">Posted 16 August 2011 17:27:23</span><br><br>My
 blog has been a bit quiet for a while and I assure you that it will 
become apparent why within the week :) I'm hoping to also share a few 
words on what it feels like to be self-employed for a couple of months 
now.<br><br>Anyway, on to some cute developments. The product I'm 
working on is web-based and the last time I used HTML, CSS, PHP and 
Javascript heavily was 2003. I wrote some crazy tools that could inspect
 our game asset database and allow content creators to visit a webpage 
and walk around our tree to inspect various stats: file size, poly 
count, mesh errors, whatever. Back then it was a nightmare to get 
anything non-trivial to function cross-browser.<br><br>So in my spare 
time, I've created my own little blogging engine, which is what you're 
viewing this website through now :) It's entirely written in Javascript 
with some PHP server-side extensions for the stuff Javascript can't do 
(however, these are optional). The website is <a href="javascript:blog_goto('TinyBlog')">here</a>, so go check it out and let me know if it's any good!<br><br><a href="http://localhost/b/?d=2011-08-16-17-27-23#disqus_thread" data-disqus-identifier="2011-08-16-17-27-23">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20110715102325"><a href="javascript:blog_goto('2011-07-15-10-23-25')" class="title">Variadic macro dispatch in Visual C++ 2005 and later</a><br><span class="date">Posted 15 July 2011 10:23:25</span><br><br>While
 the world awaits the arrival of variadic macros in C++, most production
 compilers out there have added __VA_ARGS__ support as an extension with
 implementations that vary quite subtly. Variadic macros are a feature 
of <a href="http://www.open-std.org/jtc1/sc22/wg14/www/standards" target="new">C99</a> and since C++ is not entirely a superset of C these days (<a href="http://drdobbs.com/184401444" target="new">variable length arrays</a> would be nice), nobody is under any obligation to support them.<br><br>Variadic
 macros are pretty cool - you can do stuff like this (prints log data 
such that you can double-click on the output in Visual Studio and it 
jumps to source code where it's emitted):<br><br><div class="code"><br><span class="keyword">#define</span> LOG(fmt, ...) printf(<span class="string">"%s(%d) : "</span> fmt, __FILE__, __LINE__, __VA_ARGS__)<br>LOG(<span class="string">"there are %d arguments to this %sn"</span>, 3, <span class="string">"macro"</span>);<br></div><br>That's
 generally the limit to the support provided by most compilers. 
Unfortunately that means there's no support for counting the number of 
arguments passed to the macro or even accessing each argument 
individually. There's a little trick for achieving this, however:<br><br><div class="code"><br><span class="keyword">#define</span> VA_NARGS_IMPL(_1, _2, _3, NARGS, ...) NARGS<br><span class="keyword">#define</span> VA_NARGS(...) VA_NARGS_IMPL(__VA_ARGS__, 3, 2, 1, 0)<br>printf(<span class="string">"%dn"</span>, VA_NARGS(1, 2, 3));<br></div><br>This
 works by starting the call off to VA_NARGS_IMPL with any parameters 
that get passed to VA_NARGS, adding the 3,2,1,0 values at the end. One 
of these numbers gets assigned as the NARGS parameter depending on how 
many arguments you pass, and that gets returned. The caveat is that this
 trick only works on  few compilers out there. VC2005 passes __VA_ARGS__
 to VA_NARGS_IMPL as one preprocessor token and will always return the 
result of 1. Currently from versions 2005 to 2010, <a href="http://connect.microsoft.com/VisualStudio/feedback/details/380090/variadic-macro-replacement" target="new">there are no plans to fix this</a>.<br><br>In VC2005 and later versions you can do this to get it working:<br><br><div class="code"><br><span class="keyword">#define</span> EXPAND(x) x<br><span class="keyword">#define</span> VA_NARGS_IMPL(_1, _2, _3, NARGS, ...) NARGS<br><span class="keyword">#define</span> VA_NARGS(...) EXPAND(VA_NARGS_IMPL(__VA_ARGS__, 3, 2, 1, 0))<br></div><br>This
 adds an extra level of function-like macro expansion for the PP to 
perform before it evaluates the object-like macro __VA_ARGS__. I'm not 
entirely sure why VC behaves like this - stepping through Clang as it 
evalutes the original form confirms that the straightforward 
implementation of a PP (iterative function-like, object-like replacement
 on a line) gives the correct result. It's not a variation of the symbol
 join/evaluate problem and at a guess I'd say VC doesn't perform 
object-like macro expansion on its first pass when it encounters a 
variadic macro. It's some kind of PP hack that sits outside the normal 
expansion code, introducing a define for __VA_ARGS__ and then kicking 
off the iterative expansion as normal (hence the need for the extra 
level of indirection).<br><br>Moving on, we have the following macros:<br><br><div class="code"><br><span class="keyword">#define</span> PRINT1(x) printf(<span class="string">"%dn"</span>, x)<br><span class="keyword">#define</span> PRINT2(x, y) printf(<span class="string">"%d %dn"</span>, x, y)<br><span class="keyword">#define</span> PRINT3(x, y, z) printf(<span class="string">"%d %d %dn"</span>, x, y, z)<br></div><br>and we want to be able to do this:<br><br><div class="code"><br>PRINT(1);<br>PRINT(1, 2);<br>PRINT(1, 2, 3);<br></div><br>We can introduce the <a href="http://msdn.microsoft.com/en-us/library/b0084kay%28v=vs.80%29.aspx" target="new">classic symbol join macro</a> that adds an extra level of indirection to force object-like macro expansion to achieve this:<br><br><div class="code"><br><span class="keyword">#define</span> JOIN2(x, y) x ## y<br><span class="keyword">#define</span> JOIN(x, y) JOIN2(x, y)<br><span class="keyword">#define</span> PRINT(...) JOIN(PRINT, VA_NARGS(__VA_ARGS__))(__VA_ARGS__)<br></div><br>That's it!<br><br><a href="http://localhost/b/?d=2011-07-15-10-23-25#disqus_thread" data-disqus-identifier="2011-07-15-10-23-25">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20110712165849"><a href="javascript:blog_goto('2011-07-12-16-58-49')" class="title">Compile-time logarithms in C++</a><br><span class="date">Posted 12 July 2011 16:58:49</span><br><br>Just
 thought I'd record a quick bit of code that's come in handy just now. 
Maybe when I get used to this blog thing I'll do this more frequently!<br><br>I
 was writing a 64-bit itoa and needed to figure out how many bytes a 
specific variable type required when being converted to a string. To 
start with I just sized the buffer at 20 bytes and moved onto more 
important things. After I finished the greater task I took a quick break
 and played around with figuring this out at compile-time. 
Pragmatically, 20 bytes is enough and any implementation that does this 
(with bounds checking) will work and will be far easier to understand 
than what's coming up. It's probably a good point to stop there!<br><br>Books such as Modern C++ Design and their accompanying libraries (e.g. <a href="http://sourceforge.net/projects/loki-lib/" target="new">Loki</a>) popularised a technique called <a href="http://en.wikipedia.org/wiki/Template_metaprogramming" target="new">template meta-programming</a>.
 In their wake, they left a generation of elitist C++ programmers that 
destroyed code bases worldwide: bringing compilers to their knees, 
slowing compilation times to a crawl, writing impossible to read code 
that was a time-sink to port, and made you cry when you tried to 
step-debug it trying to figure out why it was breaking. Again. I used to
 be a proud member of those ranks and still haven't paid fully for my 
sins :)<br><br>Templates are <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.14.3670" target="new">Turing Complete</a>
 in the sense that you can really express any computational device you 
can think of if you have an infinite amount time to compile your program
 in. Some lecturers like to <a href="http://matt.might.net/articles/c++-template-meta-programming-with-lambda-calculus/" target="new">scare their students</a>
 with examples of such craziness. I won't be taking this post that far. 
In short: this is just a bit of fun - this code has already been deleted
 from the library I was writing it in!<br><br><h4>Some code</h4><br>I needed an implementation of log10 using integers so we can start with this:<br><br><div class="code"><br><span class="keyword">int</span> log10(<span class="keyword">unsigned</span> <span class="keyword">int</span> val)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;assert(val != 0 &amp;&amp; <span class="string">"Undefined for zero"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span> res = -1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span> (val)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val /= 10;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> res;<br>}<br></div><br>Note
 that the result is undefined at zero and it starts at -1 to give you a 
result of 0 for the log10 of 1. Algorithms that you want to express as a
 template metaprogram are generally easier to understand when written 
recursively:<br><br><div class="code"><br><span class="keyword">int</span> log10(<span class="keyword">unsigned</span> <span class="keyword">int</span> val)<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;assert(val != 0 &amp;&amp; <span class="string">"Undefined for zero"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span> (val / 10)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> log10(val / 10) + 1;<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> 0;<br>}<br></div><br>This
 recurses until it detects that further recursion will trigger the 
undefined assert. For expressing this as a TMP we have to use data 
structures that are parameterised by integer template values, using 
compile-time expression evaluation to generate the result we need. We 
can start with this:<br><br><div class="code"><br><span class="keyword">template</span> &lt;<span class="keyword">unsigned</span> <span class="keyword">int</span> N&gt; <span class="keyword">struct</span> log10<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> val = 1 + log10&lt;N / 10&gt;::val;<br>};<br><br><span class="keyword">int</span> a = log10&lt;1&gt;::val;<br><span class="keyword">int</span> b = log10&lt;10&gt;::val;<br></div><br>Right
 at the point that the log10 template tries to evaluate the value of its
 static integer, it recreates a new parameterised version of itself with
 N divided by 10. The bigger the value of N, the more times the compiler
 has to recurse and create new instances of the log10 template type - 
this is a good example of why even simple TMP can force your compiler to
 do some serious work and slow your compile times:<br><br><div class="code"><br><span class="comment">// Creates 20 new types in one line! (asusming you use __int64 in the code above)</span><br>int itoa_64bit_bytes_size = log10&lt;~(0ULL)&gt;::val;<br></div><br>Of
 course, the code above won't work when compiled because it will 
infinitely recurse with a value of N=0, generating an error specific to 
your compiler. To fix this you need to specialise the template for 
values of 0 so that recursion ends:<br><br><div class="code"><br><span class="keyword">template</span> &lt;&gt; <span class="keyword">struct</span> log10&lt;0&gt;<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> val = -1;<br>};<br></div><br>It
 works as advertised! Except that doing a log10 of zero returns -1. You 
could assume that means undefined or further use templates to raise an 
error at compile-time if you misuse the template. One simple way of 
doing this would be to not store any value in the specialised struct 
when N=0. This would catch your error but would also raise an error when
 the main log10 struct finishes recursing - all the time! Instead, you 
could introduce another type:<br><br><div class="code"><br><span class="keyword">template</span> &lt;<span class="keyword">unsigned</span> <span class="keyword">int</span> N&gt; <span class="keyword">struct</span> log10_impl<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> val = 1 + log10_impl&lt;N / 10&gt;::val;<br>};<br><span class="keyword">template</span> &lt;&gt; <span class="keyword">struct</span> log10_impl&lt;0&gt;<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> val = -1;<br>};<br><span class="keyword">template</span> &lt;<span class="keyword">unsigned</span> <span class="keyword">int</span> N&gt; <span class="keyword">struct</span> log10<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> val = log10_impl&lt;N&gt;::val;<br>};<br><span class="keyword">template</span> &lt;&gt; <span class="keyword">struct</span> log10&lt;0&gt;<br>{<br>};<br><br><span class="comment">// Works</span><br>int a = log10&lt;1&gt;::val;<br><br><span class="comment">// Raises a compile-time error - 'val' is missing</span><br>int b = log10&lt;0&gt;::val;<br></div><br>This
 could be classed as complete. When you get further into TMP you start 
building a library of tools and concepts, similar to the <a href="http://www.boost.org/doc/libs/1_47_0/libs/mpl/doc/" target="new">Boost MPL Library</a>.
 In such cases, code like the above log10 begin to look eerily 
procedural. For example, in the C++ version we had the luxury of being 
able to check the result of the division before we recursed for a final 
time - this can be achieved with templates, too!<br><br>To do this we can introduce the concept of the Template If Statement:<br><br><div class="code"><br><span class="keyword">template</span> &lt;<span class="keyword">bool</span> EXPR, <span class="keyword">typename</span> IF_TRUE, <span class="keyword">typename</span> IF_FALSE&gt; <span class="keyword">struct</span> <span class="keyword">If</span><br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">typedef</span> IF_TRUE res;<br>};<br><span class="keyword">template</span> &lt;<span class="keyword">typename</span> IF_TRUE, <span class="keyword">typename</span> IF_FALSE&gt; <span class="keyword">struct</span> <span class="keyword">If</span>&lt;<span class="keyword">false</span>, IF_TRUE, IF_FALSE&gt;<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">typedef</span> IF_FALSE res;<br>};<br></div><br>This
 uses partial template specialisation - a concept that is very useful in
 type libraries for figuring out if a given type is a pointer, 
reference, CV-qualified, etc. In this situation it can be used as 
follows:<br><br><div class="code"><br><span class="keyword">template</span> &lt;<span class="keyword">int</span> N&gt;<br><span class="keyword">struct</span> Int<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> val = N;<br>};<br><br><span class="keyword">template</span> &lt;<span class="keyword">unsigned</span> <span class="keyword">int</span> N&gt; <span class="keyword">struct</span> log10<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> val = 1 +<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">If</span>&lt;(N / 10) != 0,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log10&lt;N / 10&gt;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Int&lt;-1&gt; &gt;::res::val;<br>};<br><span class="keyword">template</span> &lt;&gt; <span class="keyword">struct</span> log10&lt;0&gt;<br>{<br>};<br></div><br>This
 still performs recursion and still maintains the ability to force a 
compile-error when used incorrectly, all within one type. The Int type 
would be part of your TMP library, making the code visually a little 
more concise to the seasoned TMP developer, but a little more hairy for 
others. The key concept to grasp is that that log10 is not recursively 
instantiated until the compiler needs access any of its members; in this
 case, res. If the result of the N/10 expression is false, the res 
member from the Int class is used instead and log10 is not instantiated 
any further.<br><br><h4>Closing words</h4><br>This is just scratching 
the surface of what is possible. By all means, go ahead and learn as 
much about TMP as you can - you will encounter million line plus 
codebases that contain some real horrors that you might one day be 
called upon to fix or even maintain. Get to know all the benefits and 
drawbacks as you might also have to protect a codebase from designs that
 could potentially alienate the rest of the programmers on your team. 
Don't take my word that this will bring the world around you crashing 
down - try it out for yourself; make your own mistakes in the process of
 learning it all. Have fun!<br><br>Some good links:<br><br><a href="http://www.boostpro.com/mplbook/" target="new">C++ Template Metaprogramming</a> (book)<br><a href="http://www.codeproject.com/KB/recipes/StaticDataStructure.aspx" target="new">Compile-time linked list</a><br><a href="http://mi.eng.cam.ac.uk/%7Eer258/code/fp_template.html" target="new">Floating point arithmetic in C++ templates</a><br><a href="http://www.kuro5hin.org/story/2003/5/26/22429/7674" target="new">What's wrong with C++ templates?</a><br><br><a href="http://localhost/b/?d=2011-07-12-16-58-49#disqus_thread" data-disqus-identifier="2011-07-12-16-58-49">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20110628170400"><a href="javascript:blog_goto('2011-06-28-17-04-00')" class="title">Build System DIY</a><br><span class="date">Posted 28 June 2011 17:04:00</span><br><br>UPDATE: The source code to PiB is <a href="javascript:blog_goto('PiB')">now available</a>.<br><br>I've
 been setup in the new office now for a good 5 days and there have been 
bits of progress made here and there. Monday last week involved me 
building my new desk, cleaning out the office &amp; working from my 
laptop, as my new computer hadn't arrived yet. It arrived later that 
night and I got everything setup on the tuesday - here's the space where
 magic will be happening... hopefully :)<br><br><br><center><a href="" class="image"><img src=""></a></center><br><br>Last
 week was pretty nerve-wracking. It started very slow: Will I enjoy what
 I'm doing? Can I work on my own for so long? Is the scope of the 
project within my grasp? Will the idea work? Is there a market for it? 
How many people are working on the same idea right now? Are there any 
out-of-the-blue financial disasters waiting to happen?<br><br>My head 
was full of this kind of stuff and it kept me up for a couple of nights -
 not having a computer to work with added to the confusion. However, as 
the week progressed, my confidence started to build and on friday, I was
 working pretty quickly. I spent 2 years on Fable 3 as the engine lead 
and in that sort of role, you get maybe 2 hours of concentrated 
programming time before you have to put everything down and arbiter a 
debate, give some guidance, manage the schedules of others, or keep up 
to speed on communication between departments. It's hectic and can 
prevent you from coding for long periods of time. Not so any more! With 
nobody to disturb me, I'm quite tired by the time the day ends, having 
coded solid for many more hours.<br><br>I've been looking into all kinds of different technology in the last week - I'll cover just one of them for now.<br><br><h4>The Build Environment</h4><br>The
 compiler I'm using is Visual C++ 2005 - I have every version up to 2010
 but I've always preferred this above the rest, mainly for compiler 
performance. That may change later and in an upcoming blog post I might 
explain the other reasons I had for making this choice. Needless to say,
 I'll be writing fast and very small footprint C++ code.<br><br>I need a
 code build system that can seamlessly handle multiple 
languages/platforms and tools and it needs to be dead simple. I can't 
afford to spend time worrying about whether it's working or not (hello, <a href="http://msdn.microsoft.com/en-us/library/kfz8ad09%28v=vs.80%29.aspx" target="new">/Gm</a>!)
 so it needs to be bullet-proof and very easy to configure/maintain. 
This rules Visual Studio out, despite it being the main build tool I've 
used on all projects for the last few years!<br><br>My favourite tool of choice for this in the past has been <a href="http://www.scons.org/" target="new">SCons</a>.
 It was used as the IDL compiler/builder and asset building system for 
Advent Shadow/Black&amp;White at Full Fat and for the asset build system
 on Fable at Lionhead (until we wrote our own faster version of it in 
C#). I know it inside out but it constantly makes me despair - it's 
slow, complicated and I'm constantly fighting it trying to fit whatever 
build model I need to achieve into its crazy system (if you've fought 
with the <a href="http://stackoverflow.com/questions/1074062/why-does-scons-variantdir-not-put-output-in-the-given-directory" target="new">VariantDir</a>
 issue, you'll know what I mean). Beyond that, if I was going to use 
SCons as a big project C++ builder across multiple platforms I'd want 
100% control over all the command-lines, properties and platform project
 files - something SCons is not very good at (the .vcproj/.sln 
generators are quite poor).<br><br>After some looking about for something simple, <a href="http://code.google.com/p/fabricate/" target="new">fabricate.py</a>
 stood out with a very elegant implementation that unfortunately is only
 really "elegant" when it's run under Linux. It works by hooking the 
file system and implicitly figuring out what dependencies a build node 
has by recording any opened files. On Linux this is achieved using <a href="http://linux.die.net/man/1/strace" target="new">strace</a>
 but there is no equivalent on Windows. The Windows implementation has 
to resort to using last file access times which performs poorly on large
 projects and has a few <a href="http://code.google.com/p/fabricate/issues/detail?id=14" target="new">unresolved issues</a> still.<br><br>One piece of software which might help here on Windows is <a href="http://research.microsoft.com/en-us/projects/detours/" target="new">Detours</a>,
 which is yours for the princely sum of $9999.95 - or if you're willing 
to live with a license which makes the GPL look tame, you can have a 
free version.<br><br>Alternatively there's <a href="http://easyhook.codeplex.com/" target="new">EasyHook</a>.
 This is an awesome piece of software which I used to write the file 
system virtualisation for Fable 3's lighting distribution tool. With 
that knowledge in hand I was almost considering extending fabricate with
 EasyHook support for Windows. However, when you consider the amount of 
potential issues you'd need to solve on top of the basic implementation 
(including load/runtime DLLs, 32/64-bit application differences, child 
process launching), it starts to run away from you fast.<br><br>There 
are many, many build systems out there but in the end I opted to build a
 very simple system myself and evolve it over time as my needs change.<br><br><h4>PiB</h4><br>So
 I headed straight for Python as it's one of my more productive 
languages. The system I set out to build initially took a day to write, 
followed by 2 days of making it robust and implementing features I 
didn't predict I needed.<br><br>Assuming you already know how to write a
 system well enough, the graft required to take an existing system, 
modify it for your needs and maintain those modifications can be just as
 much as writing the system itself. Some systems resist modification 
with bad design that simply tries to assume as much as possible and do 
too much for you. If you're willing to pay for all the bugs you'll hit 
that an existing system has already solved and you can guarantee that 
you will be more productive as a result, do it.<br><br>Am I more 
productive? By all accounts, yes! I've got a build system that for my 
needs seems good enough, allowing me to move on and concentrate on other
 things. I'd still be wrangling with SCons at this point and I'd 
probably be at the compromise stage where I'd cut off all development 
and move onto the next point (when you're paying your own wage, this can
 be quite sobering).<br><br>So the features are:<ul><li> Built in Python with very simple build logic - most of the code is Visual C++ tool-specific.</li><li> Arbitrary dependency graph building/evaluation, allowing any tool, language, platform, etc.</li><li> Lazy generation of .vcproj/.sln files.</li><li>
 Explicit and implicit dependencies - C++ header dependencies evaluated 
implicitly with /showIncludes cl.exe, making the build code much simpler
 and faster.</li><li> Build, rebuild, clean support.</li><li> Abstraction layer for most command-line options to cl.exe, link.exe and lib.exe.</li></ul>You stick your build scripts in a "pibfile", the simplest of which would look like:<br><br><div class="code"><br>def Build(env):<br><br>&nbsp;&nbsp;&nbsp;&nbsp;cpp = env.CPPFile(<span class="string">"main.cpp"</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;exe = env.Link(<span class="string">"Out.exe"</span>, cpp)<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span> [ exe ]<br></div><br>It's
 not overly automated and doesn't try to do too much (e.g. SCons has a 
layer of complexity involved with being able to pass an object vs. a 
list of objects). All the guts are in the open for all to see and 
modify. I know this will change later but I'm not prepared to try 
predict how it will change at this point.<br><br><h4>Problems with DIY</h4><br>Of
 course, developing the system was not without its cost. There were some
 tricky problems I had to work around which I found out later that SCons
 had already solved.<br><br>The first task was setting up the 
environment variables for a C++ compile under Visual C++ 2005. Locating 
the install directory was easy; it was just a case of calling the 
appropriate vcvars batch file to set up the environment and then calling
 whatever tool you needed. However, I wanted to do that only once at the
 beginning of the build, record the applied environment variables and 
record them for later application (instead of calling the batch file for
 each compile).<br><br>There's no real way to do this in Python other 
than to run the batch file, call "cmd /c set" and parse the output from 
stdout. Getting this to run and parse in Python was easy with the 
subprocess module but calling Popen.poll would sometimes never return or
 return too early when the "set" command was involved. I eventually gave
 up and called Popen.wait, followed by Popen.communicate. This has to 
wait until the end and gives you the results in one go but it worked. 
And so I moved on.<br><br>After running this from the IDE, however, it 
started hanging again. Process Explorer told me that while calling 
communicate was returning all text correctly, the python interpreter was
 in an infinite loop on exit because the Popen process hadn't closed 
itself. All attempts to kill/terminate it failed with "access denied".<br><br>It gets worse...<br><br>I
 thought that calling the built-in command "set" itself was the main 
issue and that getting at the environment by other means was fair game. 
So the process launch code was modified to do something like this:<br><br><div class="code"><br>with open(<span class="string">"temp.bat"</span>, <span class="string">"w"</span>) as f:<br>&nbsp;&nbsp;&nbsp;&nbsp;print(<span class="string">"call vcvars.bat"</span>, file=f)<br>&nbsp;&nbsp;&nbsp;&nbsp;print(sys.executable + <span class="string">" -c \"</span>import os;print(os.environ)\<span class="string">""</span>, file=f)<br></div><br>Here
 it's recursively calling the Python interpreter with a string script to
 report the environment. This failed with the same problems, too! After 
more reading I was hearing mumblings of the subprocess module not being <a href="http://bugs.python.org/issue1236" target="new">thread-safe</a> so I decided to see how SCons did it. And wouldn't you know, they came to a <a href="http://scons.tigris.org/source/browse/scons/trunk/src/engine/SCons/Tool/MSCommon/common.py?revision=4958&amp;view=markup" target="new">similar conclusion themselves</a>:<br><br><div class="code"><br>&nbsp;&nbsp;&nbsp;&nbsp;# Use the .stdout and .stderr attributes directly because the<br>&nbsp;&nbsp;&nbsp;&nbsp;# .communicate() method uses the threading module on Windows<br>&nbsp;&nbsp;&nbsp;&nbsp;# and won't work under Pythons not built with threading.<br>&nbsp;&nbsp;&nbsp;&nbsp;stdout = popen.stdout.read()<br>&nbsp;&nbsp;&nbsp;&nbsp;stderr = popen.stderr.read()<br></div><br>In
 short: subprocess is flaky by Python standards. Very flaky. I lost 
around 3 hours to this bug when the entire build system took me around 
20 hours to create - that's a huge time sink. It would be interesting to
 replicate this in C++ to see if there are similar issues with "cmd /c 
set".<br><br><h4>The future</h4><br>I'll be releasing the source code to
 PiB in the next few days for others to browse and scrutinise - I just 
have to work out an appropriate license, first. Meanwhile, there are a 
few big todos I may address in the future:<ul><li> What's the 
performance impact of pickling all the metadata? Lots of people mention 
that cPickle is an optimised C implementation which is better than the 
standard pickle module.</li><li> Instead of using input/output files, 
use abstracted nodes - I'm not sure how necessary this will be but I may
 need build steps that don't use the file system (something I recall 
SCons being bad at - but that's a very old experience).</li><li> Cache 
explicit dependencies and track the Windows USN Journal for absolute 
minimal file system interaction and very fast iterative building.</li><li> I need to write some functional tests for all this before I start modifying it some more!</li></ul>At the moment they're not important and we'll see how much "evolution" contributes to their need.<br><br><h4>Final thoughts</h4><br>So
 the last few days have been immensely productive and I'm pretty 
excited. I've been learning all kinds of new stuff and will get to work 
some more with Java and Javascript starting tomorrow. I've come up with a
 really good way of getting Reflection from C++ code that "might 
actually work" very elegantly but we'll see next week when I have the 
time allocated to write it all up.<br><br>The most important outcome of 
all this is that PiB can be considered a "small victory" for me - a 
nice, self-contained project that has been completed in good time. If I 
can chunk up my work enough to get more small victories, there should be
 some good times ahead :)<br><br><a href="http://localhost/b/?d=2011-06-28-17-04-00#disqus_thread" data-disqus-identifier="2011-06-28-17-04-00">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20110614152356"><a href="javascript:blog_goto('2011-06-14-15-23-56')" class="title">The Gubberment and the new PC</a><br><span class="date">Posted 14 June 2011 15:23:56</span><br><br>I
 move into the office next Monday - meanwhile I've been keeping myself 
busy trawling through government websites on the requirements of being 
self-employed. As a result; I'm going to contact an accountant as soon 
as possible! There's some very basic stuff I need to do on my own, such 
as register as self-employed for NI contributions, however I've heard 
that the HMRC are pretty brutal about all this. So I need some 
professional advice before I do anything :) Top of my list is VAT 
reclaiming and contributions!<br><br>My new desk has arrived; I'll be setting that up in the new office tomorrow morning. I've also designed and ordered my new PC.<br><br>I
 took a few hours figuring out what parts I wanted to stick together and
 came to the conclusion that beyond a couple of key decisions, I 
shouldn't be going through the design in painful detail as my own time 
is worth a lot more than the gains. This is especially true when it 
comes to assembling it. It seems these days I can custom design and get a
 3rd party to build it for me. Costs an extra 100 pounds or so but 
compared to my time building it and the reduced shipping costs, that 
seems to be a big net gain overall! And I'm still beating the cost of a 
pre-designed mass-market PC...<br><br>My main concerns were CPU, RAM and
 Storage for fast iteration development. I was looking at all the Quad 
core i7's and Xeons (for their nice big shared cache) and ditched them 
for the i5-2500k due to some great performance benchmarks vs. cost. As 
most software out there really is pretty poor at taking advantage of the
 multiple cores in your machine, the difference between the i7's and 
Xeons rarely show up unless you're prepared to spend some serious cash 
(in some cases buying an i7 will net you worse performance).<br><br>Going
 with 16GB of RAM (DDR3 @ 1333MHz) was a no-brainer until I started 
looking at using SSD's for my main storage. There's lots of anecdotal 
evidence out there that SSDs can increase your compile/link iteration if
 any of those stages are I/O bound. On my last three "AAA" projects, the
 linker was the ultimate killer of iteration times on the Xbox 360 but 
the CPUs were always relatively idle for the 2-5 minute link times you'd
 get - it was all disk work!<br><br>However, I'm not in that mode, and 
I've shown in the past that such large projects don't need to have it 
that bad (when I left SC:V, our compile/link times for the main renderer
 could be measured in 20-30 seconds, with 1-2 second iteration times). 
With 10s of programmers who are constantly chasing features, bugs and 
all manner of changes, keeping on top of your compile and link times has
 never, in my experience, been something that senior management will let
 you concentrate on. You end up with hundreds of .cpp files with one 
class per .cpp/.h, all of which include every file in the project and 
exhibit no clear rules of dependency - a perfect environment to breed 
I/O hell even before you hit the link stage when all of that can really 
be avoided.<br><br>Anyway, I'm digressing. I'll be working on a much smaller code-base and the issue won't be as pronounced but it was <a href="http://www.joelonsoftware.com/items/2009/03/27.html" target="new">this</a>
 post by Joel Spolsky that sold SSDs to me. No compile-time 
improvements, but a drastic improvement in the performance of your 
development software and boot times - now that's what I'm talking about!
 So after a bit of research, I decided to get two drives: one OCZ Vertex
 3 120GB (despite the slower random read/write times than the 240GB 
model) for the main drive and an OCZ Vertex 2 60GB for the development 
drive. To save a little money, I then cut my RAM from 16GB to 8GB, 
hoping that the 120GB SSD investment will allow me to do this.<br><br>Phew!
 Everything else is a largely irrelevant decision (except for avoiding 
Intel video cards like the plague - I have a separate Linux installation
 on my laptop specifically for playing Minecraft because the Intel 
OpenGL on Windows drivers are shamefully poor).<br><br><a href="http://localhost/b/?d=2011-06-14-15-23-56#disqus_thread" data-disqus-identifier="2011-06-14-15-23-56">0 Comments</a></div></div><div><div style="opacity: 1;" class="post" id="Post20110609235557"><a href="javascript:blog_goto('2011-06-09-23-55-57')" class="title">Office Space +1</a><br><span class="date">Posted 09 June 2011 23:55:57</span><br> <br>Today
 I managed to get some office space locked down! It's right in the 
middle of Brighton Laines above a book shop - I have a single room and 
share the building with several other small businesses (including the 
guy who invented and patented high-heel straps!). The great thing is 
that it's right in the middle of all the activity in Brighton and is 
only a couple minutes walk from the sea front. It's also about a 15 
minute cycle from home which is absolutely perfect.<br><br>While 
browsing ebay I also managed to net a really cheap corner desk - I'm 
going to use one of the two office chairs we already have at home so 
won't have to spend any more money. The next most expensive investment 
is a development PC and test server. I'm not sure yet whether buying off
 the shelf or building my own will give me the best savings. My hunch is
 that for the lower end it'd actually be more expensive to build my own 
given that all the big companies (Dell, Toshiba, etc.) buy parts in 
bulk. I'll be investigating next week when I've managed to get our 
garden back into a manageable state :)<br><br><a href="http://localhost/b/?d=2011-06-09-23-55-57#disqus_thread" data-disqus-identifier="2011-06-09-23-55-57">0 Comments</a></div></div><div><div class="post" id="Post20110606202057"></div></div></div>
		<div id="info"><div><div style="opacity: 1;" class="post" id="PostSocialNetworks">
<div style="position:relative; top:-28px">
<a href="http://localhost/b/rss.xml"><img src="" style="width:20px;"></a>
<a href="http://twitter.com/#%21/Donzanoid" target="_blank"><img src="" style="width:20px"></a>
<a href="http://donw.org/+" target="_blank"><img src="" style="width:20px"></a>
<a href="https://bitbucket.org/dwilliamson" target="_blank"><img src="" style="width:20px"></a>
<a href="https://github.com/dwilliamson" target="_blank"><img src="" style="width:20px"></a>
<a href="http://uk.linkedin.com/pub/don-williamson/1/791/412" target="_blank"><img src="" style="width:20px"></a>
<a href="http://www.facebook.com/d.d.williamson" target="_blank"><img src="" style="width:20px"></a>
<a href="http://soundcloud.com/d-d-williamson" target="_blank"><img src="" style="width:20px"></a>
</div><div style="font-size:8pt; line-height:1.3em;"><b>BitBucket</b><br><a href="https://bitbucket.org/dwilliamson/clreflect" target="new">clReflect</a> - C++ Reflection using Clang<br><a href="https://bitbucket.org/dwilliamson/shrotation" target="new">SHRotation</a> - Spherical Harmonic rotation<br><a href="https://bitbucket.org/dwilliamson/tahiti-game-language" target="new">Tahiti</a> - Game programming language<br><a href="https://bitbucket.org/dwilliamson/pib" target="new">PiB</a> - Python-based build system<br><a href="https://bitbucket.org/dwilliamson/reflectabit" target="new">Reflectabit</a> - C++ Reflection using templates<br><a href="https://bitbucket.org/dwilliamson/rfl" target="new">Rfl</a> - C++ Reflection using PDB files<br><a href="https://bitbucket.org/dwilliamson/tiny-blog" target="new">Tiny Blog</a> - Client-side Javascript blog engine<br><a href="https://bitbucket.org/dwilliamson/assemblervm" target="new">AssemblerVM</a> - Assembler &amp; Virtual Machine<br><br> <b>Github</b><br><a href="https://github.com/dwilliamson/dcpu16.js" target="new">dcpu16.js</a> - DCPU-16 Assembler &amp; Emulator<br><a href="https://github.com/dwilliamson/dwilliamson.github.com" target="new">DCPU-16</a> - DCPU-16 browser live-edit<br><a href="https://github.com/dwilliamson/b" target="new">Gazoo.cpp</a> - Repository for blog content<br><br></div></div></div><div><div style="opacity: 1;" class="post" id="PostLatestPosts"><div style="font-size:8pt; line-height:1.3em;"><b>LatestPosts</b><br><a href="javascript:blog_goto('2012-12-17-11-38-22')">Very Fast, High-Precision SIMD/GPU Gradient Noise</a><br><a href="javascript:blog_goto('2012-12-12-19-20-54')">Star: Planets, Smooth Voxels and Runtime C++ Reloading</a><br><a href="javascript:blog_goto('2012-12-06-10-34-03')">Star: Distance Fields to Voxels to Polygons</a><br><a href="javascript:blog_goto('2012-11-30-12-30-01')">Star: Record/Playback and a New Window Manager</a><br><a href="javascript:blog_goto('2012-11-22-13-08-40')">Star: Native Browser Games &amp; Tools with clReflect</a><br><a href="javascript:blog_goto('2012-11-15-12-43-24')">Star: Scale, Physics and Shading</a><br><a href="javascript:blog_goto('2012-11-07-17-10-02')">Announcing: Project Star</a><br><a href="javascript:blog_goto('2012-08-20-16-07-23')">Skeletal Animation Looping with Autocorrelation</a><br><a href="javascript:blog_goto('2012-08-02-18-01-22')">Smoother Assert Response with Visual Studio</a><br><a href="javascript:blog_goto('2012-07-27-12-42-30')">Getting Google to Index AJAX Content</a><br><a href="javascript:blog_goto('2012-07-19-12-52-03')">Quaternions and Dual Quaternion Skinning</a><br><a href="javascript:blog_goto('2012-05-15-10-36-23')">An Implementation of _CIpow</a><br><a href="javascript:blog_goto('2012-04-11-22-56-23')">Risk, Prototypes and Planetary Bodies</a><br><a href="javascript:blog_goto('2012-03-08-13-00-00')">Cross-browser, Native/Remote D3D Rendering with C++</a><br><a href="javascript:blog_goto('2012-02-07-11-37-23')">An RPC Debugging Workflow with Visual Studio</a> </div></div></div><div><div style="opacity: 1;" class="post" id="generated"><div style="font-size:8pt; line-height:1.3em;"><b>Archives</b><br><a href="javascript:blog_goto('2012-12')">December, 2012 (3)</a><br><a href="javascript:blog_goto('2012-11')">November, 2012 (4)</a><br><a href="javascript:blog_goto('2012-08')">August, 2012 (2)</a><br><a href="javascript:blog_goto('2012-07')">July, 2012 (2)</a><br><a href="javascript:blog_goto('2012-05')">May, 2012 (1)</a><br><a href="javascript:blog_goto('2012-04')">April, 2012 (1)</a><br><a href="javascript:blog_goto('2012-03')">March, 2012 (1)</a><br><a href="javascript:blog_goto('2012-02')">February, 2012 (1)</a><br><a href="javascript:blog_goto('2012-01')">January, 2012 (1)</a><br><a href="javascript:blog_goto('2011-12')">December, 2011 (1)</a><br><a href="javascript:blog_goto('2011-11')">November, 2011 (1)</a><br><a href="javascript:blog_goto('2011-09')">September, 2011 (1)</a><br><a href="javascript:blog_goto('2011-08')">August, 2011 (2)</a><br><a href="javascript:blog_goto('2011-07')">July, 2011 (2)</a><br><a href="javascript:blog_goto('2011-06')">June, 2011 (4)</a><br> </div></div></div><div><div style="opacity: 1;" class="post" id="PostLinks"><div style="font-size:8pt; line-height:1.3em;"><b>Links</b><br><a href="http://c0de517e.blogspot.com/" target="new">Angelo Pesce</a><br><a href="http://aras-p.info/blog/" target="new">Aras Pranckevicius</a><br><a href="http://bartoszmilewski.wordpress.com/" target="new">Bartosz Milewski</a><br><a href="http://chadaustin.me/" target="new">Chad Austin</a><br><a href="http://realtimecollisiondetection.net/blog/" target="new">Christer Ericson</a><br><a href="http://blog.corensic.com/" target="new">Corensic</a><br><a href="http://blog.sigfpe.com/" target="new">Dan Piponi</a><br><a href="http://debugmo.de/" target="new">debugmode</a><br><a href="http://blogs.msdn.com/b/ericlippert/" target="new">Eric Lippert</a><br><a href="http://gafferongames.com/" target="new">Glenn Fiedler</a><br><a href="http://herbsutter.com/" target="new">Herb Sutter</a><br><a href="http://www.jshopf.com/blog/" target="new">Jeremy Shopf</a><br><a href="http://repi.blogspot.com/" target="new">Johan Andersson</a><br><a href="http://graphicsrunner.blogspot.co.uk/" target="new">Kyle Hayward</a><br><a href="http://lambda-the-ultimate.org/" target="new">Lambda the Ultimate</a><br><a href="http://msinilo.pl/blog" target="new">Maciej Sinilo</a><br><a href="http://pixelstoomany.wordpress.com/" target="new">Marco Salvi</a><br><a href="http://renderwonk.com/blog/" target="new">Naty Hoffman</a><br><a href="http://animationphysics.wordpress.com/" target="new">Physics Animation</a><br><a href="http://www.realtimerendering.com/blog" target="new">Real-Time Rendering</a><br><a href="http://copypastepixel.blogspot.com/" target="new">Stefan Kamoda</a><br><a href="http://blog.selfshadow.com/" target="new">Steve Hill</a><br><a href="http://farrarfocus.blogspot.com/" target="new">Timothy Farrar</a> / <a href="http://timothylottes.blogspot.com/" target="new">Lottes</a><br><a href="http://home.comcast.net/%7Etom_forsyth/blog.wiki.html" target="new">Tom Forsyth</a> </div></div></div></div>

		
		<script language="javascript">
		
			function blog_goto(where)
			{
			}

		</script>

<div><div id="image_background"></div></div><div><div id="image_foreground"></div></div><div><img id="image_display"></div></body></html>